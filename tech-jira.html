<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Board</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            "50": "#eff6ff",
                            "100": "#dbeafe",
                            "200": "#bfdbfe",
                            "300": "#93c5fd",
                            "400": "#60a5fa",
                            "500": "#3b82f6",
                            "600": "#2563eb",
                            "700": "#1d4ed8",
                            "800": "#1e40af",
                            "900": "#1e3a8a",
                            "950": "#172554"
                        }
                    }
                }
            }
        }
    </script>
    <!-- Drag and Drop Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <style>
        .task-card.dragging {
            opacity: 0.5;
        }

        .task-list {
            min-height: 200px;
            display: flex;
            flex-direction: column;
        }

        .task-list:empty {
            min-height: 200px;
        }

        .view-kanban {
            display: none;
        }

        .view-table {
            display: none;
        }

        /* Add transition for view switching */
        [x-show] {
            transition: opacity 0.3s ease-in-out;
        }

        [x-show].opacity-0 {
            opacity: 0;
        }

        [x-show].opacity-100 {
            opacity: 1;
        }

        /* Notification styles */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .notification.success {
            background-color: #10B981;
        }

        .notification.error {
            background-color: #EF4444;
        }

        .notification.info {
            background-color: #3B82F6;
        }

        /* Add border to three dots menu dropdown */
        .task-menu-dropdown {
            border: 1px solid #e5e7eb;
            /* Tailwind's border-gray-200 */
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* FullCalendar styles */
        .fc-header-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .fc-toolbar-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }
    </style>
</head>

<body class="bg-gray-100">
    <div class="p-4">
        <div class="rounded-2xl border border-gray-200 bg-white">
            <div class="px-5 py-4 sm:px-6 sm:py-5">
                <h3 class="!!text-2xl font-medium text-gray-800">
                    Task Management
                </h3>
            </div>
            <div class="border-t border-gray-100 p-5 sm:p-6">
                <!-- Search and Filter Section -->
                <div class="mb-6 flex flex-col gap-4">
                    <div class="flex flex-1 items-center gap-4">
                        <div class="w-[512px]">
                            <div class="relative">
                                <span class="pointer-events-none absolute top-1/2 left-4 -translate-y-1/2">
                                    <svg class="fill-gray-500" width="20" height="20" viewBox="0 0 20 20" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" clip-rule="evenodd"
                                            d="M3.04199 9.37381C3.04199 5.87712 5.87735 3.04218 9.37533 3.04218C12.8733 3.04218 15.7087 5.87712 15.7087 9.37381C15.7087 12.8705 12.8733 15.7055 9.37533 15.7055C5.87735 15.7055 3.04199 12.8705 3.04199 9.37381ZM9.37533 1.54218C5.04926 1.54218 1.54199 5.04835 1.54199 9.37381C1.54199 13.6993 5.04926 17.2055 9.37533 17.2055C11.2676 17.2055 13.0032 16.5346 14.3572 15.4178L17.1773 18.2381C17.4702 18.531 17.945 18.5311 18.2379 18.2382C18.5308 17.9453 18.5309 17.4704 18.238 17.1775L15.4182 14.3575C16.5367 13.0035 17.2087 11.2671 17.2087 9.37381C17.2087 5.04835 13.7014 1.54218 9.37533 1.54218Z"
                                            fill=""></path>
                                    </svg>
                                </span>
                                <input type="text" id="searchInput" placeholder="Search tasks..."
                                    class="shadow-theme-xs focus:border-brand-300 focus:ring-brand-500/10 h-[42px] w-full rounded-lg border border-gray-300 bg-transparent py-2.5 pr-4 pl-[42px] !text-md text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden">
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <!-- Action Buttons -->
                            <button type="button" id="export-excel"
                                class="flex items-center gap-2 rounded-lg bg-blue-500 px-4 py-2 !text-md font-medium text-white hover:bg-blue-600">
                                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Export
                            </button>
                            <button type="button" id="refresh-data"
                                class="flex items-center gap-2 rounded-lg bg-blue-500 px-4 py-2 !text-md font-medium text-white hover:bg-blue-600">
                                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                Refresh
                            </button>
                        </div>
                    </div>

                    <!-- View Switching Slider -->
                    <div class="rounded-xl border border-gray-200 p-6" x-data="{ activeView: 'kanban' }" x-init="$watch('activeView', async (value) => { 
                        console.log('View changed to:', value); 
                        if (value === 'metrics') { 
                            console.log('Switching to metrics view, updating charts...');
                            // Add longer delay and ensure DOM is ready for chart rendering
                            setTimeout(async () => {
                                try {
                                    // Ensure chart containers are visible before rendering
                                    const statusChart = document.getElementById('statusChart');
                                    const priorityChart = document.getElementById('priorityChart');
                                    
                                    if (statusChart && priorityChart) {
                                        console.log('Chart containers found, proceeding with metrics update');
                                    await updateMetrics(false); // Pass false to prevent double notifications
                                    } else {
                                        console.warn('Chart containers not found, retrying...');
                                        setTimeout(() => updateMetrics(false), 500);
                                    }
                                } catch (error) {
                                    console.error('Error updating metrics:', error);
                                }
                            }, 500); // Increased delay to ensure DOM transition is complete
                        } else if (value === 'calendar') { 
                            setTimeout(() => updateCalendar(), 200); 
                        }
                    })">
                        <div class="border-b border-gray-200">
                            <nav
                                class="-mb-px flex space-x-2 overflow-x-auto [&::-webkit-scrollbar-thumb]:rounded-full [&::-webkit-scrollbar-thumb]:bg-gray-200 [&::-webkit-scrollbar]:h-1.5">
                                <button
                                    class="inline-flex items-center gap-2 border-b-2 px-2.5 py-2 !text-md font-medium transition-colors duration-200 ease-in-out"
                                    :class="activeView === 'kanban' ? 'text-blue-500 border-blue-500' : 'text-gray-500 border-transparent hover:text-gray-700'"
                                    @click="activeView = 'kanban'" onclick="switchView('kanban')">
                                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                                    </svg>
                                    Kanban
                                </button>
                                <button
                                    class="inline-flex items-center gap-2 border-b-2 px-2.5 py-2 !text-md font-medium transition-colors duration-200 ease-in-out"
                                    :class="activeView === 'table' ? 'text-blue-500 border-blue-500' : 'text-gray-500 border-transparent hover:text-gray-700'"
                                    @click="activeView = 'table'" onclick="switchView('table')">
                                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                    Table
                                </button>
                                <button
                                    class="inline-flex items-center gap-2 border-b-2 px-2.5 py-2 !text-md font-medium transition-colors duration-200 ease-in-out"
                                    :class="activeView === 'metrics' ? 'text-blue-500 border-blue-500' : 'text-gray-500 border-transparent hover:text-gray-700'"
                                    @click="activeView = 'metrics'" onclick="switchView('metrics')">
                                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                    </svg>
                                    Metrics
                                </button>
                                <button
                                    class="inline-flex items-center gap-2 border-b-2 px-2.5 py-2 !text-md font-medium transition-colors duration-200 ease-in-out"
                                    :class="activeView === 'calendar' ? 'text-blue-500 border-blue-500' : 'text-gray-500 border-transparent hover:text-gray-700'"
                                    @click="activeView = 'calendar'" onclick="switchView('calendar')">
                                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                    </svg>
                                    Calendar
                                </button>
                            </nav>
                        </div>

                        <div class="pt-4">
                            <!-- Kanban View -->
                            <div x-show="activeView === 'kanban'" class="bg-white min-h-screen">
                                <div class="flex gap-6 overflow-x-auto pb-4 pt-4" ondrop="drop(event)"
                                    ondragover="allowDrop(event)">

                                    <!-- Todo Column -->
                                    <div class="bg-gray-50 rounded-lg flex-1 min-h-[600px]">
                                        <div class="p-4 flex justify-between items-center border-b border-gray-200">
                                            <h2 class="font-medium text-gray-700 !text-md flex items-center">
                                                <span class="w-2 h-2 bg-gray-500 rounded-full mr-2"></span>
                                                Unassigned
                                                <span
                                                    class="ml-2 bg-gray-200 text-gray-600 !text-md font-medium px-1.5 py-0.5 rounded task-counter">0</span>
                                            </h2>
                                            <button id="add-unassigned"
                                                class="flex items-center justify-center text-gray-400 bg-white hover:text-gray-600 hover:bg-gray-200 rounded p-1 transition-colors duration-200">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="px-4 pb-4 pt-5 task-list" id="unassigned-column">
                                            <!-- Task cards here -->
                                        </div>
                                    </div>

                                    <!-- Submitted Column -->
                                    <div class="bg-gray-50 rounded-lg flex-1 min-h-[600px]">
                                        <div class="p-4 flex justify-between items-center border-b border-gray-200">
                                            <h2 class="font-medium text-gray-700 !text-md flex items-center">
                                                <span class="w-2 h-2 bg-yellow-500 rounded-full mr-2"></span>
                                                Submitted
                                                <span
                                                    class="ml-2 bg-gray-200 text-gray-600 !text-md font-medium px-1.5 py-0.5 rounded task-counter">0</span>
                                            </h2>
                                            <button id="add-submitted"
                                                class="flex items-center justify-center text-gray-400 bg-white hover:text-gray-600 hover:bg-gray-200 rounded p-1 transition-colors duration-200">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="px-4 pb-4 pt-5 task-list" id="submitted-column">
                                            <!-- Task cards here -->
                                        </div>
                                    </div>

                                    <!-- In Progress Column -->
                                    <div class="bg-gray-50 rounded-lg flex-1 min-h-[600px]">
                                        <div class="p-4 flex justify-between items-center border-b border-gray-200">
                                            <h2 class="font-medium text-gray-700 !text-md flex items-center">
                                                <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                                                In Progress
                                                <span
                                                    class="ml-2 bg-gray-200 text-gray-600 !text-md font-medium px-1.5 py-0.5 rounded task-counter">0</span>
                                            </h2>
                                            <button id="add-progress"
                                                class="flex items-center justify-center text-gray-400 bg-white hover:text-gray-600 hover:bg-gray-200 rounded p-1 transition-colors duration-200">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="px-4 pb-4 pt-5 task-list" id="progress-column">
                                            <!-- Task cards here -->
                                        </div>
                                    </div>

                                    <!-- Done Column -->
                                    <div class="bg-gray-50 rounded-lg flex-1 min-h-[600px]">
                                        <div class="p-4 flex justify-between items-center border-b border-gray-200">
                                            <h2 class="font-medium text-gray-700 !text-md flex items-center">
                                                <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                                                Done
                                                <span
                                                    class="ml-2 bg-gray-200 text-gray-600 !text-md font-medium px-1.5 py-0.5 rounded task-counter">0</span>
                                            </h2>
                                            <button id="add-done"
                                                class="flex items-center justify-center text-gray-400 bg-white hover:text-gray-600 hover:bg-gray-200 rounded p-1 transition-colors duration-200">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="px-4 pb-4 pt-5 task-list" id="done-column">
                                            <!-- Task cards here -->
                                        </div>
                                    </div>

                                    <!-- To Submit Column -->
                                    <div class="bg-gray-50 rounded-lg flex-1 min-h-[600px]">
                                        <div class="p-4 flex justify-between items-center border-b border-gray-200">
                                            <h2 class="font-medium text-gray-700 !text-md flex items-center">
                                                <span class="w-2 h-2 bg-purple-500 rounded-full mr-2"></span>
                                                To Submit
                                                <span
                                                    class="ml-2 bg-gray-200 text-gray-600 !text-md font-medium px-1.5 py-0.5 rounded task-counter">0</span>
                                            </h2>
                                            <button id="add-tosubmit"
                                                class="flex items-center justify-center text-gray-400 bg-white hover:text-gray-600 hover:bg-gray-200 rounded p-1 transition-colors duration-200">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor"
                                                    viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round"
                                                        stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="px-4 pb-4 pt-5 task-list" id="tosubmit-column">
                                            <!-- Task cards here -->
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Table View -->
                            <div x-show="activeView === 'table'" x-transition:enter="transition ease-out duration-300"
                                x-transition:enter-start="opacity-0 transform scale-95"
                                x-transition:enter-end="opacity-100 transform scale-100"
                                x-transition:leave="transition ease-in duration-200"
                                x-transition:leave-start="opacity-100 transform scale-100"
                                x-transition:leave-end="opacity-0 transform scale-95">
                                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th scope="col"
                                                    class="px-6 py-3 text-left !text-md font-medium text-gray-500 tracking-wider whitespace-nowrap">
                                                    Ticket Number</th>
                                                <th scope="col"
                                                    class="px-6 py-3 text-left !text-md font-medium text-gray-500 tracking-wider whitespace-nowrap">
                                                    Issue Description</th>
                                                <th scope="col"
                                                    class="px-6 py-3 text-left !text-md font-medium text-gray-500 tracking-wider whitespace-nowrap">
                                                    Ticket Type</th>
                                                <th scope="col"
                                                    class="px-6 py-3 text-left !text-md font-medium text-gray-500 tracking-wider whitespace-nowrap">
                                                    Priority</th>
                                                <th scope="col"
                                                    class="px-6 py-3 text-left !text-md font-medium text-gray-500 tracking-wider whitespace-nowrap">
                                                    Status</th>
                                                <th scope="col"
                                                    class="px-6 py-3 text-left !text-md font-medium text-gray-500 tracking-wider whitespace-nowrap">
                                                    Assigned To</th>
                                                <th scope="col"
                                                    class="px-6 py-3 text-left !text-md font-medium text-gray-500 tracking-wider whitespace-nowrap">
                                                    Team in Charge</th>
                                                <th scope="col"
                                                    class="px-6 py-3 text-left !text-md font-medium text-gray-500 tracking-wider whitespace-nowrap">
                                                    Days Pending</th>
                                                <th scope="col"
                                                    class="px-6 py-3 text-left !text-md font-medium text-gray-500 tracking-wider whitespace-nowrap">
                                                    Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                                            <!-- Table rows will be dynamically added here -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>

                            <!-- Metrics View -->
                            <div x-show="activeView === 'metrics'" x-transition:enter="transition ease-out duration-300"
                                x-transition:enter-start="opacity-0 transform scale-95"
                                x-transition:enter-end="opacity-100 transform scale-100"
                                x-transition:leave="transition ease-in duration-200"
                                x-transition:leave-start="opacity-100 transform scale-100"
                                x-transition:leave-end="opacity-0 transform scale-95">

                                <!-- Metrics Dashboard -->
                                <div class="space-y-6">
                                    <!-- Summary Cards -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0">
                                                    <div
                                                        class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                                                        <svg class="w-7 h-7 text-white" fill="none"
                                                            stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                                stroke-width="2"
                                                                d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2">
                                                            </path>
                                                        </svg>
                                                    </div>
                                                </div>
                                                <div class="ml-5 w-0 flex-1">
                                                    <dl>
                                                        <dt class="!text-md font-medium text-gray-500 truncate">Total
                                                            Tasks</dt>
                                                        <dd class="!text-md font-medium text-gray-900"
                                                            id="total-tasks-metric">0</dd>
                                                    </dl>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0">
                                                    <div
                                                        class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center">
                                                        <svg class="w-7 h-7 text-white" fill="none"
                                                            stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                                stroke-width="2"
                                                                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z">
                                                            </path>
                                                        </svg>
                                                    </div>
                                                </div>
                                                <div class="ml-5 w-0 flex-1">
                                                    <dl>
                                                        <dt class="!text-md font-medium text-gray-500 truncate">
                                                            Completed</dt>
                                                        <dd class="!text-md font-medium text-gray-900"
                                                            id="completed-tasks-metric">0</dd>
                                                    </dl>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0">
                                                    <div
                                                        class="w-8 h-8 bg-yellow-500 rounded-lg flex items-center justify-center">
                                                        <svg class="w-7 h-7 text-white" fill="none"
                                                            stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                                stroke-width="2"
                                                                d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                        </svg>
                                                    </div>
                                                </div>
                                                <div class="ml-5 w-0 flex-1">
                                                    <dl>
                                                        <dt class="!text-md font-medium text-gray-500 truncate">In
                                                            Progress</dt>
                                                        <dd class="!text-md font-medium text-gray-900"
                                                            id="progress-tasks-metric">0</dd>
                                                    </dl>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0">
                                                    <div
                                                        class="w-8 h-8 bg-red-500 rounded-lg flex items-center justify-center">
                                                        <svg class="w-7 h-7 text-white" fill="none"
                                                            stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                                stroke-width="2"
                                                                d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z">
                                                            </path>
                                                        </svg>
                                                    </div>
                                                </div>
                                                <div class="ml-5 w-0 flex-1">
                                                    <dl>
                                                        <dt class="!text-md font-medium text-gray-500 truncate">Overdue
                                                        </dt>
                                                        <dd class="!text-md font-medium text-gray-900"
                                                            id="overdue-tasks-metric">0</dd>
                                                    </dl>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Charts Row 1 -->
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <!-- Task Status Distribution -->
                                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                                            <h3 class="!text-md font-medium text-gray-900 mb-4">Task Status Distribution
                                            </h3>
                                            <div id="statusChart"></div>
                                        </div>

                                        <!-- Priority Distribution -->
                                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                                            <h3 class="!text-md font-medium text-gray-900 mb-4">Priority Distribution
                                            </h3>
                                            <div id="priorityChart"></div>
                                        </div>
                                    </div>

                                    <!-- Removed Charts Row 2 (Task Type Distribution, Assignee Workload) and Row 3 (Timeline) - replaced with table below -->
                                    <!-- Timeline chart section removed to simplify metrics view -->

                                    <!-- Task Details Table -->
                                    <div class="grid grid-cols-1 gap-6">
                                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                                            <h3 class="text-l font-medium text-gray-900 mb-4">ðŸš¨ Top 10 Overdue Tickets
                                                (30+ Days Pending)</h3>
                                            <div class="overflow-x-auto">
                                                <table class="min-w-full divide-y divide-gray-200" id="metrics-table">
                                                    <thead class="bg-gray-50">
                                                        <tr>
                                                            <th scope="col"
                                                                class="px-6 py-3 text-left !text-md font-medium text-gray-500 tracking-wider">
                                                                Ticket Number</th>
                                                            <th scope="col"
                                                                class="px-6 py-3 text-left !text-md font-medium text-gray-500 tracking-wider">
                                                                Assigned To</th>
                                                            <th scope="col"
                                                                class="px-6 py-3 text-center !text-md font-medium text-gray-500 tracking-wider">
                                                                Priority</th>
                                                            <th scope="col"
                                                                class="px-6 py-3 text-center !text-md font-medium text-gray-500 tracking-wider">
                                                                Status</th>
                                                            <th scope="col"
                                                                class="px-6 py-3 text-center !text-md font-medium text-gray-500 tracking-wider">
                                                                Ticket Type</th>
                                                            <th scope="col"
                                                                class="px-6 py-3 text-center !text-md font-medium text-gray-500 tracking-wider">
                                                                Team</th>
                                                            <th scope="col"
                                                                class="px-6 py-3 text-center !text-md font-medium text-gray-500 tracking-wider">
                                                                Days Pending</th>
                                                            <th scope="col"
                                                                class="px-6 py-3 text-center !text-md font-medium text-gray-500 tracking-wider">
                                                                Submission Date</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="metrics-table-body"
                                                        class="bg-white divide-y divide-gray-200">
                                                        <!-- Table rows will be populated by JavaScript -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Calendar View -->
                            <div x-show="activeView === 'calendar'"
                                x-transition:enter="transition ease-out duration-300"
                                x-transition:enter-start="opacity-0 transform scale-95"
                                x-transition:enter-end="opacity-100 transform scale-100"
                                x-transition:leave="transition ease-in duration-200"
                                x-transition:leave-start="opacity-100 transform scale-100"
                                x-transition:leave-end="opacity-0 transform scale-95">

                                <!-- Calendar Header -->
                                <div class="bg-white rounded-lg border border-gray-200 shadow-sm mb-6">
                                    <!-- Navigation and View Controls Row -->
                                    <div
                                        class="fc-header-toolbar fc-toolbar fc-toolbar-ltr p-4 flex flex-wrap items-center justify-between gap-4">
                                        <!-- Navigation Controls -->
                                        <div class="flex items-center gap-2">
                                            <button type="button" title="Previous month" aria-pressed="false"
                                                id="calendar-prev-btn"
                                                class="!text-md shadow-sm flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-2 py-2 font-medium text-gray-700 hover:bg-gray-50 hover:text-gray-800 sm:px-3.5">
                                                <svg class="fill-current" width="20" height="20" viewBox="0 0 20 20"
                                                    fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path fill-rule="evenodd" clip-rule="evenodd"
                                                        d="M2.58301 9.99868C2.58272 10.1909 2.65588 10.3833 2.80249 10.53L7.79915 15.5301C8.09194 15.8231 8.56682 15.8233 8.85981 15.5305C9.15281 15.2377 9.15297 14.7629 8.86018 14.4699L5.14009 10.7472L16.6675 10.7472C17.0817 10.7472 17.4175 10.4114 17.4175 9.99715C17.4175 9.58294 17.0817 9.24715 16.6675 9.24715L5.14554 9.24715L8.86017 5.53016C9.15297 5.23717 9.15282 4.7623 8.85983 4.4695C8.56684 4.1767 8.09197 4.17685 7.79917 4.46984L2.84167 9.43049C2.68321 9.568 2.58301 9.77087 2.58301 9.99715C2.58301 9.99766 2.58301 9.99817 2.58301 9.99868Z"
                                                        fill=""></path>
                                                </svg>
                                                <span class="hidden sm:inline">Previous</span>
                                            </button>
                                            <button type="button" title="Next month" aria-pressed="false"
                                                id="calendar-next-btn"
                                                class="!text-md shadow-sm flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-2 py-2 font-medium text-gray-700 hover:bg-gray-50 hover:text-gray-800 sm:px-3.5">
                                                <span class="hidden sm:inline">Next</span>
                                                <svg class="fill-current" width="20" height="20" viewBox="0 0 20 20"
                                                    fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path fill-rule="evenodd" clip-rule="evenodd"
                                                        d="M17.4175 9.9986C17.4178 10.1909 17.3446 10.3832 17.198 10.53L12.2013 15.5301C11.9085 15.8231 11.4337 15.8233 11.1407 15.5305C10.8477 15.2377 10.8475 14.7629 11.1403 14.4699L14.8604 10.7472L3.33301 10.7472C2.91879 10.7472 2.58301 10.4114 2.58301 9.99715C2.58301 9.58294 2.91879 9.24715 3.33301 9.24715L14.8549 9.24715L11.1403 5.53016C10.8475 5.23717 10.8477 4.7623 11.1407 4.4695C11.4336 4.1767 11.9085 4.17685 12.2013 4.46984L17.1588 9.43049C17.3173 9.568 17.4175 9.77087 17.4175 9.99715C17.4175 9.99763 17.4175 9.99812 17.4175 9.9986Z"
                                                        fill=""></path>
                                                </svg>
                                            </button>
                                        </div>

                                        <!-- Month/Year Title -->
                                        <div class="flex-1 text-center">
                                            <h2 class="fc-toolbar-title text-xl font-semibold text-gray-900"
                                                id="calendar-month-year">May 2025</h2>
                                        </div>

                                        <!-- View Controls -->
                                        <div x-data="{ activeTab: 'month' }">
                                            <div class="rounded-lg bg-gray-100 p-1">
                                                <nav class="flex">
                                                    <button
                                                        class="inline-flex items-center rounded-md px-3 py-2 !text-md font-medium transition-colors duration-200 ease-in-out"
                                                        x-bind:class="activeTab === 'month' ? 'bg-white text-gray-900 shadow-xs' : 'bg-transparent text-gray-500 hover:text-gray-700'"
                                                        x-on:click="activeTab = 'month'; updateCalendarView('month')"
                                                        type="button" title="month view">
                                                        month
                                                    </button>
                                                    <button
                                                        class="inline-flex items-center rounded-md px-3 py-2 !text-md font-medium transition-colors duration-200 ease-in-out"
                                                        x-bind:class="activeTab === 'week' ? 'bg-white text-gray-900 shadow-xs' : 'bg-transparent text-gray-500 hover:text-gray-700'"
                                                        x-on:click="activeTab = 'week'; updateCalendarView('week')"
                                                        type="button" title="week view">
                                                        week
                                                    </button>
                                                    <button
                                                        class="inline-flex items-center rounded-md px-3 py-2 !text-md font-medium transition-colors duration-200 ease-in-out"
                                                        x-bind:class="activeTab === 'day' ? 'bg-white text-gray-900 shadow-xs' : 'bg-transparent text-gray-500 hover:text-gray-700'"
                                                        x-on:click="activeTab = 'day'; updateCalendarView('day')"
                                                        type="button" title="day view">
                                                        day
                                                    </button>
                                                </nav>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Legend Row -->
                                    <div class="px-4 pb-4 border-t border-gray-100">
                                        <div class="flex flex-wrap items-center justify-center gap-6 pt-3">
                                            <div class="flex items-center gap-2">
                                                <div class="w-3 h-3 bg-blue-500 rounded-full shadow-sm"></div>
                                                <span class="!text-md font-medium text-gray-700">New Development</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <div class="w-3 h-3 bg-red-500 rounded-full shadow-sm"></div>
                                                <span class="!text-md font-medium text-gray-700">Bug</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <div class="w-3 h-3 bg-purple-500 rounded-full shadow-sm"></div>
                                                <span class="!text-md font-medium text-gray-700">Design</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <div class="w-3 h-3 bg-green-500 rounded-full shadow-sm"></div>
                                                <span class="!text-md font-medium text-gray-700">Enhancement</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <div class="w-3 h-3 bg-yellow-500 rounded-full shadow-sm"></div>
                                                <span class="!text-md font-medium text-gray-700">Ad Hoc</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Calendar Grid -->
                                <div class="bg-white rounded-lg border border-gray-200 shadow-sm">
                                    <!-- Day Headers -->
                                    <div class="grid grid-cols-7 border-b border-gray-200">
                                        <div class="p-4 text-center !text-md font-medium text-gray-500">Sun</div>
                                        <div class="p-4 text-center !text-md font-medium text-gray-500">Mon</div>
                                        <div class="p-4 text-center !text-md font-medium text-gray-500">Tue</div>
                                        <div class="p-4 text-center !text-md font-medium text-gray-500">Wed</div>
                                        <div class="p-4 text-center !text-md font-medium text-gray-500">Thu</div>
                                        <div class="p-4 text-center !text-md font-medium text-gray-500">Fri</div>
                                        <div class="p-4 text-center !text-md font-medium text-gray-500">Sat</div>
                                    </div>

                                    <!-- Calendar Days -->
                                    <div id="calendar-grid" class="grid grid-cols-7 grid-rows-6">
                                        <!-- Calendar days will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Form Modal -->
    <div id="task-modal" class="fixed inset-0 bg-black bg-opacity-50 z-[9999] flex items-center justify-center hidden">
        <div
            class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
            <div class="rounded-2xl border border-gray-200 bg-white">
                <div class="px-5 py-4 sm:px-6 sm:py-5" <div class="flex items-center justify-between">
                    <h3 class="!!text-2xl font-medium text-gray-800">Add New Task</h3>
                    <button id="close-modal" class="text-gray-400 hover:text-gray-500">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="p-5 space-y-6 border-t border-gray-100 sm:p-6">
                <form id="task-form">
                    <input type="hidden" id="form-column" value="">
                    <input type="hidden" id="task-id" value="">
                    <div class="-mx-2.5 flex flex-wrap gap-y-5">
                        <div class="w-full px-2.5">
                            <input type="text" id="task-ticket-number" placeholder="Ticket Number (e.g., PBTBLT-122670)"
                                required
                                class="h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 !text-md text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10">
                        </div>

                        <div class="w-full px-2.5">
                            <textarea id="task-description" placeholder="Issue Description" rows="3" required
                                class="w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 !text-md text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10"></textarea>
                        </div>

                        <div class="w-1/2 px-2.5">
                            <select id="task-ticket-type" required
                                class="h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 !text-md text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10">
                                <option value="">Select Ticket Type</option>
                                <option value="jira">Jira</option>
                                <option value="enhancement">Enhancement</option>
                                <option value="bug">Bug</option>
                                <option value="maintenance">Maintenance</option>
                                <option value="support">Support</option>
                            </select>
                        </div>

                        <div class="w-1/2 px-2.5">
                            <select id="task-priority" required
                                class="h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 !text-md text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10">
                                <option value="">Select Priority</option>
                                <option value="1">1 - Critical</option>
                                <option value="2">2 - High</option>
                                <option value="3">3 - Medium</option>
                                <option value="4">4 - Low</option>
                                <option value="5">5 - Lowest</option>
                            </select>
                        </div>

                        <div class="w-1/2 px-2.5">
                            <select id="task-assigned-to"
                                class="h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 !text-md text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10">
                                <option value="">Assigned to (Maker):</option>
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>

                        <div class="w-1/2 px-2.5">
                            <select id="task-assigned-by"
                                class="h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 !text-md text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10">
                                <option value="">Assigned by:</option>
                                <!-- Options will be populated by JavaScript -->
                            </select>
                        </div>

                        <div class="w-1/2 px-2.5">
                            <select id="task-team-in-charge" required
                                class="h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 !text-md text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10">
                                <option value="">Select Team in Charge</option>
                                <option value="tableau">Tableau</option>
                                <option value="automation">Automation</option>
                                <option value="data">Data</option>
                                <option value="infrastructure">Infrastructure</option>
                                <option value="security">Security</option>
                                <option value="development">Development</option>
                            </select>
                        </div>

                        <div class="w-1/2 px-2.5">
                            <input type="date" id="task-submission-date" placeholder="Submission Date"
                                class="h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 !text-md text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10">
                        </div>

                        <div class="w-full px-2.5">
                            <div
                                class="h-11 w-full rounded-lg border border-gray-200 bg-gray-50 px-4 py-2.5 !text-md text-gray-600 shadow-theme-xs">
                                <span class="text-gray-500">Days Pending: </span>
                                <span id="days-pending-display" class="font-medium">Will be calculated
                                    automatically</span>
                            </div>
                        </div>

                        <div class="w-full px-2.5 flex justify-end space-x-2">
                            <button type="button" id="cancel-task"
                                class="px-4 py-2 !text-md font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-200">Cancel</button>
                            <button type="submit"
                                class="px-4 py-2 !text-md font-medium text-white transition-colors rounded-lg bg-blue-500 hover:bg-blue-800">Save</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    </div>

    <!-- Lifecycle Update Modal -->
    <div id="lifecycle-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-[9999]">
        <div
            class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
            <div class="rounded-2xl border border-gray-200 bg-white">
                <div class="px-5 py-4 sm:px-6 sm:py-5">
                    <div class="flex items-center justify-between">
                        <h3 class="!!text-2xl font-medium text-gray-800">Task Status Update</h3>
                        <button id="close-lifecycle-modal" class="text-gray-400 hover:text-gray-500">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="p-5 space-y-6 border-t border-gray-100 sm:p-6">
                    <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                        <div class="flex items-center mb-2">
                            <svg class="w-7 h-7 text-blue-500 mr-2" fill="none" stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <h4 class="!text-md font-medium text-blue-800">Status Change Detected</h4>
                        </div>
                        <p class="!text-md text-blue-700">
                            Task "<span id="lifecycle-task-title" class="font-medium"></span>" has been moved from
                            <span id="lifecycle-from-status" class="font-medium"></span> to
                            <span id="lifecycle-to-status" class="font-medium"></span>
                        </p>
                    </div>

                    <form id="lifecycle-form">
                        <input type="hidden" id="lifecycle-task-id" value="">
                        <input type="hidden" id="lifecycle-new-column" value="">

                        <div class="-mx-2.5 flex flex-wrap gap-y-5">
                            <div class="w-full px-2.5">
                                <select id="lifecycle-update-type" required
                                    class="h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 !text-md text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10">
                                    <option value="">Select update type</option>
                                    <option value="progress">Progress Update</option>
                                    <option value="blocker">Blocker/Issue</option>
                                    <option value="completion">Task Completion</option>
                                    <option value="review">Ready for Review</option>
                                    <option value="testing">Testing Phase</option>
                                    <option value="deployment">Deployment</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>

                            <div class="w-full px-2.5">
                                <textarea id="lifecycle-comments"
                                    placeholder="Describe what has changed, any blockers, or next steps..." required
                                    rows="3"
                                    class="w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 !text-md text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10"></textarea>
                            </div>

                            <div class="w-full px-2.5">
                                <select id="lifecycle-updated-by" required
                                    class="h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 !text-md text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10">
                                    <option value="">Select assigned user</option>
                                    <!-- Options will be populated by JavaScript -->
                                </select>
                            </div>

                            <div class="w-full px-2.5 flex justify-end space-x-2">
                                <button type="button" id="cancel-lifecycle"
                                    class="px-4 py-2 !text-md font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-200">Cancel</button>
                                <button type="submit"
                                    class="px-4 py-2 !text-md font-medium text-white transition-colors rounded-lg bg-blue-500 hover:bg-blue-800">Save
                                    Update</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Lifecycle History Modal -->
    <div id="lifecycle-history-modal"
        class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-[9999]">
        <div
            class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-2xl max-h-[80vh] overflow-y-auto">
            <div class="rounded-2xl border border-gray-200 bg-white">
                <div class="px-5 py-4 sm:px-6 sm:py-5">
                    <div class="flex items-center justify-between">
                        <h3 class="!!text-2xl font-medium text-gray-800">Task Lifecycle History</h3>
                        <button id="close-history-modal" class="text-gray-400 hover:text-gray-500">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                                xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="p-5 space-y-6 border-t border-gray-100 sm:p-6">
                    <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                        <h4 id="history-task-title" class="!text-md font-medium text-gray-900 mb-2"></h4>
                        <div class="grid grid-cols-2 gap-4 !text-md text-gray-600">
                            <div>
                                <span class="font-medium">Current status:</span>
                                <span id="history-current-status" class="ml-1"></span>
                            </div>
                            <div>
                                <span class="font-medium">Last update:</span>
                                <span id="history-last-updated" class="ml-1"></span>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4" id="lifecycle-timeline">
                        <!-- Timeline entries will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        // Update notification function to handle error type - moved to top for availability
        function showNotification(title, message, type = 'notification') {
            let container = document.getElementById('notificationsContainer');

            // If container doesn't exist, create it
            if (!container) {
                container = document.createElement('div');
                container.id = 'notificationsContainer';
                container.className = 'fixed bottom-4 right-4 z-50 space-y-2 max-w-md';
                document.body.appendChild(container);
            }

            const notification = document.createElement('div');

            const bgColor = type === 'error'
                ? 'bg-red-100'
                : type === 'message'
                    ? 'bg-blue-100'
                    : type === 'success'
                        ? 'bg-green-100'
                        : 'bg-green-100';

            const iconColor = type === 'error'
                ? 'text-red-600'
                : type === 'message'
                    ? 'text-blue-600'
                    : type === 'success'
                        ? 'text-green-600'
                        : 'text-green-600';

            const icon = type === 'error'
                ? `<svg class="h-6 w-6 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>`
                : type === 'message'
                    ? `<svg class="h-6 w-6 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                    </svg>`
                    : type === 'success'
                        ? `<svg class="h-6 w-6 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>`
                        : `<svg class="h-6 w-6 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                        </svg>`;

            notification.className = `flex items-center gap-4 rounded-lg border border-gray-200 bg-white p-4 shadow-lg notification-item`;

            notification.innerHTML = `
                <div class="flex h-10 w-10 items-center justify-center rounded-full ${bgColor}">
                    ${icon}
                </div>
                <div class="flex-1">
                    <h4 class="!text-md font-medium text-gray-900 text-left">${title}</h4>
                    <p class="!text-md text-gray-500 text-left">${message}</p>
                </div>
                <button class="text-gray-400 hover:text-gray-500 close-notification">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            `;

            container.appendChild(notification);

            // Add close button functionality
            const closeButton = notification.querySelector('.close-notification');
            closeButton.addEventListener('click', () => {
                notification.remove();
            });

            // Auto close after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Temporary updateMetrics stub to prevent Alpine.js watcher errors
        // This will be replaced by the real function later in the script
        let pendingMetricsUpdates = [];
        let realUpdateMetrics = null;

        async function updateMetrics(showNotifications = true) {
            console.log('updateMetrics stub called, showNotifications:', showNotifications);
            if (realUpdateMetrics && typeof realUpdateMetrics === 'function') {
                console.log('Real updateMetrics function is available, calling it');
                return await realUpdateMetrics(showNotifications);
            } else {
                console.log('Real updateMetrics function not yet available, queuing call');
                pendingMetricsUpdates.push(showNotifications);
                // Try again in a short while
                setTimeout(() => {
                    if (realUpdateMetrics && typeof realUpdateMetrics === 'function') {
                        console.log('Executing queued updateMetrics call');
                        realUpdateMetrics(showNotifications);
                        pendingMetricsUpdates = []; // Clear pending calls
                    }
                }, 1000);
            }
        }

        // Helper function to register the real updateMetrics function
        function registerRealUpdateMetrics(fn) {
            console.log('Registering real updateMetrics function');
            realUpdateMetrics = fn;
            // Execute any pending calls
            if (pendingMetricsUpdates.length > 0) {
                console.log('Executing', pendingMetricsUpdates.length, 'pending updateMetrics calls');
                pendingMetricsUpdates.forEach(showNotifications => {
                    realUpdateMetrics(showNotifications);
                });
                pendingMetricsUpdates = [];
            }
        }

        // Temporary updateCalendar stub to prevent Alpine.js watcher errors
        // This will be replaced by the real function later in the script
        let pendingCalendarUpdates = [];
        let realUpdateCalendar = null;

        function updateCalendar() {
            console.log('updateCalendar stub called');
            if (realUpdateCalendar && typeof realUpdateCalendar === 'function') {
                console.log('Real updateCalendar function is available, calling it');
                return realUpdateCalendar();
            } else {
                console.log('Real updateCalendar function not yet available, queuing call');
                pendingCalendarUpdates.push(true);
                // Try again in a short while
                setTimeout(() => {
                    if (realUpdateCalendar && typeof realUpdateCalendar === 'function') {
                        console.log('Executing queued updateCalendar call');
                        realUpdateCalendar();
                        pendingCalendarUpdates = []; // Clear pending calls
                    }
                }, 1000);
            }
        }

        // Helper function to register the real updateCalendar function
        function registerRealUpdateCalendar(fn) {
            console.log('Registering real updateCalendar function');
            realUpdateCalendar = fn;
            // Execute any pending calls
            if (pendingCalendarUpdates.length > 0) {
                console.log('Executing', pendingCalendarUpdates.length, 'pending updateCalendar calls');
                pendingCalendarUpdates.forEach(() => {
                    realUpdateCalendar();
                });
                pendingCalendarUpdates = [];
            }
        }

        // View switching function - made globally accessible
        window.switchView = function (viewName) {
            console.log('Switching to view:', viewName);

            // This function is used in onclick handlers and Alpine.js @click events
            // Alpine.js will handle the actual view switching, this is just for compatibility

            // Find the Alpine.js container and update its data
            try {
                const alpineElement = document.querySelector('[x-data]');
                if (alpineElement && alpineElement.__x && alpineElement.__x.$data) {
                    alpineElement.__x.$data.activeView = viewName;
                    console.log('Alpine.js activeView set to:', viewName);
                }
            } catch (error) {
                console.debug('Alpine.js data update failed:', error);
            }

            // Handle view-specific updates
            if (viewName === 'table') {
                // When switching to table view, populate it with existing data
                console.log('Switching to table view, updating table...');
                if (typeof updateTableView === 'function') {
                    updateTableView().catch(error => {
                        console.error('Error updating table view:', error);
                    });
                }
            } else if (viewName === 'calendar') {
                // When switching to calendar view, update it
                console.log('Switching to calendar view, updating calendar...');
                if (typeof updateCalendar === 'function') {
                    updateCalendar();
                }
            } else if (viewName === 'metrics') {
                // When switching to metrics view, update it
                console.log('Switching to metrics view, updating metrics...');
                if (typeof updateMetrics === 'function') {
                    updateMetrics(false).catch(error => {
                        console.error('Error updating metrics view:', error);
                    });
                }
            }
        };

        // Function to fetch tasks from Confluence (with fallback to dummy data)
        async function fetchTasks() {
            try {
                console.log('Fetching tasks from Confluence...');
                const url = `https://cedt-confluence.net/confluence/download/attachments/2740868871/tasks.json?api=v2`;
                console.log('Request URL:', url);

                const response = await fetch(url);
                console.log('Response status:', response.status);
                console.log('Response OK:', response.ok);

                if (!response.ok) {
                    // Log the error and throw it to be caught by the caller
                    const errorText = await response.text(); // Attempt to get more error details
                    console.error(`Failed to load data: ${response.status} ${response.statusText}`, errorText);
                    throw new Error(`Failed to load data from Confluence: ${response.status} ${response.statusText}. Server response: ${errorText}`);
                }

                const data = await response.json();
                console.log('Raw data received:', data);

                const tasks = data.tasks || []; // Return empty array if tasks are not present
                console.log('Tasks extracted:', tasks);
                console.log('Number of tasks:', tasks.length);

                if (tasks.length > 0) {
                    console.log('Sample task:', tasks[0]);

                    return tasks;
                } else {
                    console.log('No tasks found in Confluence response, returning empty array.');
                    return []; // Return empty array if no tasks found, signifies successful fetch but no data.
                }

            } catch (error) {
                // Log the error and provide fallback dummy data
                console.warn('Error fetching tasks from Confluence:', error);
                console.warn('Error details:', {
                    message: error.message,
                    name: error.name,
                });
                console.warn('Falling back to dummy data for demonstration purposes...');

                // Check if we have saved fallback data in localStorage first
                try {
                    const savedData = localStorage.getItem('kanban_fallback_tasks');
                    if (savedData) {
                        const parsedData = JSON.parse(savedData);
                        if (parsedData.tasks && Array.isArray(parsedData.tasks) && parsedData.tasks.length > 0) {
                            console.log('Found saved fallback data in localStorage:', parsedData.tasks.length, 'tasks');
                            return parsedData.tasks;
                        }
                    }
                } catch (localStorageError) {
                    console.warn('Error reading from localStorage:', localStorageError);
                }

                // If no fallback data available, return empty array to prevent undefined errors
                console.log('No fallback data available, returning empty array.');
                return [];
            }
        }

        // Function to fetch team members from Excel file
        async function fetchTeamMembers() {
            try {
                console.log('Fetching team members from Confluence...');
                const url = `https://cedt-confluence.net/confluence/download/attachments/2740868871/team_members.xlsx?api=v2`;
                console.log('Team members URL:', url);

                const response = await fetch(url);
                console.log('Team members response status:', response.status);

                if (!response.ok) {
                    throw new Error(`Failed to load team members: ${response.status} ${response.statusText}`);
                }

                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const jsonData = XLSX.utils.sheet_to_json(worksheet);

                console.log('Team members data:', jsonData);

                // Transform data to ensure consistent structure
                const teamMembers = jsonData.map(member => ({
                    name: member.name || member.Name || '',
                    surname: member.surname || member.Surname || '',
                    username: member.username || member.Username || member.id || member.ID || '',
                    maker: member.maker === true || member.maker === 'True' || member.maker === 'true' || member.Maker === true || member.Maker === 'True' || member.Maker === 'true',
                    checker: member.checker === true || member.checker === 'True' || member.checker === 'true' || member.Checker === true || member.Checker === 'True' || member.Checker === 'true',
                    admin: member.admin === true || member.admin === 'True' || member.admin === 'true' || member.Admin === true || member.Admin === 'True' || member.Admin === 'true'
                }));

                console.log('Processed team members:', teamMembers);
                return teamMembers;

            } catch (error) {
                console.warn('Error fetching team members:', error);
                console.warn('Falling back to demo team members...');

                // Fallback demo data
                const demoTeamMembers = [
                    { name: 'John', surname: 'Doe', username: 'john.doe', maker: true, checker: false, admin: true },
                    { name: 'Jane', surname: 'Smith', username: 'jane.smith', maker: true, checker: true, admin: false },
                    { name: 'Bob', surname: 'Wilson', username: 'bob.wilson', maker: false, checker: true, admin: false },
                    { name: 'Alice', surname: 'Johnson', username: 'alice.johnson', maker: true, checker: false, admin: false },
                    { name: 'Charlie', surname: 'Brown', username: 'charlie.brown', maker: false, checker: true, admin: false },
                    { name: 'Admin', surname: 'User', username: 'admin', maker: true, checker: true, admin: true }
                ];

                return demoTeamMembers;
            }
        }

        // Function to get current user from Confluence API
        async function getCurrentUser() {
            try {
                console.log('Fetching current user from Confluence...');
                const response = await fetch('https://cedt-confluence.net/confluence/rest/api/user/current', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`Failed to get current user: ${response.status} ${response.statusText}`);
                }

                const userData = await response.json();
                console.log('Current user data:', userData);

                return {
                    username: userData.username || userData.accountId || 'unknown',
                    displayName: userData.displayName || userData.username || 'Unknown User'
                };

            } catch (error) {
                console.warn('Error fetching current user:', error);
                console.warn('Falling back to demo user...');

                // In demo mode, simulate being logged in as admin
                return {
                    username: 'admin',
                    displayName: 'Demo Admin User'
                };
            }
        }

        // Global variables for user management
        let teamMembers = [];
        let currentUser = null;
        let userPermissions = {
            canDelete: false,
            isAdmin: false,
            isMaker: false,
            isChecker: false
        };

        // Function to initialize user management
        async function initializeUserManagement() {
            try {
                console.log('Initializing user management...');

                // Fetch team members and current user in parallel
                const [members, user] = await Promise.all([
                    fetchTeamMembers(),
                    getCurrentUser()
                ]);

                teamMembers = members;
                currentUser = user;

                console.log('Team members loaded:', teamMembers.length);
                console.log('Current user:', currentUser);

                // Find current user in team members to get permissions
                const userProfile = teamMembers.find(member => member.username === currentUser.username);

                if (userProfile) {
                    userPermissions = {
                        canDelete: userProfile.admin,
                        isAdmin: userProfile.admin,
                        isMaker: userProfile.maker,
                        isChecker: userProfile.checker
                    };
                    console.log('User permissions:', userPermissions);
                } else {
                    console.warn('Current user not found in team members list');
                    userPermissions = {
                        canDelete: false,
                        isAdmin: false,
                        isMaker: false,
                        isChecker: false
                    };
                }

                // Update UI based on permissions
                updateUIBasedOnPermissions();

                // Populate form dropdowns
                populateUserDropdowns();

                showNotification('User Management', `Logged in as ${currentUser.displayName} (${userPermissions.isAdmin ? 'Admin' : 'User'})`, 'message');

            } catch (error) {
                console.error('Error initializing user management:', error);
                showNotification('Error', 'Failed to initialize user management', 'error');
            }
        }

        // Function to update UI based on user permissions
        function updateUIBasedOnPermissions() {
            console.log('Updating UI based on permissions:', userPermissions);

            // Hide/show delete buttons based on admin permissions
            const deleteButtons = document.querySelectorAll('[onclick*="deleteTask"]');
            deleteButtons.forEach(button => {
                if (userPermissions.canDelete) {
                    button.style.display = '';
                    button.disabled = false;
                } else {
                    button.style.display = 'none';
                }
            });

            // Add permission indicator to the header
            addPermissionIndicator();
        }

        // Function to add permission indicator to header
        function addPermissionIndicator() {
            const headerElement = document.querySelector('h3.text-2xl');
            if (headerElement && currentUser) {
                // Remove existing indicator
                const existingIndicator = document.getElementById('user-permission-indicator');
                if (existingIndicator) {
                    existingIndicator.remove();
                }

                const indicator = document.createElement('div');
                indicator.id = 'user-permission-indicator';
                indicator.className = 'mt-2 flex items-center gap-2 !text-md text-gray-600';

                const roleIcon = userPermissions.isAdmin ? 'ðŸ‘‘' : userPermissions.isMaker && userPermissions.isChecker ? 'ðŸ› ï¸âœ…' : userPermissions.isMaker ? 'ðŸ› ï¸' : userPermissions.isChecker ? 'âœ…' : 'ðŸ‘¤';
                const roleText = userPermissions.isAdmin ? 'Admin' : userPermissions.isMaker && userPermissions.isChecker ? 'Maker & Checker' : userPermissions.isMaker ? 'Maker' : userPermissions.isChecker ? 'Checker' : 'User';

                indicator.innerHTML = `
                    <span class="flex items-center gap-1">
                        <span>${roleIcon}</span>
                        <span>Logged in as: <strong>${currentUser.displayName}</strong> (${roleText})</span>
                    </span>
                `;

                headerElement.parentNode.insertBefore(indicator, headerElement.nextSibling);
            }
        }

        // Function to populate user dropdowns based on roles
        function populateUserDropdowns() {
            console.log('Populating user dropdowns...');

            // Get makers for task-assigned-user
            const makers = teamMembers.filter(member => member.maker);
            console.log('Makers found:', makers.length);

            // Get checkers for task-submitted-by
            const checkers = teamMembers.filter(member => member.checker);
            console.log('Checkers found:', checkers.length);

            // Populate assigned user dropdown (makers)
            const assignedUserSelect = document.getElementById('task-assigned-to');
            if (assignedUserSelect) {
                assignedUserSelect.innerHTML = '<option value="">Assigned to (Maker):</option>';
                makers.forEach(maker => {
                    const option = document.createElement('option');
                    option.value = `${maker.name} ${maker.surname}`;
                    option.textContent = `${maker.name} ${maker.surname} (${maker.username})`;
                    assignedUserSelect.appendChild(option);
                });
                console.log('Assigned user dropdown populated with', makers.length, 'makers');
            }

            // Populate assigned by dropdown (both makers and checkers)
            const assignedBySelect = document.getElementById('task-assigned-by');
            if (assignedBySelect) {
                assignedBySelect.innerHTML = '<option value="">Assigned by:</option>';
                const assigners = teamMembers.filter(member => member.maker || member.checker);
                assigners.forEach(assigner => {
                    const option = document.createElement('option');
                    option.value = `${assigner.name} ${assigner.surname}`;
                    option.textContent = `${assigner.name} ${assigner.surname} (${assigner.username})`;
                    assignedBySelect.appendChild(option);
                });
                console.log('Assigned by dropdown populated with', assigners.length, 'makers and checkers');
            }

            // Also update lifecycle form dropdown
            const lifecycleUpdatedBySelect = document.getElementById('lifecycle-updated-by');
            if (lifecycleUpdatedBySelect) {
                lifecycleUpdatedBySelect.innerHTML = '<option value="">Select assigned user</option>';
                makers.forEach(maker => {
                    const option = document.createElement('option');
                    option.value = `${maker.name} ${maker.surname}`;
                    option.textContent = `${maker.name} ${maker.surname} (${maker.username})`;
                    lifecycleUpdatedBySelect.appendChild(option);
                });
            }
        }

        // Function to check if user can delete (with enhanced permission checking)
        function canUserDelete() {
            if (!currentUser || !userPermissions.canDelete) {
                console.log('Delete permission denied:', { currentUser, canDelete: userPermissions.canDelete });
                return false;
            }
            return true;
        }

        // Function to save tasks to Confluence (always use tasks.json)
        async function saveTasks(tasks, showNotifications = true) {
            try {
                // Check if we're using fallback data
                const isUsingFallback = tasks.some(task => task.id && task.id.startsWith('task_'));

                if (isUsingFallback) {
                    // Store data locally when using fallback mode
                    console.log('Using fallback mode - storing tasks locally');
                    localStorage.setItem('kanban_fallback_tasks', JSON.stringify({ tasks }));

                    if (showNotifications) {
                        showNotification('Demo Mode', 'Changes saved locally (demo mode - not connected to Confluence)', 'message');
                    }
                    return { success: true, mode: 'local' };
                }

                // Try to save to Confluence (original functionality)
                // Get the attachment ID for tasks.json
                const attachmentsResponse = await fetch(`https://cedt-confluence.net/confluence/rest/api/content/2740868871/child/attachment?filename=tasks.json`);
                const attachmentsData = await attachmentsResponse.json();
                if (!attachmentsData.results || attachmentsData.results.length === 0) {
                    throw new Error('tasks.json attachment not found');
                }
                const attachmentId = attachmentsData.results[0].id;
                // Update the existing attachment
                const formData = new FormData();
                const blob = new Blob([JSON.stringify({ tasks }, null, 2)], { type: 'application/json' });
                formData.append('file', blob, 'tasks.json');
                const response = await fetch(`https://cedt-confluence.net/confluence/rest/api/content/2740868871/child/attachment/${attachmentId}`, {
                    method: 'POST',
                    headers: {
                        'X-Atlassian-Token': 'no-check'
                    },
                    body: formData
                });
                if (!response.ok) {
                    throw new Error(`Failed to save tasks.json: ${response.status} ${response.statusText}`);
                }
                if (showNotifications) {
                    showNotification('Success', 'Tasks saved successfully to Confluence', 'notification');
                }
                return await response.json();
            } catch (error) {
                console.error('Error saving tasks:', error);

                // If Confluence save fails, fall back to local storage
                console.log('Confluence save failed, falling back to local storage');
                localStorage.setItem('kanban_fallback_tasks', JSON.stringify({ tasks }));

                if (showNotifications) {
                    showNotification('Demo Mode', 'Changes saved locally (Confluence not accessible)', 'message');
                }
                return { success: true, mode: 'local_fallback' };
            }
        }

        // Initialize view switching
        document.addEventListener('DOMContentLoaded', async function () {
            // Declare flags and observers early to avoid temporal dead zone issues
            let isRefreshing = false; // Flag to prevent concurrent updates during refresh
            let isUpdatingTable = false; // Flag to prevent concurrent table updates
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList' && !isRefreshing) { // Only react if not refreshing
                        console.log('MutationObserver detected change, updating table view');
                        updateTableView().catch(console.error);
                    }
                });
            });

            // Initialize with kanban view
            window.switchView('kanban');

            // Initialize user management first
            await initializeUserManagement();

            // Load initial tasks
            await loadTasksFromConfluence(false); // Pass false to prevent initial notifications

            // Add calendar navigation event listeners
            document.getElementById('calendar-prev-btn').addEventListener('click', function () {
                navigateCalendar(-1);
            });

            document.getElementById('calendar-next-btn').addEventListener('click', function () {
                navigateCalendar(1);
            });

            // Function to navigate calendar
            function navigateCalendar(direction) {
                switch (currentCalendarView) {
                    case 'month':
                        // Handle month navigation properly to avoid date overflow
                        const currentMonth = currentCalendarDate.getMonth();
                        const currentYear = currentCalendarDate.getFullYear();
                        // Set to first day of month to avoid overflow issues
                        currentCalendarDate = new Date(currentYear, currentMonth + direction, 1);
                        break;
                    case 'week':
                        currentCalendarDate.setDate(currentCalendarDate.getDate() + (direction * 7));
                        break;
                    case 'day':
                        currentCalendarDate.setDate(currentCalendarDate.getDate() + direction);
                        break;
                }
                updateCalendarReal();
            }

            // Add refresh button functionality
            document.getElementById('refresh-data').addEventListener('click', async function () {
                console.log('Refresh button clicked');
                try {
                    // Disable button and show loading state
                    this.disabled = true;
                    const originalHTML = this.innerHTML;
                    this.innerHTML = `
                        <svg class="animate-spin h-5 w-5" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="m4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 714 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Refreshing...
                    `;

                    // Call loadTasksFromConfluence with notifications enabled
                    await loadTasksFromConfluence(true);

                    // Restore button
                    this.innerHTML = originalHTML;
                    this.disabled = false;
                } catch (error) {
                    console.error('Error during manual refresh:', error);
                    // Restore button even on error
                    this.innerHTML = originalHTML;
                    this.disabled = false;
                    // Show error notification if not already shown by loadTasksFromConfluence
                    showNotification('Error', 'Failed to refresh data. Please try again.', 'error');
                }
            });

            // Function to load tasks from Confluence
            async function loadTasksFromConfluence(showNotifications = true) {
                try {
                    // Set refreshing flag to prevent MutationObserver from triggering extra updates
                    isRefreshing = true;
                    console.log('loadTasksFromConfluence: Starting refresh, isRefreshing =', isRefreshing);

                    // Temporarily disconnect the observer to prevent interference
                    observer.disconnect();

                    // Reset all counters to 0 first
                    document.querySelectorAll('.task-counter').forEach(counter => {
                        counter.textContent = '0';
                    });

                    // Clear existing tasks from UI *before* fetching new ones
                    document.querySelectorAll('.task-list').forEach(list => list.innerHTML = '');

                    const tasks = await fetchTasks();
                    console.log('fetchTasks returned:', tasks.length, 'tasks');

                    // Check if we're using fallback data by looking for our dummy task IDs
                    const isUsingFallback = tasks.some(task => task.id && task.id.startsWith('task_'));

                    if (tasks.length > 0) {
                        // Saves to their respective columns
                        tasks.forEach(task => {
                            const column = document.getElementById(`${task.column}-column`);
                            if (column) {
                                const taskCard = document.createElement('div');
                                taskCard.className = 'task-card';
                                taskCard.dataset.id = task.id;
                                taskCard.dataset.priority = task.priority;
                                taskCard.dataset.assignedTo = task.assignedTo;
                                taskCard.dataset.assignedBy = task.assignedBy;
                                taskCard.dataset.submissionDate = task.submissionDate;
                                taskCard.dataset.ticketType = task.ticketType;
                                taskCard.innerHTML = createTaskCardHTML(task);
                                column.appendChild(taskCard);
                            }
                        });

                        // Update counters
                        updateTaskCounters();
                        console.log('Tasks loaded into kanban, updating table view...');

                        // Update table view only once, after all tasks are loaded
                        await updateTableView();

                        // Reapply search filter if one is active
                        if (typeof applySearchFilter === 'function') {
                            applySearchFilter();
                        }

                        // Update UI permissions after tasks are loaded
                        if (typeof updateUIBasedOnPermissions === 'function') {
                            updateUIBasedOnPermissions();
                        }

                        if (showNotifications === true) {
                            if (isUsingFallback) {
                                showNotification('Demo Mode', `${tasks.length} sample tasks loaded for demonstration (Confluence server not accessible)`, 'message');
                            } else {
                                showNotification('Success', `${tasks.length} tasks loaded successfully from Confluence`, 'notification');
                            }
                        } else if (isUsingFallback) {
                        }
                    } else if (showNotifications) {
                        showNotification('Info', 'No tasks found or unable to load tasks from the server.', 'message');
                    }

                    // After tasks are loaded, check current view and update if necessary
                    try {
                        const alpineElement = document.querySelector('[x-data]');
                        if (alpineElement && alpineElement.__x && alpineElement.__x.$data) {
                            const currentView = alpineElement.__x.$data.activeView;
                            if (currentView === 'metrics') {
                                console.log('loadTasksFromConfluence: Active view is metrics, updating metrics.');
                                await updateMetrics(false); // false to avoid double notification
                            } else if (currentView === 'calendar') {
                                console.log('loadTasksFromConfluence: Active view is calendar, updating calendar.');
                                updateCalendar();
                            }
                        }
                    } catch (error) {
                        console.warn('Could not check active view to refresh metrics/calendar after task load:', error);
                    }

                } catch (error) {
                    console.error('Error in loadTasksFromConfluence:', error);
                    if (showNotifications) {
                        showNotification('Error', `Unexpected error loading tasks: ${error.message}`, 'error');
                    }
                    // Reset counters to 0 on error
                    document.querySelectorAll('.task-counter').forEach(counter => {
                        counter.textContent = '0';
                    });
                } finally {
                    // Always reset the refreshing flag and reconnect observer
                    isRefreshing = false;
                    console.log('loadTasksFromConfluence: Finished refresh, isRefreshing =', isRefreshing);

                    // Reconnect the observer
                    document.querySelectorAll('.task-list').forEach(list => {
                        observer.observe(list, {
                            childList: true
                        });
                    });
                }
            }

            // Add search functionality
            let currentSearchTerm = '';

            document.getElementById('searchInput').addEventListener('input', function (e) {
                currentSearchTerm = e.target.value.toLowerCase();
                applySearchFilter();
            });

            function applySearchFilter() {
                // Search in Kanban view
                document.querySelectorAll('.task-card').forEach(card => {
                    const ticketNumber = card.querySelector('.text-lg.font-bold')?.textContent.toLowerCase() || '';
                    const description = card.querySelector('p')?.textContent.toLowerCase() || '';
                    const badges = Array.from(card.querySelectorAll('.inline-flex span')).map(span => span.textContent.toLowerCase()).join(' ');
                    const priority = card.dataset.priority?.toLowerCase() || '';
                    const assignedTo = (card.dataset.assignedTo || '').toLowerCase();

                    const matches = !currentSearchTerm ||
                        ticketNumber.includes(currentSearchTerm) ||
                        description.includes(currentSearchTerm) ||
                        badges.includes(currentSearchTerm) ||
                        priority.includes(currentSearchTerm) ||
                        assignedTo.includes(currentSearchTerm);

                    card.style.display = matches ? 'block' : 'none';
                });

                // Search in Table view
                document.querySelectorAll('#table-body tr').forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const matches = !currentSearchTerm || Array.from(cells).some(cell =>
                        cell.textContent.toLowerCase().includes(currentSearchTerm)
                    );

                    row.style.display = matches ? '' : 'none';
                });
            }

            // Add MutationObserver to update table view when tasks are modified
            // Observe task lists for changes
            document.querySelectorAll('.task-list').forEach(list => {
                observer.observe(list, {
                    childList: true, // Only observe direct children additions/removals
                    // attributes: true, // Removed
                    // subtree: true // Removed
                });
            });

            // Initialize sortable for each column
            const columns = document.querySelectorAll('.task-list');
            columns.forEach(column => {
                new Sortable(column, {
                    group: 'kanban',
                    animation: 150,
                    ghostClass: 'bg-gray-100',
                    onEnd: async function (evt) {
                        const taskElement = evt.item;
                        const taskId = taskElement.dataset.id;
                        const newColumn = evt.to.id.replace('-column', '');
                        const oldColumn = evt.from.id.replace('-column', '');

                        console.log('Sortable onEnd triggered:', {
                            taskId,
                            oldColumn,
                            newColumn,
                            hasChanged: newColumn !== oldColumn
                        });

                        // Only show lifecycle modal if task actually moved to a different column
                        if (newColumn !== oldColumn) {
                            console.log('Column change detected, calling showLifecycleModal');
                            showLifecycleModal(taskId, oldColumn, newColumn, taskElement);
                        } else {
                            console.log('No column change, just updating counters');
                            updateTaskCounters();
                        }
                    }
                });
            });

            // Save Modal Functionality
            const taskModal = document.getElementById('task-modal');
            const taskForm = document.getElementById('task-form');
            const closeModal = document.getElementById('close-modal');
            const cancelTask = document.getElementById('cancel-task');

            // Function to show modal
            function showTaskModal(column) {
                document.getElementById('form-column').value = column;
                document.getElementById('task-id').value = ''; // Reset task ID for new tasks
                taskForm.reset(); // Reset form
                taskModal.classList.remove('hidden');
            }

            // Function to hide modal
            function hideTaskModal() {
                taskModal.classList.add('hidden');
                taskForm.reset();
            }

            // Add event listeners for Save buttons
            document.getElementById('add-unassigned').addEventListener('click', () => showTaskModal('unassigned'));
            document.getElementById('add-submitted').addEventListener('click', () => showTaskModal('submitted'));
            document.getElementById('add-progress').addEventListener('click', () => showTaskModal('progress'));
            document.getElementById('add-done').addEventListener('click', () => showTaskModal('done'));
            document.getElementById('add-tosubmit').addEventListener('click', () => showTaskModal('tosubmit'));

            // Close modal event listeners
            closeModal.addEventListener('click', hideTaskModal);
            cancelTask.addEventListener('click', hideTaskModal);

            // Handle form submission
            taskForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                // Capture form data before hiding modal
                const taskId = document.getElementById('task-id').value;
                const isNewTask = !taskId;
                const currentTime = new Date().toISOString();

                const taskData = {
                    id: taskId || Date.now().toString(),
                    ticketNumber: document.getElementById('task-ticket-number').value,
                    description: document.getElementById('task-description').value,
                    ticketType: document.getElementById('task-ticket-type').value,
                    priority: document.getElementById('task-priority').value,
                    assignedTo: document.getElementById('task-assigned-to').value,
                    assignedBy: document.getElementById('task-assigned-by').value,
                    teamInCharge: document.getElementById('task-team-in-charge').value,
                    submissionDate: document.getElementById('task-submission-date').value,
                    column: document.getElementById('form-column').value,
                    createdAt: isNewTask ? currentTime : undefined,
                    updatedAt: currentTime
                };

                // Hide modal first
                hideTaskModal();

                try {
                    // Get existing tasks
                    const tasks = await fetchTasks();

                    // Add new task or update existing one
                    const taskIndex = tasks.findIndex(t => t.id === taskData.id);
                    if (taskIndex !== -1) {
                        // Update existing task
                        const existingTask = tasks[taskIndex];

                        // Preserve creation date and lifecycle
                        taskData.createdAt = existingTask.createdAt;
                        taskData.lifecycle = existingTask.lifecycle || [];

                        // Add lifecycle entry for edit
                        const lifecycleEntry = {
                            id: `lc_${Date.now()}`,
                            timestamp: taskData.updatedAt,
                            fromStatus: existingTask.column,
                            toStatus: taskData.column,
                            updateType: 'other',
                            comments: 'Task details updated',
                            updatedBy: taskData.assignedBy || taskData.assignedTo || 'Unknown'
                        };
                        taskData.lifecycle.push(lifecycleEntry);

                        tasks[taskIndex] = taskData;
                    } else {
                        // New task - initialize lifecycle
                        taskData.lifecycle = [{
                            id: `lc_${Date.now()}`,
                            timestamp: taskData.createdAt,
                            fromStatus: null,
                            toStatus: taskData.column,
                            updateType: 'creation',
                            comments: 'Task created',
                            updatedBy: taskData.assignedBy || taskData.assignedTo || 'Unknown'
                        }];
                        tasks.push(taskData);
                    }

                    // Save updated tasks without showing notification
                    await saveTasks(tasks, false);

                    // Update UI without showing notification
                    await loadTasksFromConfluence(false);

                    // Show single success notification
                    showNotification('Success', 'Task saved successfully', 'notification');
                } catch (error) {
                    console.error('Error saving task:', error);
                    showNotification('Error', 'Error saving task. Please try again.', 'error');
                }
            });

            // Update task counters initially
            updateTaskCounters();

            // Metrics and Charts functionality
            let charts = {};

            // Real function to update metrics (will be registered with the stub system)
            async function updateMetricsReal(showNotifications = true) {
                try {
                    console.log('Starting metrics update...');

                    // Check if ApexCharts is loaded
                    if (typeof ApexCharts === 'undefined') {
                        console.error('ApexCharts library not loaded');
                        alert('ApexCharts library not loaded!');
                        throw new Error('ApexCharts library not available');
                    }
                    console.log('ApexCharts library is available');

                    const tasks = await fetchTasks();
                    console.log('Fetched tasks for metrics:', tasks);
                    console.log('Number of tasks loaded:', tasks.length);

                    // Debug: Show a visible indication that metrics update was called
                    if (showNotifications) {
                        console.log(`Metrics update called with ${tasks.length} tasks. ApexCharts available: ${typeof ApexCharts !== 'undefined'}`);
                    }

                    if (!tasks) {
                        console.error('Tasks is null or undefined');
                        throw new Error('No tasks data received');
                    }

                    // Update summary cards
                    const totalTasksElement = document.getElementById('total-tasks-metric');
                    const completedTasksElement = document.getElementById('completed-tasks-metric');
                    const progressTasksElement = document.getElementById('progress-tasks-metric');
                    const overdueTasksElement = document.getElementById('overdue-tasks-metric');

                    if (totalTasksElement) totalTasksElement.textContent = tasks.length;
                    if (completedTasksElement) completedTasksElement.textContent = tasks.filter(t => t.column === 'done').length;
                    if (progressTasksElement) progressTasksElement.textContent = tasks.filter(t => t.column === 'progress').length;

                    // Calculate overdue tasks (tasks pending more than 30 days)
                    const overdueTasks = tasks.filter(task => {
                        const submissionDate = new Date(task.submissionDate || task.createdAt || Date.now());
                        const today = new Date();
                        const daysPending = Math.floor((today - submissionDate) / (1000 * 60 * 60 * 24));
                        return daysPending > 30 && task.column !== 'done';
                    });
                    if (overdueTasksElement) overdueTasksElement.textContent = overdueTasks.length;

                    console.log('Summary cards updated:', {
                        total: tasks.length,
                        completed: tasks.filter(t => t.column === 'done').length,
                        progress: tasks.filter(t => t.column === 'progress').length,
                        overdue: overdueTasks.length
                    });

                    // Update charts only if containers exist and there are tasks
                    if (tasks.length === 0) {
                        console.log('No tasks found, showing empty state');
                        // Handle empty state for available charts only
                        updateStatusChart([]);
                        updatePriorityChart([]);

                        // Show message for no data only if notifications are enabled
                        if (showNotifications) {
                            showNotification('Info', 'No task data available for metrics visualization', 'message');
                        }

                        // Update metrics table with empty data
                        updateMetricsTable([]);
                    } else {
                        console.log('Updating charts with', tasks.length, 'tasks');
                        // Update charts with actual data (only existing charts)
                        updateStatusChart(tasks);
                        updatePriorityChart(tasks);

                        // Show success message for data loaded only if notifications are enabled
                        if (showNotifications) {
                            showNotification('Success', `Metrics updated successfully with ${tasks.length} tasks`, 'notification');
                        }

                        // Update metrics table
                        updateMetricsTable(tasks);
                    }

                    console.log('Metrics update completed successfully');
                } catch (error) {
                    console.error('Error updating metrics:', error);

                    // Set all metrics to 0 on error
                    const totalTasksElement = document.getElementById('total-tasks-metric');
                    const completedTasksElement = document.getElementById('completed-tasks-metric');
                    const progressTasksElement = document.getElementById('progress-tasks-metric');
                    const overdueTasksElement = document.getElementById('overdue-tasks-metric');

                    if (totalTasksElement) totalTasksElement.textContent = '0';
                    if (completedTasksElement) completedTasksElement.textContent = '0';
                    if (progressTasksElement) progressTasksElement.textContent = '0';
                    if (overdueTasksElement) overdueTasksElement.textContent = '0';

                    // Show empty charts (only existing charts)
                    updateStatusChart([]);
                    updatePriorityChart([]);
                    updateMetricsTable([]);

                    if (showNotifications) {
                        showNotification('Error', `Error updating metrics: ${error.message}. Please check if data is available.`, 'error');
                    }
                }
            }

            // Register the real updateMetrics function with the stub system
            registerRealUpdateMetrics(updateMetricsReal);

            // Status Distribution Chart
            function updateStatusChart(tasks) {
                try {
                    console.log('updateStatusChart called with tasks:', tasks ? tasks.length : 'null');
                    const chartElement = document.getElementById('statusChart');
                    console.log('statusChart element found:', !!chartElement);

                    if (!chartElement) {
                        console.debug('Status chart element not found');
                        return;
                    }

                    if (window.statusChart && typeof window.statusChart.destroy === 'function') {
                        window.statusChart.destroy();
                        console.log('Previous statusChart destroyed');
                    }

                    if (!tasks || tasks.length === 0) {
                        console.log('Creating empty status chart');
                        const options = {
                            series: [1],
                            chart: {
                                type: 'donut',
                                height: 300
                            },
                            labels: ['No Data'],
                            colors: ['#e0e0e0'],
                            legend: {
                                show: false
                            },
                            tooltip: {
                                enabled: false
                            }
                        };
                        window.statusChart = new ApexCharts(chartElement, options);
                        window.statusChart.render();
                        console.log('Empty status chart rendered');
                        return;
                    }

                    const statusCounts = {
                        'unassigned': 0,
                        'submitted': 0,
                        'progress': 0,
                        'done': 0,
                        'tosubmit': 0
                    };

                    tasks.forEach(task => {
                        if (statusCounts.hasOwnProperty(task.column)) {
                            statusCounts[task.column]++;
                        }
                    });

                    console.log('Status counts calculated:', statusCounts);

                    const options = {
                        series: [statusCounts.unassigned, statusCounts.submitted, statusCounts.progress, statusCounts.done, statusCounts.tosubmit],
                        chart: {
                            type: 'donut',
                            height: 300,
                            fontFamily: 'Outfit, sans-serif',
                            toolbar: {
                                show: false
                            }
                        },
                        labels: ['Unassigned', 'Submitted', 'In Progress', 'Done', 'To Submit'],
                        colors: ['#9CA3AF', '#EAB308', '#3B82F6', '#10B981', '#8B5CF6'],
                        legend: {
                            position: 'bottom',
                            fontFamily: 'Outfit, sans-serif',
                            fontSize: '14px',
                            fontWeight: 500,
                            labels: {
                                colors: ['#374151', '#374151', '#374151', '#374151', '#374151']
                            }
                        },
                        plotOptions: {
                            pie: {
                                donut: {
                                    size: '70%',
                                    labels: {
                                        show: true,
                                        name: {
                                            show: true,
                                            fontSize: '16px',
                                            fontFamily: 'Outfit, sans-serif',
                                            fontWeight: 600,
                                            color: '#374151'
                                        },
                                        value: {
                                            show: true,
                                            fontSize: '24px',
                                            fontFamily: 'Outfit, sans-serif',
                                            fontWeight: 700,
                                            color: '#111827'
                                        },
                                        total: {
                                            show: true,
                                            fontSize: '16px',
                                            fontFamily: 'Outfit, sans-serif',
                                            fontWeight: 600,
                                            color: '#374151'
                                        }
                                    }
                                }
                            }
                        },
                        dataLabels: {
                            enabled: false
                        },
                        tooltip: {
                            style: {
                                fontFamily: 'Outfit, sans-serif'
                            }
                        },
                        responsive: [{
                            breakpoint: 480,
                            options: {
                                chart: {
                                    width: 200
                                },
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }]
                    };

                    window.statusChart = new ApexCharts(chartElement, options);
                    window.statusChart.render();
                    console.log('Status chart with data rendered successfully');
                } catch (error) {
                    console.error('Error updating status chart:', error);
                    showNotification('Error', 'Error updating status chart', 'error');
                }
            }

            // Priority Distribution Chart
            function updatePriorityChart(tasks) {
                try {
                    console.log('updatePriorityChart called with tasks:', tasks ? tasks.length : 'null');
                    const chartElement = document.getElementById('priorityChart');
                    console.log('priorityChart element found:', !!chartElement);

                    if (!chartElement) {
                        console.debug('Priority chart element not found');
                        return;
                    }

                    if (window.priorityChart && typeof window.priorityChart.destroy === 'function') {
                        window.priorityChart.destroy();
                        console.log('Previous priorityChart destroyed');
                    }

                    if (!tasks || tasks.length === 0) {
                        const options = {
                            series: [{
                                name: 'Tasks',
                                data: [0]
                            }],
                            chart: {
                                type: 'bar',
                                height: 300,
                                fontFamily: 'Outfit, sans-serif',
                                toolbar: {
                                    show: false
                                }
                            },
                            plotOptions: {
                                bar: {
                                    borderRadius: 8,
                                    columnWidth: '60%',
                                    distributed: false
                                }
                            },
                            dataLabels: {
                                enabled: false
                            },
                            xaxis: {
                                categories: ['No Data'],
                                labels: {
                                    style: {
                                        fontFamily: 'Outfit, sans-serif',
                                        fontSize: '12px',
                                        fontWeight: 400,
                                        colors: ['#373d3f']
                                    }
                                },
                                axisBorder: {
                                    show: false
                                },
                                axisTicks: {
                                    show: false
                                }
                            },
                            yaxis: {
                                labels: {
                                    forceNiceScale: true,
                                    formatter: function (val) {
                                        return val.toFixed();
                                    },
                                    style: {
                                        fontFamily: 'Outfit, sans-serif',
                                        fontSize: '11px',
                                        fontWeight: 400,
                                        colors: ['#373d3f']
                                    }
                                }
                            },
                            colors: ['#465FFF'],
                            fill: {
                                type: 'gradient',
                                gradient: {
                                    shade: 'light',
                                    type: 'vertical',
                                    shadeIntensity: 0.25,
                                    gradientToColors: ['#A3AFFF'],
                                    inverseColors: true,
                                    opacityFrom: 1,
                                    opacityTo: 0.85,
                                    stops: [0, 100]
                                }
                            },
                            grid: {
                                borderColor: '#e0e0e0',
                                strokeDashArray: 0,
                                xaxis: {
                                    lines: {
                                        show: false
                                    }
                                },
                                yaxis: {
                                    lines: {
                                        show: true
                                    }
                                }
                            },
                            tooltip: {
                                style: {
                                    fontFamily: 'Outfit, sans-serif'
                                }
                            },
                            legend: {
                                show: false
                            }
                        };
                        window.priorityChart = new ApexCharts(chartElement, options);
                        window.priorityChart.render();
                        return;
                    }

                    const priorityCounts = {
                        '1': 0,
                        '2': 0,
                        '3': 0,
                        '4': 0,
                        '5': 0
                    };

                    tasks.forEach(task => {
                        if (priorityCounts.hasOwnProperty(task.priority)) {
                            priorityCounts[task.priority]++;
                        }
                    });

                    const options = {
                        series: [{
                            name: 'Tasks',
                            data: [priorityCounts['1'], priorityCounts['2'], priorityCounts['3'], priorityCounts['4'], priorityCounts['5']]
                        }],
                        chart: {
                            type: 'bar',
                            height: 300,
                            fontFamily: 'Outfit, sans-serif',
                            toolbar: {
                                show: false
                            }
                        },
                        plotOptions: {
                            bar: {
                                borderRadius: 8,
                                columnWidth: '60%',
                                distributed: false
                            }
                        },
                        dataLabels: {
                            enabled: false
                        },
                        xaxis: {
                            categories: ['1 - Critical', '2 - High', '3 - Medium', '4 - Low', '5 - Lowest'],
                            labels: {
                                style: {
                                    fontFamily: 'Outfit, sans-serif',
                                    fontSize: '12px',
                                    fontWeight: 400,
                                    colors: ['#373d3f']
                                }
                            },
                            axisBorder: {
                                show: false
                            },
                            axisTicks: {
                                show: false
                            }
                        },
                        yaxis: {
                            labels: {
                                forceNiceScale: true,
                                formatter: function (val) {
                                    return val.toFixed();
                                },
                                style: {
                                    fontFamily: 'Outfit, sans-serif',
                                    fontSize: '11px',
                                    fontWeight: 400,
                                    colors: ['#373d3f']
                                }
                            }
                        },
                        colors: ['#465FFF'],
                        fill: {
                            type: 'gradient',
                            gradient: {
                                shade: 'light',
                                type: 'vertical',
                                shadeIntensity: 0.25,
                                gradientToColors: ['#A3AFFF'],
                                inverseColors: true,
                                opacityFrom: 1,
                                opacityTo: 0.85,
                                stops: [0, 100]
                            }
                        },
                        grid: {
                            borderColor: '#e0e0e0',
                            strokeDashArray: 0,
                            xaxis: {
                                lines: {
                                    show: false
                                }
                            },
                            yaxis: {
                                lines: {
                                    show: true
                                }
                            }
                        },
                        tooltip: {
                            style: {
                                fontFamily: 'Outfit, sans-serif'
                            }
                        },
                        legend: {
                            show: false
                        }
                    };

                    window.priorityChart = new ApexCharts(chartElement, options);
                    window.priorityChart.render();
                } catch (error) {
                    console.error('Error updating priority chart:', error);
                    showNotification('Error', 'Error updating priority chart', 'error');
                }
            }

            // Update metrics when tasks change
            const originalUpdateTaskCounters = updateTaskCounters;
            updateTaskCounters = function () {
                originalUpdateTaskCounters();
                // Only update metrics if metrics view is active
                try {
                    const alpineElement = document.querySelector('[x-data]');
                    if (alpineElement && alpineElement.__x && alpineElement.__x.$data && alpineElement.__x.$data.activeView === 'metrics') {
                        updateMetrics(); // This calls with showNotifications=true by default
                    }
                } catch (error) {
                    // Silently ignore Alpine.js access errors during initialization
                    console.debug('Alpine.js not ready for metrics update');
                }
            };

            const originalUpdateTableView = updateTableView;
            updateTableView = async function () {
                await originalUpdateTableView();
                // Only update metrics if metrics view is active
                try {
                    const alpineElement = document.querySelector('[x-data]');
                    if (alpineElement && alpineElement.__x && alpineElement.__x.$data && alpineElement.__x.$data.activeView === 'metrics') {
                        updateMetrics(); // This calls with showNotifications=true by default
                    }
                } catch (error) {
                    // Silently ignore Alpine.js access errors during initialization
                    console.debug('Alpine.js not ready for metrics update');
                }
            };

            // Add the missing updateMetricsTable function
            function updateMetricsTable(tasks) {
                try {
                    const metricsTableBody = document.getElementById('metrics-table-body');
                    if (!metricsTableBody) {
                        console.debug('Metrics table body not found');
                        return;
                    }

                    metricsTableBody.innerHTML = '';

                    if (!tasks || tasks.length === 0) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                        <td colspan="8" class="px-6 py-4 text-center text-gray-500">No tasks available</td>
                    `;
                        metricsTableBody.appendChild(row);
                        return;
                    }

                    // Calculate overdue tasks (30+ days old)
                    const today = new Date();
                    const thirtyDaysAgo = new Date(today);
                    thirtyDaysAgo.setDate(today.getDate() - 30);

                    const overdueTasks = tasks.filter(task => {
                        if (task.column === 'done') return false; // Skip completed tasks

                        const submissionDate = new Date(task.submissionDate || task.createdAt || Date.now());

                        // Task is overdue if it's older than 30 days
                        return submissionDate < thirtyDaysAgo;
                    }).sort((a, b) => {
                        // Sort by submission date (oldest first)
                        const dateA = new Date(a.submissionDate || a.createdAt);
                        const dateB = new Date(b.submissionDate || b.createdAt);
                        return dateA - dateB;
                    }).slice(0, 10); // Top 10 only

                    if (overdueTasks.length === 0) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                        <td colspan="8" class="px-6 py-4 text-center text-green-600">ðŸŽ‰ No overdue tickets! Great job!</td>
                    `;
                        metricsTableBody.appendChild(row);
                        return;
                    }

                    overdueTasks.forEach(task => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-red-50';

                        // Calculate days pending
                        const submissionDate = new Date(task.submissionDate || task.createdAt || Date.now());
                        const daysPending = Math.floor((today - submissionDate) / (1000 * 60 * 60 * 24));

                        row.innerHTML = `
                        <td class="px-6 py-4 !text-md font-medium text-gray-900">${task.ticketNumber || 'N/A'}</td>
                        <td class="px-6 py-4 !text-md text-gray-500">${task.assignedTo || 'Unassigned'}</td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-2 py-1 !text-md font-medium rounded-full ${getPriorityBadgeClass(task.priority)}">
                                ${getPriorityDisplayName(task.priority)}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-2 py-1 !text-md font-medium rounded-full ${getStatusBadgeClass(task.column)}">
                                ${getStatusDisplayName(task.column)}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-2 py-1 !text-md font-medium rounded-full ${getTicketTypeBadgeClass(task.ticketType)}">
                                ${getTicketTypeDisplayName(task.ticketType)}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-center !text-md text-gray-500">${getTeamDisplayName(task.teamInCharge)}</td>
                        <td class="px-6 py-4 text-center !text-md ${daysPending > 60 ? 'text-red-600 font-bold' : daysPending > 30 ? 'text-orange-600 font-medium' : 'text-gray-600'}">${daysPending}</td>
                        <td class="px-6 py-4 text-center !text-md text-gray-500">${formatDate(task.submissionDate || task.createdAt)}</td>
                    `;
                        metricsTableBody.appendChild(row);
                    });
                } catch (error) {
                    console.error('Error updating metrics table:', error);
                }
            }

            // Helper function to get tag badge class
            function getTagBadgeClass(tag) {
                switch (tag) {
                    case 'blue': return 'bg-blue-100 text-blue-800';     // New Development
                    case 'red': return 'bg-red-100 text-red-800';        // Bug
                    case 'purple': return 'bg-purple-100 text-purple-800'; // Design
                    case 'green': return 'bg-green-100 text-green-800';   // Enhancement
                    case 'yellow': return 'bg-yellow-100 text-yellow-800'; // Ad Hoc
                    default: return 'bg-gray-100 text-gray-800';
                }
            }

            // Enhanced chart initialization with better error handling
            function initializeCharts() {
                console.log('Initializing charts...');

                // Check if ApexCharts is available
                if (typeof ApexCharts === 'undefined') {
                    console.error('ApexCharts library not loaded');
                    setTimeout(initializeCharts, 1000); // Retry in 1 second
                    return;
                }

                console.log('ApexCharts library available, charts can be rendered');
            }

            // Initialize charts when DOM is ready
            document.addEventListener('DOMContentLoaded', function () {
                initializeCharts();
            });

            // Also try to initialize charts immediately if DOM is already ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeCharts);
            } else {
                initializeCharts();
            }

            // Initialize metrics when metrics tab is clicked
            // Removed the following event listener as it's redundant with the Alpine watcher
            /*
            document.addEventListener('click', function(e) {
                if (e.target.closest('button') && e.target.textContent.includes('Metrics')) {
            setTimeout(() => {
                updateMetrics(false);
                    }, 100);
                }
            });
            */

            // Also initialize metrics after initial data load with longer delay to ensure everything is ready
            setTimeout(() => {
                try {
                    const alpineElement = document.querySelector('[x-data]');
                    if (alpineElement && alpineElement.__x && alpineElement.__x.$data && alpineElement.__x.$data.activeView === 'metrics') {
                        console.log('Initial metrics check: activeView is metrics, updating with no notifications.');
                        updateMetrics(false); // Pass false to avoid redundant notifications
                    }
                } catch (error) {
                    console.debug('Alpine.js not ready for initial metrics update');
                }
            }, 3000); // Increased delay to 3 seconds

            // Helper function to create task card HTML
            function createTaskCardHTML(task) {
                // Calculate days pending
                const daysPending = task.submissionDate ?
                    Math.floor((new Date() - new Date(task.submissionDate)) / (1000 * 60 * 60 * 24)) : 0;

                // Get days pending color
                const getDaysPendingColor = (days) => {
                    if (days >= 30) return 'text-red-600 font-semibold';
                    if (days >= 14) return 'text-orange-600 font-medium';
                    return 'text-gray-600';
                };

                return `
                <div class="group bg-white rounded-lg p-4 mb-4 shadow-sm border border-gray-200 hover:shadow-md transition-shadow duration-200 cursor-pointer" 
                     style="min-height: 200px;" 
                     oncontextmenu="showTaskMenu(event, '${task.id}')" 
                     onclick="showTaskDetails('${task.id}')">
                    
                    <!-- Header with ticket number and action buttons -->
                    <div class="flex items-start justify-between mb-3">
                        <!-- Ticket Number -->
                        <div class="text-lg font-bold text-blue-600">
                            ${task.ticketNumber || 'N/A'}
                        </div>
                        
                        <!-- Action buttons -->
                        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="event.stopPropagation(); editTask('${task.id}')" class="p-1 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors" title="Edit">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <button onclick="event.stopPropagation(); viewLifecycleHistory('${task.id}')" class="p-1 text-gray-400 hover:text-green-600 hover:bg-green-50 rounded transition-colors" title="View History">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </button>
                            ${userPermissions && userPermissions.canDelete ? `
                            <button onclick="event.stopPropagation(); deleteTask('${task.id}')" class="p-1 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors" title="Delete">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1-1H9a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Tags Section -->
                    <div class="flex flex-wrap gap-2 mb-3">
                        <span class="inline-flex items-center px-2 py-1 !text-md font-medium rounded ${getTicketTypeBadgeClass(task.ticketType)}">
                            ${getTicketTypeDisplayName(task.ticketType)}
                        </span>
                        <span class="inline-flex items-center px-2 py-1 !text-md font-medium rounded ${getPriorityBadgeClass(task.priority)}">
                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M3 6a3 3 0 013-3h10a1 1 0 01.8 1.6L14.25 8l2.55 3.4A1 1 0 0116 13H6a3 3 0 01-3-3V6z" clip-rule="evenodd"></path>
                            </svg>
                            ${getPriorityDisplayName(task.priority)}
                        </span>
                        <span class="inline-flex items-center px-2 py-1 !text-md font-medium rounded bg-purple-100 text-purple-700">
                            ${getTeamDisplayName(task.teamInCharge)}
                        </span>
                    </div>
                    
                    <!-- Description -->
                    <p class="!text-md text-gray-600 mb-4 leading-5 line-clamp-3">${task.description || 'No description available'}</p>

                    <!-- Bottom section with assigned user on top and days pending below -->
<div class="flex flex-col items-start space-y-1">
    <!-- Assigned user badge -->
    <div class="inline-flex items-center px-2 py-1 rounded-full !text-md font-medium bg-blue-100 text-blue-700">
        ${task.assignedTo || 'Unassigned'}
    </div>

    <!-- Days pending -->
    <div class="flex items-center !text-md ${getDaysPendingColor(daysPending)}">
        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        ${daysPending} days pending
    </div>
</div>
            `;
            }

            // Helper function to get tag name
            function getTagName(tag) {
                const tagNames = {
                    blue: 'New Development',
                    red: 'Bug',
                    purple: 'Design',
                    green: 'Enhancement',
                    yellow: 'Ad Hoc'
                };
                return tagNames[tag] || 'Other';
            }

            // Helper function to get status color
            function getStatusColor(status) {
                const statusColors = {
                    'unassigned': 'bg-gray-100 text-gray-800',
                    'submitted': 'bg-yellow-100 text-yellow-800',
                    'progress': 'bg-blue-100 text-blue-800',
                    'done': 'bg-green-100 text-green-800',
                    'tosubmit': 'bg-purple-100 text-purple-800'
                };
                return statusColors[status] || 'bg-gray-100 text-gray-800';
            }

            // Helper function to calculate days until deadline
            function getDaysUntilDeadline(dueDate) {
                if (!dueDate) return 'No deadline';

                const today = new Date();
                const deadline = new Date(dueDate);
                const timeDiff = deadline.getTime() - today.getTime();
                const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));

                if (daysDiff < 0) {
                    const overdueDays = Math.abs(daysDiff);
                    return overdueDays === 1 ? '1 day overdue' : `${overdueDays} days overdue`;
                } else if (daysDiff === 0) {
                    return 'Today';
                } else if (daysDiff === 1) {
                    return '1 day';
                } else {
                    return `${daysDiff} days`;
                }
            }

            // Helper function to get color based on days until deadline
            function getDaysUntilDeadlineColor(dueDate) {
                if (!dueDate) return 'text-gray-500';

                const today = new Date();
                const deadline = new Date(dueDate);
                const timeDiff = deadline.getTime() - today.getTime();
                const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));

                if (daysDiff < 0) {
                    return 'text-red-600'; // Overdue
                } else if (daysDiff <= 13) {
                    return 'text-red-600'; // 0-13 days - red
                } else if (daysDiff <= 30) {
                    return 'text-amber-600'; // 14-30 days - amber
                } else {
                    return 'text-green-600'; // >30 days - green
                }
            }

            // Helper function to format date
            function formatDate(dateString) {
                if (!dateString) return 'No date';
                const date = new Date(dateString);
                return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            }

            // Helper function to update task counters
            function updateTaskCounters() {
                const columns = ['unassigned', 'submitted', 'progress', 'done', 'tosubmit'];
                columns.forEach(column => {
                    const columnElement = document.getElementById(`${column}-column`);
                    const counter = columnElement.parentElement.querySelector('.task-counter');
                    const taskCount = columnElement.children.length;
                    counter.textContent = taskCount;
                });
            }

            // Helper function to update table view
            async function updateTableView() {
                if (isUpdatingTable) {
                    console.log('Table update already in progress, skipping...');
                    return;
                }

                isUpdatingTable = true;
                const tableBody = document.getElementById('table-body');

                try {
                    console.log('Updating table view...');
                    tableBody.innerHTML = '';

                    const tasks = await fetchTasks();

                    if (!tasks || tasks.length === 0) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                        <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                            <div class="flex flex-col items-center py-8">
                                <svg class="w-12 h-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                </svg>
                                <p class="text-lg font-medium text-gray-900">No tasks available</p>
                                <p class="!text-md text-gray-500">Create your first task to get started</p>
                            </div>
                        </td>
                    `;
                        tableBody.appendChild(row);
                        return;
                    }

                    tasks.forEach(task => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50';

                        // Calculate days pending
                        const submissionDate = new Date(task.submissionDate || task.createdAt || Date.now());
                        const today = new Date();
                        const daysPending = Math.floor((today - submissionDate) / (1000 * 60 * 60 * 24));

                        row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap !text-md font-medium text-gray-900">${task.ticketNumber || 'N/A'}</td>
                        <td class="px-6 py-4 !text-md text-gray-500" style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${task.description || 'N/A'}</td>
                        <td class="px-6 py-4 whitespace-nowrap !text-md text-gray-500">${getTicketTypeDisplayName(task.ticketType)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex !text-md leading-5 font-semibold rounded-full ${getPriorityBadgeClass(task.priority)}">
                                ${getPriorityDisplayName(task.priority)}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex !text-md leading-5 font-semibold rounded-full ${getStatusBadgeClass(task.column)}">
                                ${getStatusDisplayName(task.column)}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap !text-md text-gray-500">${task.assignedTo || 'Unassigned'}</td>
                        <td class="px-6 py-4 whitespace-nowrap !text-md text-gray-500">${getTeamDisplayName(task.teamInCharge)}</td>
                        <td class="px-6 py-4 whitespace-nowrap !text-md ${daysPending > 30 ? 'text-red-600 font-bold' : daysPending > 14 ? 'text-orange-600 font-medium' : 'text-gray-600'}">${daysPending}</td>
                        <td class="px-6 py-4 whitespace-nowrap !text-md font-medium">
                            <button onclick="editTask('${task.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2">Edit</button>
                            <button onclick="viewLifecycleHistory('${task.id}')" class="text-blue-600 hover:text-blue-900 mr-2">History</button>
                            ${userPermissions && userPermissions.canDelete ? `<button onclick="deleteTask('${task.id}')" class="text-red-600 hover:text-red-900">Delete</button>` : ''}
                        </td>
                    `;
                        tableBody.appendChild(row);
                    });

                    // Reapply search filter if one is active
                    if (typeof applySearchFilter === 'function') {
                        applySearchFilter();
                    }
                } catch (error) {
                    console.error('Error loading table data:', error);
                } finally {
                    isUpdatingTable = false;
                }
            }

            // Helper function to get all tasks from DOM
            function getAllTasksFromDOM() {
                const tasks = [];
                const columns = ['todo', 'progress', 'review', 'done'];

                columns.forEach(column => {
                    const columnElement = document.getElementById(`${column}-column`);
                    const taskCards = columnElement.querySelectorAll('.task-card');

                    taskCards.forEach(card => {
                        const task = {
                            id: card.dataset.id,
                            title: card.querySelector('h3').textContent,
                            description: card.querySelector('p').textContent,
                            tag: getTagFromCard(card),
                            priority: card.dataset.priority,
                            assignedUser: card.dataset.assignedUser,
                            submittedBy: card.dataset.submittedBy,
                            startDate: card.dataset.startDate,
                            dueDate: card.dataset.dueDate,
                            column: column
                        };
                        tasks.push(task);
                    });
                });

                return tasks;
            }

            // Helper function to get tag from card
            function getTagFromCard(card) {
                const tagSpan = card.querySelector('span');
                const tagText = tagSpan.textContent;
                const tagMap = {
                    'New Development': 'blue',
                    'Bug': 'red',
                    'Design': 'purple',
                    'Enhancement': 'green',
                    'Ad Hoc': 'yellow'
                };
                return tagMap[tagText] || 'blue';
            }

            // Task menu functions
            function toggleTaskMenu(taskId) {
                const menu = document.getElementById(`menu-${taskId}`);
                // Close all other menus first
                document.querySelectorAll('[id^="menu-"]').forEach(m => {
                    if (m.id !== `menu-${taskId}`) {
                        m.classList.add('hidden');
                    }
                });
                menu.classList.toggle('hidden');
            }

            // Edit task function
            async function editTask(taskId) {
                const taskCard = document.querySelector(`[data-id="${taskId}"]`);
                if (!taskCard) return;

                try {
                    // Get task data from server to get complete task info
                    const tasks = await fetchTasks();
                    const task = tasks.find(t => t.id === taskId);

                    if (!task) {
                        showNotification('Error', 'Task not found', 'error');
                        return;
                    }

                    // Populate form with existing data from the task object
                    document.getElementById('task-id').value = taskId;
                    document.getElementById('task-ticket-number').value = task.ticketNumber || '';
                    document.getElementById('task-description').value = task.description || '';
                    document.getElementById('task-ticket-type').value = task.ticketType || '';
                    document.getElementById('task-priority').value = task.priority || '';
                    document.getElementById('task-assigned-to').value = task.assignedTo || '';
                    document.getElementById('task-assigned-by').value = task.assignedBy || '';
                    document.getElementById('task-team-in-charge').value = task.teamInCharge || '';
                    document.getElementById('task-submission-date').value = task.submissionDate || '';
                    document.getElementById('form-column').value = task.column || 'unassigned';

                    // Update days pending display
                    const daysPendingDisplay = document.getElementById('days-pending-display');
                    if (daysPendingDisplay && task.submissionDate) {
                        const submissionDate = new Date(task.submissionDate);
                        const today = new Date();
                        const daysPending = Math.floor((today - submissionDate) / (1000 * 60 * 60 * 24));
                        daysPendingDisplay.textContent = `${daysPending} days`;
                    }

                    // Show modal
                    document.getElementById('task-modal').classList.remove('hidden');

                    // Hide menu if it exists
                    const menuElement = document.getElementById(`menu-${taskId}`);
                    if (menuElement) {
                        menuElement.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Error loading task data for editing:', error);
                    showNotification('Error', 'Error loading task data', 'error');
                }
            }

            // Make editTask globally accessible
            window.editTask = editTask;

            // Delete task function
            async function deleteTask(taskId) {
                console.log('deleteTask called for:', taskId);

                // Check if user has permission to delete
                if (!canUserDelete()) {
                    showNotification('Permission Denied', 'Only admin users can delete tasks', 'error');
                    return;
                }

                // Hide menu first
                const menuElement = document.getElementById(`menu-${taskId}`);
                if (menuElement) {
                    menuElement.classList.add('hidden');
                }

                if (confirm('Are you sure you want to delete this task?')) {
                    try {
                        // First, immediately remove the task card from the UI for instant feedback
                        const taskCard = document.querySelector(`[data-id="${taskId}"]`);
                        if (taskCard) {
                            console.log('Removing task card from UI:', taskId);
                            taskCard.remove();
                            updateTaskCounters(); // Update counters immediately
                        }

                        // Then update the server data
                        console.log('Updating server data...');
                        const tasks = await fetchTasks();
                        const taskToDelete = tasks.find(task => task.id === taskId);

                        if (!taskToDelete) {
                            console.warn('Task not found in server data:', taskId);
                            showNotification('Warning', 'Task was removed from view but may not exist on server', 'error');
                            return;
                        }

                        const updatedTasks = tasks.filter(task => task.id !== taskId);
                        await saveTasks(updatedTasks, false);

                        // Update table view if we're in table view
                        await updateTableView();

                        console.log('Task deleted successfully:', taskId);
                        showNotification('Success', 'Task deleted successfully', 'success');
                    } catch (error) {
                        console.error('Error deleting task:', error);

                        // If there was an error, we should reload to make sure UI is in sync
                        console.log('Error occurred, reloading tasks to ensure UI sync...');
                        await loadTasksFromConfluence(false);

                        showNotification('Error', 'Error deleting task. Please try again.', 'error');
                    }
                }
            }

            // Make deleteTask globally accessible
            window.deleteTask = deleteTask;

            // Export to Excel function
            document.getElementById('export-excel').addEventListener('click', async function () {
                try {
                    // Get complete task data from server including lifecycle
                    const tasks = await fetchTasks();

                    // Prepare tasks data for export
                    const exportData = tasks.map(task => {
                        // Format lifecycle data as a readable string
                        let lifecycleHistory = '';
                        if (task.lifecycle && task.lifecycle.length > 0) {
                            lifecycleHistory = task.lifecycle.map(entry => {
                                const fromStatus = entry.fromStatus ? getStatusDisplayName(entry.fromStatus) : 'Created';
                                const toStatus = getStatusDisplayName(entry.toStatus);
                                const timestamp = formatDateTime(entry.timestamp);
                                return `${timestamp}: ${entry.updatedBy} - ${fromStatus} â†’ ${toStatus} (${entry.updateType}) - ${entry.comments}`;
                            }).join('\n');
                        }

                        return {
                            'Task ID': task.id,
                            'Ticket Number': task.ticketNumber,
                            'Issue Description': task.description,
                            'Ticket Type': getTicketTypeDisplayName(task.ticketType),
                            'Priority': getPriorityDisplayName(task.priority),
                            'Assigned To': task.assignedTo || 'Unassigned',
                            'Assigned By': task.assignedBy || 'Unknown',
                            'Team in Charge': getTeamDisplayName(task.teamInCharge),
                            'Submission Date': task.submissionDate || 'Not set',
                            'Current Status': getStatusDisplayName(task.column),
                            'Days Pending': (() => {
                                const submissionDate = new Date(task.submissionDate || task.createdAt || Date.now());
                                const today = new Date();
                                return Math.floor((today - submissionDate) / (1000 * 60 * 60 * 24));
                            })(),
                            'Created At': formatDateTime(task.createdAt),
                            'Last Updated': formatDateTime(task.updatedAt),
                            'Lifecycle History': lifecycleHistory
                        };
                    });

                    // Create workbook with tasks
                    const ws = XLSX.utils.json_to_sheet(exportData);

                    // Auto-size columns
                    const colWidths = [
                        { wch: 15 }, // Task ID
                        { wch: 20 }, // Ticket Number
                        { wch: 40 }, // Issue Description
                        { wch: 15 }, // Ticket Type
                        { wch: 15 }, // Priority
                        { wch: 15 }, // Assigned To
                        { wch: 15 }, // Assigned By
                        { wch: 15 }, // Team in Charge
                        { wch: 12 }, // Submission Date
                        { wch: 15 }, // Current Status
                        { wch: 12 }, // Days Pending
                        { wch: 20 }, // Created At
                        { wch: 20 }, // Last Updated
                        { wch: 60 }  // Lifecycle History
                    ];
                    ws['!cols'] = colWidths;

                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Tasks");

                    // Create a separate sheet for detailed lifecycle data
                    if (tasks.some(task => task.lifecycle && task.lifecycle.length > 0)) {
                        const lifecycleData = [];
                        tasks.forEach(task => {
                            if (task.lifecycle && task.lifecycle.length > 0) {
                                task.lifecycle.forEach(entry => {
                                    lifecycleData.push({
                                        'Task ID': task.id,
                                        'Ticket Number': task.ticketNumber,
                                        'Timestamp': formatDateTime(entry.timestamp),
                                        'Updated By': entry.updatedBy,
                                        'From Status': entry.fromStatus ? getStatusDisplayName(entry.fromStatus) : 'Created',
                                        'To Status': getStatusDisplayName(entry.toStatus),
                                        'Update Type': entry.updateType,
                                        'Comments': entry.comments
                                    });
                                });
                            }
                        });

                        if (lifecycleData.length > 0) {
                            const lifecycleWs = XLSX.utils.json_to_sheet(lifecycleData);
                            const lifecycleColWidths = [
                                { wch: 15 }, // Task ID
                                { wch: 20 }, // Ticket Number
                                { wch: 20 }, // Timestamp
                                { wch: 15 }, // Updated By
                                { wch: 15 }, // From Status
                                { wch: 15 }, // To Status
                                { wch: 15 }, // Update Type
                                { wch: 50 }  // Comments
                            ];
                            lifecycleWs['!cols'] = lifecycleColWidths;
                            XLSX.utils.book_append_sheet(wb, lifecycleWs, "Lifecycle History");
                        }
                    }

                    XLSX.writeFile(wb, "kanban_tasks_with_lifecycle.xlsx");
                    showNotification('Success', 'Tasks exported to Excel with lifecycle data successfully', 'notification');
                } catch (error) {
                    console.error('Error exporting to Excel:', error);
                    showNotification('Error', 'Error exporting tasks. Please try again.', 'error');
                }
            });

            // Lifecycle Modal Functions
            const lifecycleModal = document.getElementById('lifecycle-modal');
            const lifecycleForm = document.getElementById('lifecycle-form');
            const closeLifecycleModal = document.getElementById('close-lifecycle-modal');
            const cancelLifecycle = document.getElementById('cancel-lifecycle');

            let pendingTaskMove = null; // Store pending move data

            function showLifecycleModal(taskId, fromStatus, toStatus, taskElement) {
                console.log('showLifecycleModal called:', { taskId, fromStatus, toStatus });
                
                // Get task title from ticket number instead
                const ticketNumberElement = taskElement.querySelector('.text-lg.font-bold');
                const taskTitle = ticketNumberElement ? ticketNumberElement.textContent : `Task ${taskId}`;
                console.log('Task title found:', taskTitle);

                // Store pending move data
                pendingTaskMove = {
                    taskId: taskId,
                    fromStatus: fromStatus,
                    toStatus: toStatus,
                    taskElement: taskElement
                };

                // Populate modal
                document.getElementById('lifecycle-task-id').value = taskId;
                document.getElementById('lifecycle-new-column').value = toStatus;
                document.getElementById('lifecycle-task-title').textContent = taskTitle;
                document.getElementById('lifecycle-from-status').textContent = getStatusDisplayName(fromStatus);
                document.getElementById('lifecycle-to-status').textContent = getStatusDisplayName(toStatus);

                console.log('Modal populated with:', {
                    title: taskTitle,
                    from: getStatusDisplayName(fromStatus),
                    to: getStatusDisplayName(toStatus)
                });

                // Reset form
                lifecycleForm.reset();
                document.getElementById('lifecycle-task-id').value = taskId;
                document.getElementById('lifecycle-new-column').value = toStatus;

                // Show modal
                lifecycleModal.classList.remove('hidden');
                console.log('Lifecycle modal should now be visible');
            }

            function hideLifecycleModal() {
                lifecycleModal.classList.add('hidden');
                lifecycleForm.reset();

                // If there's a pending move and user cancels, revert the move
                if (pendingTaskMove) {
                    const { taskElement, fromStatus } = pendingTaskMove;
                    const originalColumn = document.getElementById(`${fromStatus}-column`);
                    originalColumn.appendChild(taskElement);
                    updateTaskCounters();
                    pendingTaskMove = null;
                }
            }

            function getStatusDisplayName(status) {
                const statusNames = {
                    'unassigned': 'Unassigned',
                    'submitted': 'Submitted',
                    'progress': 'In Progress',
                    'done': 'Done',
                    'tosubmit': 'To Submit'
                };
                return statusNames[status] || status;
            }

            // Close lifecycle modal event listeners
            closeLifecycleModal.addEventListener('click', hideLifecycleModal);
            cancelLifecycle.addEventListener('click', hideLifecycleModal);

            // Handle lifecycle form submission
            lifecycleForm.addEventListener('submit', async function (e) {
                e.preventDefault();

                if (!pendingTaskMove) return;

                const { taskId, fromStatus, toStatus } = pendingTaskMove;

                const lifecycleData = {
                    updateType: document.getElementById('lifecycle-update-type').value,
                    comments: document.getElementById('lifecycle-comments').value,
                    updatedBy: document.getElementById('lifecycle-updated-by').value,
                    timestamp: new Date().toISOString(),
                    fromStatus: fromStatus,
                    toStatus: toStatus
                };

                try {
                    // Hide modal first
                    lifecycleModal.classList.add('hidden');

                    // Get existing tasks
                    const tasks = await fetchTasks();

                    // Find and update the task
                    const taskIndex = tasks.findIndex(task => task.id === taskId);
                    if (taskIndex !== -1) {
                        const task = tasks[taskIndex];

                        // Update task column and timestamp
                        task.column = toStatus;
                        task.updatedAt = lifecycleData.timestamp;

                        // Add lifecycle entry
                        if (!task.lifecycle) {
                            task.lifecycle = [];
                        }

                        const lifecycleEntry = {
                            id: `lc_${Date.now()}`,
                            timestamp: lifecycleData.timestamp,
                            fromStatus: lifecycleData.fromStatus,
                            toStatus: lifecycleData.toStatus,
                            updateType: lifecycleData.updateType,
                            comments: lifecycleData.comments,
                            updatedBy: lifecycleData.updatedBy
                        };

                        task.lifecycle.push(lifecycleEntry);

                        // Save updated tasks
                        await saveTasks(tasks, false);

                        // Update UI
                        updateTaskCounters();
                        await updateTableView();

                        // Clear pending move
                        pendingTaskMove = null;

                        showNotification('Success', 'Task status updated successfully', 'notification');
                    }
                } catch (error) {
                    console.error('Error updating task lifecycle:', error);
                    showNotification('Error', 'Error updating task status. Please try again.', 'error');

                    // Revert the move on error
                    if (pendingTaskMove) {
                        const { taskElement, fromStatus } = pendingTaskMove;
                        const originalColumn = document.getElementById(`${fromStatus}-column`);
                        originalColumn.appendChild(taskElement);
                        updateTaskCounters();
                        pendingTaskMove = null;
                    }
                }
            });

            // Update task counters initially
            updateTaskCounters();

            // Lifecycle History Functions
            const lifecycleHistoryModal = document.getElementById('lifecycle-history-modal');
            const closeHistoryModal = document.getElementById('close-history-modal');

            closeHistoryModal.addEventListener('click', function () {
                lifecycleHistoryModal.classList.add('hidden');
            });

            // Function to create a single timeline entry for lifecycle history
            function createTimelineEntry(entry, isLastEntry = false) {
                const li = document.createElement('li');
                li.className = `mb-8 ms-6 ${isLastEntry ? '' : 'pb-4'}`; // Added padding-bottom for spacing, remove for last

                const iconContainer = document.createElement('span');
                iconContainer.className = 'absolute flex items-center justify-center w-8 h-8 bg-blue-100 rounded-full -start-4 ring-4 ring-white';

                const iconSVG = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                iconSVG.setAttribute('class', 'w-4 h-4 text-blue-600');
                iconSVG.setAttribute('fill', 'currentColor');
                iconSVG.setAttribute('viewBox', '0 0 20 20');
                iconSVG.innerHTML = '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.415L11 9.586V6z" clip-rule="evenodd"></path>';
                iconContainer.appendChild(iconSVG);
                li.appendChild(iconContainer);

                const time = document.createElement('time');
                time.className = 'block mb-1 !text-md font-normal leading-none text-gray-500';
                time.textContent = formatDateTime(entry.timestamp); // Assuming formatDateTime exists
                li.appendChild(time);

                const title = document.createElement('h3');
                title.className = 'text-lg font-semibold text-gray-900';
                let statusChange = 'Status Updated';
                if (entry.fromStatus && entry.toStatus) {
                    statusChange = `${getStatusDisplayName(entry.fromStatus)} â†’ ${getStatusDisplayName(entry.toStatus)}`;
                } else if (entry.toStatus) {
                    statusChange = `Created & Moved to ${getStatusDisplayName(entry.toStatus)}`;
                }
                title.textContent = statusChange;
                li.appendChild(title);

                if (entry.updateType) {
                    const typePara = document.createElement('p');
                    typePara.className = '!text-md font-normal text-gray-600';
                    typePara.textContent = `Type: ${entry.updateType.charAt(0).toUpperCase() + entry.updateType.slice(1)}`;
                    li.appendChild(typePara);
                }

                if (entry.comments) {
                    const commentPara = document.createElement('p');
                    commentPara.className = 'mt-1 !text-md font-normal text-gray-600 bg-gray-50 p-2 rounded-md';
                    commentPara.textContent = entry.comments;
                    li.appendChild(commentPara);
                }

                if (entry.updatedBy) {
                    const userPara = document.createElement('p');
                    userPara.className = 'mt-2 !text-md font-medium text-gray-500';
                    userPara.textContent = `Updated by: ${entry.updatedBy}`;
                    li.appendChild(userPara);
                }

                return li;
            }

            // Helper to format date and time
            function formatDateTime(isoString) {
                if (!isoString) return 'Date N/A';
                try {
                    const date = new Date(isoString);
                    return date.toLocaleString('en-US', {
                        year: 'numeric', month: 'short', day: 'numeric',
                        hour: '2-digit', minute: '2-digit', hour12: true
                    });
                } catch (e) {
                    return isoString; // Return original if parsing fails
                }
            }

            // Function to view lifecycle history
            async function viewLifecycleHistory(taskId) {
                console.log('viewLifecycleHistory called with taskId:', taskId);

                try {
                    const tasks = await fetchTasks();
                    const task = tasks.find(t => t.id === taskId);

                    if (!task) {
                        console.error('Task not found:', taskId);
                        showNotification('Error', 'Task not found', 'error');
                        return;
                    }

                    console.log('Task found:', task);
                    console.log('Task lifecycle:', task.lifecycle);

                    // Get modal elements and check if they exist
                    const modal = document.getElementById('lifecycle-history-modal');
                    const titleElement = document.getElementById('history-task-title');
                    const statusElement = document.getElementById('history-current-status');
                    const updatedElement = document.getElementById('history-last-updated');
                    const timeline = document.getElementById('lifecycle-timeline');

                    if (!modal) {
                        console.error('lifecycle-history-modal not found');
                        showNotification('Error', 'Modal not found', 'error');
                        return;
                    }

                    console.log('Modal elements found, populating...');

                    // Populate modal header
                    if (titleElement) titleElement.textContent = task.title;
                    if (statusElement) statusElement.textContent = getStatusDisplayName(task.column);
                    if (updatedElement) updatedElement.textContent = formatDateTime(task.updatedAt);

                    // Populate timeline
                    if (timeline) {
                        timeline.innerHTML = '';

                        if (task.lifecycle && task.lifecycle.length > 0) {
                            console.log('Task has lifecycle data, creating timeline...');
                            // Sort lifecycle entries by timestamp (newest first)
                            const sortedLifecycle = [...task.lifecycle].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                            // Create timeline container
                            const timelineContainer = document.createElement('ol');
                            timelineContainer.className = 'relative border-s border-gray-200';

                            sortedLifecycle.forEach((entry, index) => {
                                const timelineEntry = createTimelineEntry(entry, index === sortedLifecycle.length - 1);
                                timelineContainer.appendChild(timelineEntry);
                            });

                            timeline.appendChild(timelineContainer);
                        } else {
                            console.log('No lifecycle data found for task');
                            timeline.innerHTML = '<p class="text-gray-500 text-center py-4">No lifecycle history available</p>';
                        }
                    }

                    // Show modal
                    console.log('Showing modal...');
                    modal.classList.remove('hidden');

                    // Hide task menu if it exists
                    const taskMenu = document.getElementById(`menu-${taskId}`);
                    if (taskMenu) {
                        taskMenu.classList.add('hidden');
                    }

                    console.log('Modal should now be visible');
                } catch (error) {
                    console.error('Error loading lifecycle history:', error);
                    showNotification('Error', 'Error loading lifecycle history. Please try again.', 'error');
                }
            }

            // Make viewLifecycleHistory globally accessible
            window.viewLifecycleHistory = viewLifecycleHistory;

            // Show task context menu on right-click
            function showTaskMenu(event, taskId) {
                event.preventDefault();
                const menu = document.getElementById(`menu-${taskId}`);
                if (menu) {
                    // Hide all other menus first
                    document.querySelectorAll('.task-menu-dropdown').forEach(m => m.classList.add('hidden'));

                    menu.style.position = 'fixed';
                    menu.style.left = event.clientX + 'px';
                    menu.style.top = event.clientY + 'px';
                    menu.style.zIndex = '1000';
                    menu.classList.remove('hidden');

                    // Hide menu when clicking elsewhere
                    setTimeout(() => {
                        document.addEventListener('click', function hideMenu() {
                            menu.classList.add('hidden');
                            document.removeEventListener('click', hideMenu);
                        });
                    }, 100);
                }
            }

            // Show task details (could open a modal or expand card)
            function showTaskDetails(taskId) {
                console.log('Showing details for task:', taskId);
                // For now, just open the edit modal
                editTask(taskId);
            }

            // Calendar functionality
            let currentCalendarDate = new Date();
            let currentCalendarView = 'month'; // month, week, day

            function updateCalendarReal() {
                console.log('Updating calendar view:', currentCalendarView);
                updateCalendarHeader();
                generateCalendarGrid();
            }

            // Register the real updateCalendar function with the stub system
            registerRealUpdateCalendar(updateCalendarReal);

            function updateCalendarView(view) {
                currentCalendarView = view;
                console.log('Calendar view changed to:', view);

                if (view === 'day') {
                    // Reset to today when switching to day view
                    currentCalendarDate = new Date();
                }

                // Force calendar grid to be properly set up for the view
                const calendarGrid = document.getElementById('calendar-grid');
                if (calendarGrid) {
                    calendarGrid.innerHTML = ''; // Clear existing content

                    // Ensure proper grid classes based on view
                    switch (view) {
                        case 'month':
                            calendarGrid.className = 'grid grid-cols-7';
                            break;
                        case 'week':
                            calendarGrid.className = 'grid grid-cols-7';
                            break;
                        case 'day':
                            calendarGrid.className = 'grid grid-cols-1';
                            break;
                        default:
                            calendarGrid.className = 'grid grid-cols-7';
                    }
                }

                updateCalendarReal();
            }

            // Make updateCalendarView globally accessible for Alpine.js
            window.updateCalendarView = updateCalendarView;

            function updateCalendarHeader() {
                const monthYear = document.getElementById('calendar-month-year');
                let options, displayText;

                switch (currentCalendarView) {
                    case 'month':
                        options = { year: 'numeric', month: 'long' };
                        displayText = currentCalendarDate.toLocaleDateString('en-US', options);
                        break;
                    case 'week':
                        const weekStart = getWeekStart(currentCalendarDate);
                        const weekEnd = getWeekEnd(currentCalendarDate);
                        const startMonth = weekStart.toLocaleDateString('en-US', { month: 'short' });
                        const endMonth = weekEnd.toLocaleDateString('en-US', { month: 'short' });
                        displayText = `${startMonth} ${weekStart.getDate()} - ${endMonth} ${weekEnd.getDate()}, ${currentCalendarDate.getFullYear()}`;
                        break;
                    case 'day':
                        options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
                        displayText = currentCalendarDate.toLocaleDateString('en-US', options);
                        break;
                    default:
                        options = { year: 'numeric', month: 'long' };
                        displayText = currentCalendarDate.toLocaleDateString('en-US', options);
                }

                monthYear.textContent = displayText;
            }

            function getWeekStart(date) {
                const start = new Date(date);
                const day = start.getDay();
                const diff = start.getDate() - day;
                return new Date(start.setDate(diff));
            }

            function getWeekEnd(date) {
                const start = getWeekStart(date);
                const end = new Date(start);
                end.setDate(start.getDate() + 6);
                return end;
            }

            async function generateCalendarGrid() {
                const calendarGrid = document.getElementById('calendar-grid');
                calendarGrid.innerHTML = '';

                // Get tasks for calendar display
                const tasks = await fetchTasks();

                switch (currentCalendarView) {
                    case 'month':
                        generateMonthView(calendarGrid, tasks);
                        break;
                    case 'week':
                        generateWeekView(calendarGrid, tasks);
                        break;
                    case 'day':
                        generateDayView(calendarGrid, tasks);
                        break;
                    default:
                        generateMonthView(calendarGrid, tasks);
                }
            }

            function generateMonthView(calendarGrid, tasks) {
                // Set grid to 7 columns and 6 rows for month view
                calendarGrid.className = 'grid grid-cols-7 grid-rows-6';

                // Get first day of month and number of days in month
                const year = currentCalendarDate.getFullYear();
                const month = currentCalendarDate.getMonth();
                const firstDayOfMonth = new Date(year, month, 1);
                const lastDayOfMonth = new Date(year, month + 1, 0);
                const daysInMonth = lastDayOfMonth.getDate();
                const startDay = firstDayOfMonth.getDay(); // 0 = Sunday, 1 = Monday, etc.

                // Find the first visible day (Sunday before or on the 1st)
                const firstGridDate = new Date(year, month, 1 - startDay);

                // Render exactly 42 days (6 weeks) - standard calendar layout
                for (let i = 0; i < 42; i++) {
                    const gridDate = new Date(firstGridDate);
                    gridDate.setDate(firstGridDate.getDate() + i);
                    const isCurrentMonth = gridDate.getMonth() === month;
                    const dayElement = createCalendarDay(gridDate, month, tasks, false);
                    if (!isCurrentMonth) {
                        dayElement.className = 'min-h-[120px] p-2 border-r border-b border-gray-200 bg-gray-50';
                        const dayNumber = dayElement.querySelector('div');
                        if (dayNumber) dayNumber.className = '!text-md font-medium mb-2 text-gray-400';
                    }
                    calendarGrid.appendChild(dayElement);
                }
            }

            function generateWeekView(calendarGrid, tasks) {
                // Set grid to 7 columns for week view
                calendarGrid.className = 'grid grid-cols-7';

                const weekStart = getWeekStart(currentCalendarDate);

                // Generate 7 days for the week
                for (let i = 0; i < 7; i++) {
                    const currentDate = new Date(weekStart);
                    currentDate.setDate(weekStart.getDate() + i);
                    const dayElement = createCalendarDay(currentDate, currentDate.getMonth(), tasks, true);
                    calendarGrid.appendChild(dayElement);
                }
            }

            function generateDayView(calendarGrid, tasks) {
                // Set grid to 1 column for day view
                calendarGrid.className = 'grid grid-cols-1';

                const dayElement = createDayViewElement(currentCalendarDate, tasks);
                calendarGrid.appendChild(dayElement);
            }

            function createDayViewElement(date, tasks) {
                const dayDiv = document.createElement('div');
                const isToday = date.toDateString() === new Date().toDateString();

                dayDiv.className = `min-h-[500px] p-6 border border-gray-200 bg-white rounded-lg ${isToday ? 'bg-blue-50 border-blue-200' : ''
                    }`;

                // Day header
                const dayHeader = document.createElement('div');
                dayHeader.className = 'mb-6 pb-4 border-b border-gray-200';

                const dayTitle = document.createElement('h3');
                dayTitle.className = `!text-2xl font-semibold text-gray-900 ${isToday ? 'text-blue-600' : ''
                    }`;
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                dayTitle.textContent = date.toLocaleDateString('en-US', options);
                dayHeader.appendChild(dayTitle);
                dayDiv.appendChild(dayHeader);

                // Find tasks for this date
                const dateString = date.getFullYear() + '-' +
                    String(date.getMonth() + 1).padStart(2, '0') + '-' +
                    String(date.getDate()).padStart(2, '0');
                const dayTasks = tasks.filter(task => {
                    return task.dueDate === dateString;
                });

                // Tasks container
                const tasksContainer = document.createElement('div');
                tasksContainer.className = 'space-y-3';

                if (dayTasks.length === 0) {
                    const noTasksDiv = document.createElement('div');
                    noTasksDiv.className = 'text-center py-12 text-gray-500';
                    noTasksDiv.innerHTML = `
                    <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    </svg>
                    <p class="text-lg font-medium">No tasks scheduled for this day</p>
                    <p class="!text-md">Enjoy your free time!</p>
                `;
                    tasksContainer.appendChild(noTasksDiv);
                } else {
                    dayTasks.forEach(task => {
                        const taskElement = document.createElement('div');
                        taskElement.className = 'p-4 bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md transition-shadow';
                        taskElement.innerHTML = `
                        <div class="flex items-center justify-between">
                            <h4 class="text-lg font-medium text-gray-900">${task.title}</h4>
                            <span class="px-2 py-1 !text-md font-semibold rounded-full ${getPriorityBadgeClass(task.priority)}">
                                ${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}
                            </span>
                        </div>
                        <p class="text-gray-600 mt-2">${task.description}</p>
                        <div class="flex items-center justify-between mt-3">
                            <span class="!text-md text-gray-500">Assigned to: ${task.assignedUser || 'Unassigned'}</span>
                            <span class="px-2 py-1 !text-md font-medium rounded-full ${getStatusBadgeClass(task.column)}">
                                ${getStatusDisplayName(task.column)}
                            </span>
                        </div>
                    `;
                        tasksContainer.appendChild(taskElement);
                    });
                }

                dayDiv.appendChild(tasksContainer);
                return dayDiv;
            }

            // Helper functions for calendar
            function getPriorityBadgeClass(priority) {
                switch (priority) {
                    case 'urgent': return 'bg-red-100 text-red-800';
                    case 'high': return 'bg-orange-100 text-orange-800';
                    case 'medium': return 'bg-yellow-100 text-yellow-800';
                    case 'low': return 'bg-blue-100 text-blue-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            }

            function getStatusBadgeClass(status) {
                switch (status) {
                    case 'unassigned': return 'bg-gray-100 text-gray-800';
                    case 'submitted': return 'bg-yellow-100 text-yellow-800';
                    case 'progress': return 'bg-blue-100 text-blue-800';
                    case 'done': return 'bg-green-100 text-green-800';
                    case 'tosubmit': return 'bg-purple-100 text-purple-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            }

            // Initialize calendar when DOM is loaded
            document.addEventListener('DOMContentLoaded', function () {
                updateCalendarReal();
            });

            // Helper function to get ticket type display name
            function getTicketTypeDisplayName(ticketType) {
                const typeNames = {
                    'jira': 'Jira',
                    'enhancement': 'Enhancement',
                    'bug': 'Bug',
                    'maintenance': 'Maintenance',
                    'support': 'Support'
                };
                return typeNames[ticketType] || ticketType || 'N/A';
            }

            // Helper function to get priority display name
            function getPriorityDisplayName(priority) {
                const priorityNames = {
                    '1': '1 - Critical',
                    '2': '2 - High',
                    '3': '3 - Medium',
                    '4': '4 - Low',
                    '5': '5 - Lowest'
                };
                return priorityNames[priority] || priority || 'N/A';
            }

            // Helper function to get team display name
            function getTeamDisplayName(team) {
                const teamNames = {
                    'tableau': 'Tableau',
                    'automation': 'Automation',
                    'data': 'Data',
                    'infrastructure': 'Infrastructure',
                    'security': 'Security',
                    'development': 'Development'
                };
                return teamNames[team] || team || 'N/A';
            }

            function getStatusDisplayName(status) {
                const statusNames = {
                    'unassigned': 'Unassigned',
                    'submitted': 'Submitted',
                    'progress': 'In Progress',
                    'done': 'Done',
                    'tosubmit': 'To Submit'
                };
                return statusNames[status] || status;
            }

            // Helper function to get ticket type badge class
            function getTicketTypeBadgeClass(ticketType) {
                switch (ticketType) {
                    case 'jira': return 'bg-blue-100 text-blue-800';
                    case 'enhancement': return 'bg-green-100 text-green-800';
                    case 'bug': return 'bg-red-100 text-red-800';
                    case 'maintenance': return 'bg-yellow-100 text-yellow-800';
                    case 'support': return 'bg-purple-100 text-purple-800';
                    default: return 'bg-gray-100 text-gray-800';
                }
            }

            // Helper function to get priority badge class
            function getPriorityBadgeClass(priority) {
                switch (priority) {
                    case '1': return 'bg-red-100 text-red-800';      // Critical
                    case '2': return 'bg-orange-100 text-orange-800'; // High
                    case '3': return 'bg-yellow-100 text-yellow-800'; // Medium
                    case '4': return 'bg-blue-100 text-blue-800';     // Low
                    case '5': return 'bg-gray-100 text-gray-800';     // Lowest
                    default: return 'bg-gray-100 text-gray-800';
                }
            }

            // Helper function to format date and time
            function formatDateTime(dateString) {
                if (!dateString) return 'No date';
                const date = new Date(dateString);
                return date.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        }); // Close main DOMContentLoaded event listener

        function createCalendarDay(date, month, tasks, isWeekView = false) {
            const dayDiv = document.createElement('div');
            const isToday = date.toDateString() === new Date().toDateString();
            const isCurrentMonth = date.getMonth() === month;

            // Base styling for day cell
            dayDiv.className = `min-h-[120px] p-2 border-r border-b border-gray-200 relative ${isCurrentMonth ? 'bg-white' : 'bg-gray-50'
                } ${isToday ? 'bg-blue-50 border-blue-300' : ''} hover:bg-gray-50 transition-colors`;

            // Day number at the top
            const dayNumber = document.createElement('div');
            dayNumber.className = `!text-md font-medium mb-2 flex items-center gap-1 ${isCurrentMonth
                ? (isToday ? 'text-blue-600 font-bold' : 'text-gray-900')
                : 'text-gray-400'
                }`;

            if (isToday) {
                dayNumber.innerHTML = `<span class="inline-block w-2 h-2 rounded-full bg-blue-500"></span>${date.getDate()}`;
            } else {
                dayNumber.textContent = date.getDate();
            }
            dayDiv.appendChild(dayNumber);

            // Find tasks for this specific date
            const dateString = date.getFullYear() + '-' +
                String(date.getMonth() + 1).padStart(2, '0') + '-' +
                String(date.getDate()).padStart(2, '0');
            const dayTasks = tasks.filter(task => {
                return task.dueDate === dateString;
            });

            // Tasks container
            const tasksContainer = document.createElement('div');
            tasksContainer.className = 'space-y-1 overflow-hidden';

            if (dayTasks.length === 0) {
                // Empty day - just add some minimal spacing
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'h-4';
                tasksContainer.appendChild(emptyDiv);
            } else {
                // Show up to 3 tasks, then a "more" indicator
                const visibleTasks = dayTasks.slice(0, 3);
                const remainingCount = dayTasks.length - 3;

                visibleTasks.forEach((task, index) => {
                    const taskDiv = document.createElement('div');
                    taskDiv.className = 'mb-1 px-2 py-1 rounded !text-md font-medium cursor-pointer flex items-center gap-1 transition-all duration-200 hover:scale-105 hover:shadow-sm border border-transparent hover:border-gray-300';
                    taskDiv.title = `${task.title} - ${task.assignedUser || 'Unassigned'} - Priority: ${task.priority}`;

                    // Status indicator dot
                    const statusDot = document.createElement('span');
                    statusDot.className = 'inline-block w-2 h-2 rounded-full flex-shrink-0';

                    // Set status color
                    switch (task.column) {
                        case 'todo':
                            statusDot.className += ' bg-red-500';
                            taskDiv.className += ' bg-red-50 text-red-800 hover:bg-red-100';
                            break;
                        case 'progress':
                            statusDot.className += ' bg-blue-500';
                            taskDiv.className += ' bg-blue-50 text-blue-800 hover:bg-blue-100';
                            break;
                        case 'review':
                            statusDot.className += ' bg-orange-500';
                            taskDiv.className += ' bg-orange-50 text-orange-800 hover:bg-orange-100';
                            break;
                        case 'done':
                            statusDot.className += ' bg-green-500';
                            taskDiv.className += ' bg-green-50 text-green-800 hover:bg-green-100';
                            break;
                        default:
                            statusDot.className += ' bg-gray-500';
                            taskDiv.className += ' bg-gray-50 text-gray-800 hover:bg-gray-100';
                    }

                    // Task title (truncated)
                    const titleSpan = document.createElement('span');
                    titleSpan.className = 'truncate flex-1 !text-md';
                    titleSpan.textContent = task.title;

                    // Priority indicator (small badge)
                    let priorityColor = '';
                    switch (task.priority) {
                        case 'urgent':
                            priorityColor = 'bg-red-600 text-white';
                            break;
                        case 'high':
                            priorityColor = 'bg-orange-500 text-white';
                            break;
                        case 'medium':
                            priorityColor = 'bg-yellow-500 text-white';
                            break;
                        case 'low':
                            priorityColor = 'bg-blue-500 text-white';
                            break;
                        default:
                            priorityColor = 'bg-gray-400 text-white';
                    }

                    const priorityDot = document.createElement('span');
                    priorityDot.className = `inline-block w-1 h-1 rounded-full flex-shrink-0 ${priorityColor}`;
                    priorityDot.title = `Priority: ${task.priority}`;

                    // Assemble task element
                    taskDiv.appendChild(statusDot);
                    taskDiv.appendChild(titleSpan);
                    taskDiv.appendChild(priorityDot);

                    // Click handler to edit task
                    taskDiv.onclick = function (e) {
                        e.stopPropagation();
                        console.log('Calendar task clicked:', task.id, task.title);
                        if (typeof window.editTask === 'function') {
                            window.editTask(task.id);
                        } else if (typeof editTask === 'function') {
                            editTask(task.id);
                        } else {
                            console.error('editTask function not found');
                            showNotification('Error', 'Task editing function not available', 'error');
                        }
                    };

                    tasksContainer.appendChild(taskDiv);
                });

                // Show "more" indicator if there are additional tasks
                if (remainingCount > 0) {
                    const moreDiv = document.createElement('div');
                    moreDiv.className = 'px-2 py-1 rounded !text-md font-medium bg-gray-100 text-gray-600 cursor-pointer hover:bg-gray-200 transition-colors';
                    moreDiv.textContent = `+${remainingCount} more`;
                    moreDiv.title = `${remainingCount} additional tasks on this day`;
                    moreDiv.onclick = function (e) {
                        e.stopPropagation();
                        // Could show a modal with all tasks for this day
                        console.log(`Show all ${dayTasks.length} tasks for ${dateString}`);
                    };
                    tasksContainer.appendChild(moreDiv);
                }
            }

            dayDiv.appendChild(tasksContainer);

            // Add a subtle indicator for days with tasks
            if (dayTasks.length > 0 && isCurrentMonth) {
                const indicator = document.createElement('div');
                indicator.className = 'absolute bottom-1 right-1 w-2 h-2 bg-blue-400 rounded-full opacity-60';
                dayDiv.appendChild(indicator);
            }

            return dayDiv;
        }

        // Make deleteTask globally accessible
        window.deleteTask = deleteTask;

    </script>

</body>

</html>
