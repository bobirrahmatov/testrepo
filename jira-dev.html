<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Board</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            "50": "#eff6ff",
                            "100": "#dbeafe",
                            "200": "#bfdbfe",
                            "300": "#93c5fd",
                            "400": "#60a5fa",
                            "500": "#3b82f6",
                            "600": "#2563eb",
                            "700": "#1d4ed8",
                            "800": "#1e40af",
                            "900": "#1e3a8a",
                            "950": "#172554"
                        }
                    }
                }
            }
        }
    </script>
    <!-- Drag and Drop Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <style>
        .task-card.dragging {
            opacity: 0.5;
        }

        .task-list {
            min-height: 200px;
            display: flex;
            flex-direction: column;
        }

        .task-list:empty {
            min-height: 200px;
        }

        .view-kanban {
            display: none;
        }

        .view-table {
            display: none;
        }

        /* Add transition for view switching */
        [x-show] {
            transition: opacity 0.3s ease-in-out;
        }

        [x-show].opacity-0 {
            opacity: 0;
        }

        [x-show].opacity-100 {
            opacity: 1;
        }

        /* Notification styles */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .notification.success {
            background-color: #10B981;
        }

        .notification.error {
            background-color: #EF4444;
        }

        .notification.info {
            background-color: #3B82F6;
        }

        /* Add border to three dots menu dropdown */
        .task-menu-dropdown {
            border: 1px solid #e5e7eb; /* Tailwind's border-gray-200 */
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }

        /* FullCalendar styles */
        .fc-header-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .fc-toolbar-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }
        
    </style>
</head>

<body class="bg-gray-100">
    <!-- Message Component -->
    <div class="fixed bottom-4 right-4 z-50" id="notificationsContainer">
        <div class="flex flex-col gap-4">
            <!-- Notifications will be dynamically added here -->
        </div>
    </div>

    <div class="p-4">
        <div class="rounded-2xl border border-gray-200 bg-white">
            <div class="px-5 py-4 sm:px-6 sm:py-5">
                <h3 class="!text-2xl font-medium text-gray-800">
                    Task Management
                </h3>
            </div>
            <div class="border-t border-gray-100 p-5 sm:p-6">
                <!-- Search and Filter Section -->
                <div class="mb-6 flex flex-col gap-4">
                    <div class="flex flex-1 items-center gap-4">
                        <div class="w-[512px]">
                            <div class="relative">
                                <span class="pointer-events-none absolute top-1/2 left-4 -translate-y-1/2">
                                    <svg class="fill-gray-500" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M3.04199 9.37381C3.04199 5.87712 5.87735 3.04218 9.37533 3.04218C12.8733 3.04218 15.7087 5.87712 15.7087 9.37381C15.7087 12.8705 12.8733 15.7055 9.37533 15.7055C5.87735 15.7055 3.04199 12.8705 3.04199 9.37381ZM9.37533 1.54218C5.04926 1.54218 1.54199 5.04835 1.54199 9.37381C1.54199 13.6993 5.04926 17.2055 9.37533 17.2055C11.2676 17.2055 13.0032 16.5346 14.3572 15.4178L17.1773 18.2381C17.4702 18.531 17.945 18.5311 18.2379 18.2382C18.5308 17.9453 18.5309 17.4704 18.238 17.1775L15.4182 14.3575C16.5367 13.0035 17.2087 11.2671 17.2087 9.37381C17.2087 5.04835 13.7014 1.54218 9.37533 1.54218Z" fill=""></path>
                                    </svg>
                                </span>
                                <input type="text" id="searchInput" placeholder="Search tasks..." class="shadow-theme-xs focus:border-brand-300 focus:ring-brand-500/10 h-[42px] w-full rounded-lg border border-gray-300 bg-transparent py-2.5 pr-4 pl-[42px] !text-md text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden">
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <!-- Action Buttons -->
                            <button type="button" id="export-excel" class="flex items-center gap-2 rounded-lg bg-blue-500 px-4 py-2 !text-md font-medium text-white hover:bg-blue-600">
                                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Export
                            </button>
                            <button type="button" id="refresh-data" class="flex items-center gap-2 rounded-lg bg-blue-500 px-4 py-2 !text-md font-medium text-white hover:bg-blue-600">
                                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                Refresh
                            </button>
                        </div>
                    </div>

                    <!-- View Switching Slider -->
                    <div class="rounded-xl border border-gray-200 p-6" x-data="{ activeView: 'kanban' }" x-init="$watch('activeView', async value => { console.log('View changed to:', value); if (value === 'metrics') { setTimeout(async () => await updateMetrics(false), 200); } else if (value === 'calendar') { setTimeout(() => updateCalendar(), 200); } })">
                        <div class="border-b border-gray-200">
                            <nav class="-mb-px flex space-x-2 overflow-x-auto [&::-webkit-scrollbar-thumb]:rounded-full [&::-webkit-scrollbar-thumb]:bg-gray-200 [&::-webkit-scrollbar]:h-1.5">
                                <button class="inline-flex items-center gap-2 border-b-2 px-2.5 py-2 !text-md font-medium transition-colors duration-200 ease-in-out" 
                                    :class="activeView === 'kanban' ? 'text-blue-500 border-blue-500' : 'text-gray-500 border-transparent hover:text-gray-700'"
                                    @click="activeView = 'kanban'" onclick="switchView('kanban')">
                                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                                    </svg>
                                    Kanban
                                </button>
                                <button class="inline-flex items-center gap-2 border-b-2 px-2.5 py-2 !text-md font-medium transition-colors duration-200 ease-in-out"
                                    :class="activeView === 'table' ? 'text-blue-500 border-blue-500' : 'text-gray-500 border-transparent hover:text-gray-700'"
                                    @click="activeView = 'table'" onclick="switchView('table')">
                                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                    Table
                                </button>
                                <button class="inline-flex items-center gap-2 border-b-2 px-2.5 py-2 !text-md font-medium transition-colors duration-200 ease-in-out"
                                    :class="activeView === 'metrics' ? 'text-blue-500 border-blue-500' : 'text-gray-500 border-transparent hover:text-gray-700'"
                                    @click="activeView = 'metrics'" onclick="switchView('metrics')">
                                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                    </svg>
                                    Metrics
                                </button>
                                <button class="inline-flex items-center gap-2 border-b-2 px-2.5 py-2 !text-md font-medium transition-colors duration-200 ease-in-out"
                                    :class="activeView === 'calendar' ? 'text-blue-500 border-blue-500' : 'text-gray-500 border-transparent hover:text-gray-700'"
                                    @click="activeView = 'calendar'" onclick="switchView('calendar')">
                                    <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v14a2 2 0 002 2z" />
                                    </svg>
                                    Calendar
                                </button>
                            </nav>
                </div>

                        <div class="pt-4">
        <!-- Kanban View -->
                            <div x-show="activeView === 'kanban'" class="bg-white min-h-screen">
                                <div class="flex gap-6 overflow-x-auto pb-4 pt-4"
                                     ondrop="drop(event)" 
                                     ondragover="allowDrop(event)">

                                    <!-- Todo Column -->
                                    <div class="bg-gray-50 rounded-lg flex-1 min-h-[600px]">
                                        <div class="p-4 flex justify-between items-center border-b border-gray-200">
                                            <h2 class="font-medium text-gray-700 text-sm flex items-center">
                                                <span class="w-2 h-2 bg-red-500 rounded-full mr-2"></span>
                                                To do
                                                <span class="ml-2 bg-gray-200 text-gray-600 text-xs font-medium px-1.5 py-0.5 rounded task-counter">0</span>
                                            </h2>
                                            <button id="add-todo" class="flex items-center justify-center text-gray-400 bg-white hover:text-gray-600 hover:bg-gray-200 rounded p-1 transition-colors duration-200">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="px-4 pb-4 pt-5 task-list" id="todo-column">
                                            <!-- Task cards here -->
                                        </div>
                                    </div>

                                    <!-- In Progress Column -->
                                    <div class="bg-gray-50 rounded-lg flex-1 min-h-[600px]">
                                        <div class="p-4 flex justify-between items-center border-b border-gray-200">
                                            <h2 class="font-medium text-gray-700 text-sm flex items-center">
                                                <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                                                In Progress
                                                <span class="ml-2 bg-gray-200 text-gray-600 text-xs font-medium px-1.5 py-0.5 rounded task-counter">0</span>
                                            </h2>
                                            <button id="add-progress" class="flex items-center justify-center text-gray-400 bg-white hover:text-gray-600 hover:bg-gray-200 rounded p-1 transition-colors duration-200">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="px-4 pb-4 pt-5 task-list" id="progress-column">
                                            <!-- Task cards here -->
                                        </div>
                                    </div>

                                    <!-- Review Column -->
                                    <div class="bg-gray-50 rounded-lg flex-1 min-h-[600px]">
                                        <div class="p-4 flex justify-between items-center border-b border-gray-200">
                                            <h2 class="font-medium text-gray-700 text-sm flex items-center">
                                                <span class="w-2 h-2 bg-orange-500 rounded-full mr-2"></span>
                                                Need review
                                                <span class="ml-2 bg-gray-200 text-gray-600 text-xs font-medium px-1.5 py-0.5 rounded task-counter">0</span>
                                            </h2>
                                            <button id="add-review" class="flex items-center justify-center text-gray-400 bg-white hover:text-gray-600 hover:bg-gray-200 rounded p-1 transition-colors duration-200">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="px-4 pb-4 pt-5 task-list" id="review-column">
                                            <!-- Task cards here -->
                                        </div>
                                    </div>

                                    <!-- Done Column -->
                                    <div class="bg-gray-50 rounded-lg flex-1 min-h-[600px]">
                                        <div class="p-4 flex justify-between items-center border-b border-gray-200">
                                            <h2 class="font-medium text-gray-700 text-sm flex items-center">
                                                <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                                                Completed
                                                <span class="ml-2 bg-gray-200 text-gray-600 text-xs font-medium px-1.5 py-0.5 rounded task-counter">0</span>
                                            </h2>
                                            <button id="add-done" class="flex items-center justify-center text-gray-400 bg-white hover:text-gray-600 hover:bg-gray-200 rounded p-1 transition-colors duration-200">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="px-4 pb-4 pt-5 task-list" id="done-column">
                                            <!-- Task cards here -->
                                        </div>
                                    </div>
                                </div>
                            </div>

        <!-- Table View -->
                            <div x-show="activeView === 'table'"
                                 x-transition:enter="transition ease-out duration-300"
                                 x-transition:enter-start="opacity-0 transform scale-95"
                                 x-transition:enter-end="opacity-100 transform scale-100"
                                 x-transition:leave="transition ease-in duration-200"
                                 x-transition:leave-start="opacity-100 transform scale-100"
                                 x-transition:leave-end="opacity-0 transform scale-95">
                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th scope="col" class="px-6 py-3 text-left !text-md font-medium text-gray-500 tracking-wider whitespace-nowrap">Title</th>
                                                <th scope="col" class="px-6 py-3 text-left !text-md font-medium text-gray-500 tracking-wider whitespace-nowrap">Type</th>
                                                <th scope="col" class="px-6 py-3 text-left !text-md font-medium text-gray-500 tracking-wider whitespace-nowrap">Priority</th>
                                                <th scope="col" class="px-6 py-3 text-left !text-md font-medium text-gray-500 tracking-wider whitespace-nowrap">Status</th>
                                                <th scope="col" class="px-6 py-3 text-left !text-md font-medium text-gray-500 tracking-wider whitespace-nowrap">Assignee</th>
                                                <th scope="col" class="px-6 py-3 text-left !text-md font-medium text-gray-500 tracking-wider whitespace-nowrap">Due Date</th>
                                                <th scope="col" class="px-6 py-3 text-left !text-md font-medium text-gray-500 tracking-wider whitespace-nowrap">Days Remaining</th>
                                                <th scope="col" class="px-6 py-3 text-left !text-md font-medium text-gray-500 tracking-wider whitespace-nowrap">Actions</th>
                            </tr>
                        </thead>
                                        <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                                            <!-- Table rows will be dynamically added here -->
                        </tbody>
                    </table>
                                </div>
                            </div>

                            <!-- Metrics View -->
                            <div x-show="activeView === 'metrics'"
                                 x-transition:enter="transition ease-out duration-300"
                                 x-transition:enter-start="opacity-0 transform scale-95"
                                 x-transition:enter-end="opacity-100 transform scale-100"
                                 x-transition:leave="transition ease-in duration-200"
                                 x-transition:leave-start="opacity-100 transform scale-100"
                                 x-transition:leave-end="opacity-0 transform scale-95">
                                
                                <!-- Metrics Dashboard -->
                                <div class="space-y-6">
                                    <!-- Summary Cards -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0">
                                                    <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                                                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                                        </svg>
                                                    </div>
                                                </div>
                                                <div class="ml-5 w-0 flex-1">
                                                    <dl>
                                                        <dt class="!text-md font-medium text-gray-500 truncate">Total Tasks</dt>
                                                        <dd class="!text-md font-medium text-gray-900" id="total-tasks-metric">0</dd>
                                                    </dl>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0">
                                                    <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center">
                                                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                        </svg>
                                                    </div>
                                                </div>
                                                <div class="ml-5 w-0 flex-1">
                                                    <dl>
                                                        <dt class="!text-md font-medium text-gray-500 truncate">Completed</dt>
                                                        <dd class="!text-md font-medium text-gray-900" id="completed-tasks-metric">0</dd>
                                                    </dl>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0">
                                                    <div class="w-8 h-8 bg-yellow-500 rounded-lg flex items-center justify-center">
                                                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                        </svg>
                                                    </div>
                                                </div>
                                                <div class="ml-5 w-0 flex-1">
                                                    <dl>
                                                        <dt class="!text-md font-medium text-gray-500 truncate">In Progress</dt>
                                                        <dd class="!text-md font-medium text-gray-900" id="progress-tasks-metric">0</dd>
                                                    </dl>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0">
                                                    <div class="w-8 h-8 bg-red-500 rounded-lg flex items-center justify-center">
                                                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                                        </svg>
                                                    </div>
                                                </div>
                                                <div class="ml-5 w-0 flex-1">
                                                    <dl>
                                                        <dt class="!text-md font-medium text-gray-500 truncate">Overdue</dt>
                                                        <dd class="!text-md font-medium text-gray-900" id="overdue-tasks-metric">0</dd>
                                                    </dl>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Charts Row 1 -->
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <!-- Task Status Distribution -->
                                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                                            <h3 class="!text-md font-medium text-gray-900 mb-4">Task Status Distribution</h3>
                                            <div id="statusChart"></div>
                                        </div>

                                        <!-- Priority Distribution -->
                                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                                            <h3 class="!text-md font-medium text-gray-900 mb-4">Priority Distribution</h3>
                                            <div id="priorityChart"></div>
                                        </div>
                                    </div>

                                    <!-- Removed Charts Row 2 (Task Type Distribution, Assignee Workload) and Row 3 (Timeline) - replaced with table below -->
                                    <div class="grid grid-cols-1 gap-6">
                                        <!-- Task Timeline -->
                                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm" style="display: none;">
                                            <h3 class="!text-md font-medium text-gray-900 mb-4">Tasks by Due Date Timeline</h3>
                                            <div id="timelineChart"><!-- Chart removed --></div>
                                        </div>
                                    </div>

                                    <!-- Task Details Table -->
                                    <div class="grid grid-cols-1 gap-6">
                                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                                            <h3 class="text-l font-medium text-gray-900 mb-4">🚨 Top 10 Overdue Tasks (1+ Month Pending)</h3>
                                            <div class="overflow-x-auto">
                                                <table class="min-w-full divide-y divide-gray-200" id="metrics-table">
                                                    <thead class="bg-gray-50">
                                                        <tr>
                                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 tracking-wider">Task Name</th>
                                                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 tracking-wider">Assigned To</th>
                                                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 tracking-wider">Priority</th>
                                                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 tracking-wider">Status</th>
                                                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 tracking-wider">Task Type</th>
                                                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 tracking-wider">Days Pending</th>
                                                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 tracking-wider">Created Date</th>
                                                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-gray-500 tracking-wider">Due Date</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody id="metrics-table-body" class="bg-white divide-y divide-gray-200">
                                                        <!-- Table rows will be populated by JavaScript -->
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Calendar View -->
                            <div x-show="activeView === 'calendar'"
                                 x-transition:enter="transition ease-out duration-300"
                                 x-transition:enter-start="opacity-0 transform scale-95"
                                 x-transition:enter-end="opacity-100 transform scale-100"
                                 x-transition:leave="transition ease-in duration-200"
                                 x-transition:leave-start="opacity-100 transform scale-100"
                                 x-transition:leave-end="opacity-0 transform scale-95">
                                
                                <!-- Calendar Header -->
                                <div class="bg-white rounded-lg border border-gray-200 shadow-sm mb-6">
                                    <!-- Navigation and View Controls Row -->
                                    <div class="fc-header-toolbar fc-toolbar fc-toolbar-ltr p-4 flex flex-wrap items-center justify-between gap-4">
                                        <!-- Navigation Controls -->
                                        <div class="flex items-center gap-2">
                                            <button type="button" title="Previous month" aria-pressed="false" 
                                                id="calendar-prev-btn" class="text-sm shadow-sm flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-2 py-2 font-medium text-gray-700 hover:bg-gray-50 hover:text-gray-800 sm:px-3.5">
                                                <svg class="fill-current" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M2.58301 9.99868C2.58272 10.1909 2.65588 10.3833 2.80249 10.53L7.79915 15.5301C8.09194 15.8231 8.56682 15.8233 8.85981 15.5305C9.15281 15.2377 9.15297 14.7629 8.86018 14.4699L5.14009 10.7472L16.6675 10.7472C17.0817 10.7472 17.4175 10.4114 17.4175 9.99715C17.4175 9.58294 17.0817 9.24715 16.6675 9.24715L5.14554 9.24715L8.86017 5.53016C9.15297 5.23717 9.15282 4.7623 8.85983 4.4695C8.56684 4.1767 8.09197 4.17685 7.79917 4.46984L2.84167 9.43049C2.68321 9.568 2.58301 9.77087 2.58301 9.99715C2.58301 9.99766 2.58301 9.99817 2.58301 9.99868Z" fill=""></path>
                                                </svg>
                                                <span class="hidden sm:inline">Previous</span>
                                            </button>
                                            <button type="button" title="Next month" aria-pressed="false" 
                                                id="calendar-next-btn" class="text-sm shadow-sm flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-2 py-2 font-medium text-gray-700 hover:bg-gray-50 hover:text-gray-800 sm:px-3.5">
                                                <span class="hidden sm:inline">Next</span>
                                                <svg class="fill-current" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path fill-rule="evenodd" clip-rule="evenodd" d="M17.4175 9.9986C17.4178 10.1909 17.3446 10.3832 17.198 10.53L12.2013 15.5301C11.9085 15.8231 11.4337 15.8233 11.1407 15.5305C10.8477 15.2377 10.8475 14.7629 11.1403 14.4699L14.8604 10.7472L3.33301 10.7472C2.91879 10.7472 2.58301 10.4114 2.58301 9.99715C2.58301 9.58294 2.91879 9.24715 3.33301 9.24715L14.8549 9.24715L11.1403 5.53016C10.8475 5.23717 10.8477 4.7623 11.1407 4.4695C11.4336 4.1767 11.9085 4.17685 12.2013 4.46984L17.1588 9.43049C17.3173 9.568 17.4175 9.77087 17.4175 9.99715C17.4175 9.99763 17.4175 9.99812 17.4175 9.9986Z" fill=""></path>
                                                </svg>
                                            </button>
                                        </div>

                                        <!-- Month/Year Title -->
                                        <div class="flex-1 text-center">
                                            <h2 class="fc-toolbar-title text-xl font-semibold text-gray-900" id="calendar-month-year">May 2025</h2>
                                        </div>

                                        <!-- View Controls -->
                                        <div x-data="{ activeTab: 'month' }">
                                            <div class="rounded-lg bg-gray-100 p-1">
                                                <nav class="flex">
                                                    <button class="inline-flex items-center rounded-md px-3 py-2 text-sm font-medium transition-colors duration-200 ease-in-out" 
                                                        x-bind:class="activeTab === 'month' ? 'bg-white text-gray-900 shadow-xs' : 'bg-transparent text-gray-500 hover:text-gray-700'" 
                                                        x-on:click="activeTab = 'month'; updateCalendarView('month')" type="button" title="month view">
                                                        month
                                                    </button>
                                                    <button class="inline-flex items-center rounded-md px-3 py-2 text-sm font-medium transition-colors duration-200 ease-in-out" 
                                                        x-bind:class="activeTab === 'week' ? 'bg-white text-gray-900 shadow-xs' : 'bg-transparent text-gray-500 hover:text-gray-700'" 
                                                        x-on:click="activeTab = 'week'; updateCalendarView('week')" type="button" title="week view">
                                                        week
                                                    </button>
                                                    <button class="inline-flex items-center rounded-md px-3 py-2 text-sm font-medium transition-colors duration-200 ease-in-out" 
                                                        x-bind:class="activeTab === 'day' ? 'bg-white text-gray-900 shadow-xs' : 'bg-transparent text-gray-500 hover:text-gray-700'" 
                                                        x-on:click="activeTab = 'day'; updateCalendarView('day')" type="button" title="day view">
                                                        day
                                                    </button>
                                                </nav>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Legend Row -->
                                    <div class="px-4 pb-4 border-t border-gray-100">
                                        <div class="flex flex-wrap items-center justify-center gap-6 pt-3">
                                            <div class="flex items-center gap-2">
                                                <div class="w-3 h-3 bg-blue-500 rounded-full shadow-sm"></div>
                                                <span class="text-sm font-medium text-gray-700">New Development</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <div class="w-3 h-3 bg-red-500 rounded-full shadow-sm"></div>
                                                <span class="text-sm font-medium text-gray-700">Bug</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <div class="w-3 h-3 bg-purple-500 rounded-full shadow-sm"></div>
                                                <span class="text-sm font-medium text-gray-700">Design</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <div class="w-3 h-3 bg-green-500 rounded-full shadow-sm"></div>
                                                <span class="text-sm font-medium text-gray-700">Enhancement</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <div class="w-3 h-3 bg-yellow-500 rounded-full shadow-sm"></div>
                                                <span class="text-sm font-medium text-gray-700">Ad Hoc</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Calendar Grid -->
                                <div class="bg-white rounded-lg border border-gray-200 shadow-sm">
                                    <!-- Day Headers -->
                                    <div class="grid grid-cols-7 border-b border-gray-200">
                                        <div class="p-4 text-center text-sm font-medium text-gray-500">Sun</div>
                                        <div class="p-4 text-center text-sm font-medium text-gray-500">Mon</div>
                                        <div class="p-4 text-center text-sm font-medium text-gray-500">Tue</div>
                                        <div class="p-4 text-center text-sm font-medium text-gray-500">Wed</div>
                                        <div class="p-4 text-center text-sm font-medium text-gray-500">Thu</div>
                                        <div class="p-4 text-center text-sm font-medium text-gray-500">Fri</div>
                                        <div class="p-4 text-center text-sm font-medium text-gray-500">Sat</div>
                                    </div>
                                    
                                    <!-- Calendar Days -->
                                    <div id="calendar-grid" class="grid grid-cols-7 grid-rows-6">
                                        <!-- Calendar days will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Form Modal -->
    <div id="task-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
            <div class="rounded-2xl border border-gray-200 bg-white">
                <div class="px-5 py-4 sm:px-6 sm:py-5">
                    <div class="flex items-center justify-between">
                        <h3 class="!text-2xl font-medium text-gray-800">Add New Task</h3>
                        <button id="close-modal" class="text-gray-400 hover:text-gray-500">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="p-5 space-y-6 border-t border-gray-100 sm:p-6">
                    <form id="task-form">
                        <input type="hidden" id="form-column" value="">
                        <input type="hidden" id="task-id" value="">
                        <div class="-mx-2.5 flex flex-wrap gap-y-5">
                            <div class="w-full px-2.5">
                                <input type="text" id="task-title" placeholder="Task title" required 
                                    class="h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 !text-md text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10">
                            </div>
                            
                            <div class="w-full px-2.5">
                                <textarea id="task-description" placeholder="Task description" rows="3"
                                    class="w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 !text-md text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10"></textarea>
                            </div>
                            
                            <div class="w-1/2 px-2.5">
                                <select id="task-tag" 
                                    class="h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 !text-md text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10">
                                    <option value="blue">New Development</option>
                                    <option value="red">Bug</option>
                                    <option value="purple">Design</option>
                                    <option value="green">Enhancement</option>
                                    <option value="yellow">Ad Hoc</option>
                                </select>
                            </div>
                            
                            <div class="w-1/2 px-2.5">
                                <select id="task-priority" 
                                    class="h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 !text-md text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10">
                                    <option value="none">None</option>
                                    <option value="low">Low</option>
                                    <option value="medium">Medium</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                            
                            <div class="w-1/2 px-2.5">
                                <select id="task-assigned-user" 
                                    class="h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 !text-md text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10">
                                    <option value="">Select User</option>
                                    <option value="User 1">User 1</option>
                                    <option value="User 2">User 2</option>
                                    <option value="User 3">User 3</option>
                                    <option value="User 4">User 4</option>
                                    <option value="User 5">User 5</option>
                                </select>
                            </div>
                            
                            <div class="w-1/2 px-2.5">
                                <select id="task-submitted-by" 
                                    class="h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 !text-md text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10">
                                    <option value="">Select User</option>
                                    <option value="User 1">User 1</option>
                                    <option value="User 2">User 2</option>
                                    <option value="User 3">User 3</option>
                                    <option value="User 4">User 4</option>
                                    <option value="User 5">User 5</option>
                                </select>
                            </div>
                            
                            <div class="w-1/2 px-2.5">
                                <input type="date" id="task-start-date" 
                                    class="h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 !text-md text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10">
                            </div>
                            
                            <div class="w-1/2 px-2.5">
                                <input type="date" id="task-due" 
                                    class="h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 !text-md text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10">
                            </div>
                            
                            <div class="w-full px-2.5 flex justify-end space-x-2">
                                <button type="button" id="cancel-task" class="px-4 py-2 !text-md font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-200">Cancel</button>
                                <button type="submit" class="px-4 py-2 !text-md font-medium text-white transition-colors rounded-lg bg-blue-500 hover:bg-blue-800">Add Task</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Lifecycle Update Modal -->
    <div id="lifecycle-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
            <div class="rounded-2xl border border-gray-200 bg-white">
                <div class="px-5 py-4 sm:px-6 sm:py-5">
                    <div class="flex items-center justify-between">
                        <h3 class="!text-2xl font-medium text-gray-800">Task Status Update</h3>
                        <button id="close-lifecycle-modal" class="text-gray-400 hover:text-gray-500">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="p-5 space-y-6 border-t border-gray-100 sm:p-6">
                    <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                        <div class="flex items-center mb-2">
                            <svg class="w-7 h-7 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <h4 class="!text-md font-medium text-blue-800">Status Change Detected</h4>
                        </div>
                        <p class="!text-md text-blue-700">
                            Task "<span id="lifecycle-task-title" class="font-medium"></span>" has been moved from 
                            <span id="lifecycle-from-status" class="font-medium"></span> to 
                            <span id="lifecycle-to-status" class="font-medium"></span>
                        </p>
                    </div>

                    <form id="lifecycle-form">
                        <input type="hidden" id="lifecycle-task-id" value="">
                        <input type="hidden" id="lifecycle-new-column" value="">
                        
                        <div class="-mx-2.5 flex flex-wrap gap-y-5">
                            <div class="w-full px-2.5">
                                <select id="lifecycle-update-type" required
                                    class="h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 !text-md text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10">
                                    <option value="">Select update type</option>
                                    <option value="progress">Progress Update</option>
                                    <option value="blocker">Blocker/Issue</option>
                                    <option value="completion">Task Completion</option>
                                    <option value="review">Ready for Review</option>
                                    <option value="testing">Testing Phase</option>
                                    <option value="deployment">Deployment</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>

                            <div class="w-full px-2.5">
                                <textarea id="lifecycle-comments" placeholder="Describe what has changed, any blockers, or next steps..." required rows="3"
                                    class="w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 !text-md text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10"></textarea>
                            </div>

                            <div class="w-full px-2.5">
                                <select id="lifecycle-updated-by" required
                                    class="h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 !text-md text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10">
                                    <option value="">Select user</option>
                                    <option value="User 1">User 1</option>
                                    <option value="User 2">User 2</option>
                                    <option value="User 3">User 3</option>
                                    <option value="User 4">User 4</option>
                                    <option value="User 5">User 5</option>
                                </select>
                            </div>

                            <div class="w-full px-2.5 flex justify-end space-x-2">
                                <button type="button" id="cancel-lifecycle" class="px-4 py-2 !text-md font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-200">Cancel</button>
                                <button type="submit" class="px-4 py-2 !text-md font-medium text-white transition-colors rounded-lg bg-blue-500 hover:bg-blue-800">Save Update</button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Lifecycle History Modal -->
    <div id="lifecycle-history-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-2xl max-h-[80vh] overflow-y-auto">
            <div class="rounded-2xl border border-gray-200 bg-white">
                <div class="px-5 py-4 sm:px-6 sm:py-5">
                    <div class="flex items-center justify-between">
                        <h3 class="!text-2xl font-medium text-gray-800">Task Lifecycle History</h3>
                        <button id="close-history-modal" class="text-gray-400 hover:text-gray-500">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="p-5 space-y-6 border-t border-gray-100 sm:p-6">
                    <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                        <h4 id="history-task-title" class="!text-md font-medium text-gray-900 mb-2"></h4>
                        <div class="grid grid-cols-2 gap-4 !text-md text-gray-600">
                            <div>
                                <span class="font-medium">Current status:</span>
                                <span id="history-current-status" class="ml-1"></span>
                            </div>
                            <div>
                                <span class="font-medium">Last update:</span>
                                <span id="history-last-updated" class="ml-1"></span>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4" id="lifecycle-timeline">
                        <!-- Timeline entries will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Feedback Button -->
    <button onclick="toggleFeedbackForm()" class="fixed left-4 bottom-4 z-50 flex items-center gap-2 rounded-lg bg-blue-600 px-4 py-2 !text-md font-medium text-white hover:bg-blue-700">
        <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
        </svg>
        Feedback
    </button>

    <!-- Feedback Form Modal -->
    <div id="feedbackModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50" onclick="toggleFeedbackForm()"></div>
        <div class="fixed left-4 bottom-4 w-full max-w-md">
            <div class="rounded-2xl border border-gray-200 bg-white">
                <div class="px-5 py-4 sm:px-6 sm:py-5">
                    <div class="flex items-center justify-between">
                        <h3 class="!text-2xl font-medium text-gray-800">
                            Feedback Form
                        </h3>
                        <button onclick="toggleFeedbackForm()" class="text-gray-400 hover:text-gray-500">
                            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="p-5 space-y-6 border-t border-gray-100 sm:p-6">
                    <form id="feedbackForm" onsubmit="submitFeedback(event)">
                        <div class="-mx-2.5 flex flex-wrap gap-y-5">
                            <div class="w-full px-2.5">
                                <input type="text" id="feedbackName" placeholder="Your Name (Optional)"
                                    class="h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 !text-md text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10">
                            </div>

                            <div class="w-full px-2.5">
                                <select id="feedbackType" required
                                    class="h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 !text-md text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10">
                                    <option value="">Select Feedback Type</option>
                                    <option value="suggestion">Suggestion</option>
                                    <option value="bug">Bug Report</option>
                                    <option value="improvement">Improvement</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>

                            <div class="w-full px-2.5">
                                <textarea id="feedbackMessage" placeholder="Your Feedback" required rows="4"
                                    class="w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 !text-md text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10"></textarea>
                            </div>

                            <div class="w-full px-2.5">
                                <button type="submit" class="w-full p-3 !text-md font-medium text-white transition-colors rounded-lg bg-blue-500 hover:bg-blue-800">
                                    Submit Feedback
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Fallback dummy data
        const FALLBACK_TASKS = [
            {
                "id": "1",
                "title": "Implement User Authentication System",
                "description": "Create a secure login and registration system with JWT tokens and password encryption. Include email verification and password reset functionality.",
                "tag": "blue",
                "priority": "high",
                "assignedUser": "User 1",
                "submittedBy": "User 5",
                "startDate": "2024-01-15",
                "dueDate": (() => {
                    const date = new Date();
                    date.setDate(date.getDate() - 6);
                    return date.toISOString().split('T')[0];
                })(),
                "column": "progress",
                "createdAt": "2024-01-15T09:00:00.000Z",
                "updatedAt": "2024-01-20T14:30:00.000Z",
                "lifecycle": [
                    {
                        "id": "lc_1705310400000",
                        "timestamp": "2024-01-15T09:00:00.000Z",
                        "fromStatus": null,
                        "toStatus": "todo",
                        "updateType": "creation",
                        "comments": "Task created",
                        "updatedBy": "User 5"
                    },
                    {
                        "id": "lc_1705742400000",
                        "timestamp": "2024-01-20T14:30:00.000Z",
                        "fromStatus": "todo",
                        "toStatus": "progress",
                        "updateType": "progress",
                        "comments": "Started working on authentication backend. Set up JWT library and basic user model.",
                        "updatedBy": "User 1"
                    }
                ]
            },
            {
                "id": "2",
                "title": "Fix Shopping Cart Bug",
                "description": "Items are not being removed from cart when quantity is set to 0. Users are reporting issues with checkout process.",
                "tag": "red",
                "priority": "urgent",
                "assignedUser": "User 2",
                "submittedBy": "User 3",
                "startDate": "2024-01-22",
                "dueDate": (() => {
                    const date = new Date();
                    date.setDate(date.getDate() - 6);
                    return date.toISOString().split('T')[0];
                })(),
                "column": "done",
                "createdAt": "2024-01-22T08:15:00.000Z",
                "updatedAt": "2024-01-24T16:45:00.000Z",
                "lifecycle": [
                    {
                        "id": "lc_1705915200000",
                        "timestamp": "2024-01-22T08:15:00.000Z",
                        "fromStatus": null,
                        "toStatus": "todo",
                        "updateType": "creation",
                        "comments": "Urgent bug reported by customer support",
                        "updatedBy": "User 3"
                    },
                    {
                        "id": "lc_1705999200000",
                        "timestamp": "2024-01-23T10:30:00.000Z",
                        "fromStatus": "todo",
                        "toStatus": "progress",
                        "updateType": "progress",
                        "comments": "Identified the issue in cart.js. Working on fix.",
                        "updatedBy": "User 2"
                    },
                    {
                        "id": "lc_1706112000000",
                        "timestamp": "2024-01-24T16:45:00.000Z",
                        "fromStatus": "progress",
                        "toStatus": "done",
                        "updateType": "completion",
                        "comments": "Bug fixed. Added unit tests. Completed and deployed.",
                        "updatedBy": "User 2"
                    }
                ]
            },
            {
                "id": "3",
                "title": "Redesign Dashboard Layout",
                "description": "Update the main dashboard to use the new design system. Improve user experience and add dark mode support.",
                "tag": "purple",
                "priority": "medium",
                "assignedUser": "User 3",
                "submittedBy": "User 4",
                "startDate": "2024-01-18",
                "dueDate": (() => {
                    const date = new Date();
                    date.setDate(date.getDate() - 4);
                    return date.toISOString().split('T')[0];
                })(),
                "column": "review",
                "createdAt": "2024-01-18T11:20:00.000Z",
                "updatedAt": "2024-01-18T11:20:00.000Z",
                "lifecycle": [
                    {
                        "id": "lc_1705572000000",
                        "timestamp": "2024-01-18T11:20:00.000Z",
                        "fromStatus": null,
                        "toStatus": "todo",
                        "updateType": "creation",
                        "comments": "Task created - part of Q1 design refresh",
                        "updatedBy": "User 4"
                    },
                    {
                        "id": "lc_1705572001000",
                        "timestamp": "2024-01-25T11:20:00.000Z",
                        "fromStatus": "todo",
                        "toStatus": "progress",
                        "updateType": "progress",
                        "comments": "Started wireframes and design mockups",
                        "updatedBy": "User 3"
                    },
                    {
                        "id": "lc_1705572002000",
                        "timestamp": "2024-02-01T11:20:00.000Z",
                        "fromStatus": "progress",
                        "toStatus": "review",
                        "updateType": "review",
                        "comments": "Design completed, ready for stakeholder review",
                        "updatedBy": "User 3"
                    }
                ]
            },
            {
                "id": "4",
                "title": "API Performance Optimization",
                "description": "Optimize database queries and implement caching to improve API response times by 50%. Focus on user data endpoints.",
                "tag": "green",
                "priority": "high",
                "assignedUser": "User 1",
                "submittedBy": "User 2",
                "startDate": "2024-01-10",
                "dueDate": (() => {
                    const date = new Date();
                    date.setDate(date.getDate() - 3);
                    return date.toISOString().split('T')[0];
                })(),
                "column": "done",
                "createdAt": "2024-01-10T09:30:00.000Z",
                "updatedAt": "2024-01-25T13:15:00.000Z",
                "lifecycle": [
                    {
                        "id": "lc_1704880200000",
                        "timestamp": "2024-01-10T09:30:00.000Z",
                        "fromStatus": null,
                        "toStatus": "todo",
                        "updateType": "creation",
                        "comments": "Performance issues reported in production",
                        "updatedBy": "User 2"
                    },
                    {
                        "id": "lc_1705054800000",
                        "timestamp": "2024-01-12T14:20:00.000Z",
                        "fromStatus": "todo",
                        "toStatus": "progress",
                        "updateType": "progress",
                        "comments": "Started analysis of slow queries. Identified bottlenecks in user data retrieval.",
                        "updatedBy": "User 1"
                    },
                    {
                        "id": "lc_1705659600000",
                        "timestamp": "2024-01-19T16:40:00.000Z",
                        "fromStatus": "progress",
                        "toStatus": "review",
                        "updateType": "review",
                        "comments": "Implemented Redis caching and optimized 5 key queries. Ready for testing.",
                        "updatedBy": "User 1"
                    },
                    {
                        "id": "lc_1706181300000",
                        "timestamp": "2024-01-25T13:15:00.000Z",
                        "fromStatus": "review",
                        "toStatus": "done",
                        "updateType": "completion",
                        "comments": "Performance tests passed. 60% improvement in response times. Deployed to production.",
                        "updatedBy": "User 2"
                    }
                ]
            },
            {
                "id": "5",
                "title": "Update User Documentation",
                "description": "Review and update all user-facing documentation. Add new features documentation and improve existing content clarity.",
                "tag": "yellow",
                "priority": "low",
                "assignedUser": "User 4",
                "submittedBy": "User 1",
                "startDate": "2024-01-25",
                "dueDate": (() => {
                    const date = new Date();
                    date.setDate(date.getDate() - 2);
                    return date.toISOString().split('T')[0];
                })(),
                "column": "todo",
                "createdAt": "2024-01-25T10:00:00.000Z",
                "updatedAt": "2024-01-25T10:00:00.000Z",
                "lifecycle": [
                    {
                        "id": "lc_1706176800000",
                        "timestamp": "2024-01-25T10:00:00.000Z",
                        "fromStatus": null,
                        "toStatus": "todo",
                        "updateType": "creation",
                        "comments": "Documentation needs refresh for new features",
                        "updatedBy": "User 1"
                    }
                ]
            },
            {
                "id": "6",
                "title": "Implement Real-time Notifications",
                "description": "Add WebSocket support for real-time notifications. Include browser notifications and in-app notification center.",
                "tag": "blue",
                "priority": "medium",
                "assignedUser": "User 5",
                "submittedBy": "User 3",
                "startDate": "2024-01-20",
                "dueDate": (() => {
                    const date = new Date();
                    date.setDate(date.getDate() - 1);
                    return date.toISOString().split('T')[0];
                })(),
                "column": "progress",
                "createdAt": "2024-01-20T13:45:00.000Z",
                "updatedAt": "2024-01-23T09:20:00.000Z",
                "lifecycle": [
                    {
                        "id": "lc_1705757100000",
                        "timestamp": "2024-01-20T13:45:00.000Z",
                        "fromStatus": null,
                        "toStatus": "todo",
                        "updateType": "creation",
                        "comments": "Feature requested by multiple users",
                        "updatedBy": "User 3"
                    },
                    {
                        "id": "lc_1705999200000",
                        "timestamp": "2024-01-23T09:20:00.000Z",
                        "fromStatus": "todo",
                        "toStatus": "progress",
                        "updateType": "progress",
                        "comments": "Set up WebSocket server. Working on client-side implementation.",
                        "updatedBy": "User 5"
                    }
                ]
            },
            {
                "id": "7",
                "title": "Security Audit Report Fixes",
                "description": "Address security vulnerabilities identified in the recent audit. Includes XSS prevention and SQL injection protection.",
                "tag": "red",
                "priority": "urgent",
                "assignedUser": "User 2",
                "submittedBy": "User 5",
                "startDate": "2024-01-24",
                "dueDate": (() => {
                    const date = new Date();
                    return date.toISOString().split('T')[0];
                })(),
                "column": "todo",
                "createdAt": "2024-01-24T14:30:00.000Z",
                "updatedAt": "2024-01-24T14:30:00.000Z",
                "lifecycle": [
                    {
                        "id": "lc_1706107800000",
                        "timestamp": "2024-01-24T14:30:00.000Z",
                        "fromStatus": null,
                        "toStatus": "todo",
                        "updateType": "creation",
                        "comments": "Security audit completed - 3 high priority issues found",
                        "updatedBy": "User 5"
                    }
                ]
            },
            {
                "id": "8",
                "title": "Mobile App Icon Design",
                "description": "Create new app icons for iOS and Android. Include various sizes and adaptive icons for Android 12+.",
                "tag": "purple",
                "priority": "low",
                "assignedUser": "User 3",
                "submittedBy": "User 4",
                "startDate": "2024-01-15",
                "dueDate": (() => {
                    const date = new Date();
                    date.setDate(date.getDate() - 3);
                    return date.toISOString().split('T')[0];
                })(),
                "column": "review",
                "createdAt": "2024-01-15T16:20:00.000Z",
                "updatedAt": "2024-01-24T11:30:00.000Z",
                "lifecycle": [
                    {
                        "id": "lc_1705335600000",
                        "timestamp": "2024-01-15T16:20:00.000Z",
                        "fromStatus": null,
                        "toStatus": "todo",
                        "updateType": "creation",
                        "comments": "New brand guidelines require updated app icons",
                        "updatedBy": "User 4"
                    },
                    {
                        "id": "lc_1705737600000",
                        "timestamp": "2024-01-20T08:40:00.000Z",
                        "fromStatus": "todo",
                        "toStatus": "progress",
                        "updateType": "progress",
                        "comments": "Started initial concepts. Created 5 different design variations.",
                        "updatedBy": "User 3"
                    },
                    {
                        "id": "lc_1706091000000",
                        "timestamp": "2024-01-24T11:30:00.000Z",
                        "fromStatus": "progress",
                        "toStatus": "review",
                        "updateType": "review",
                        "comments": "Completed all icon sizes. Ready for stakeholder review.",
                        "updatedBy": "User 3"
                    }
                ]
            },
            {
                "id": "9",
                "title": "Database Migration Script",
                "description": "Create migration script to update user table schema. Add new fields for enhanced user profiles.",
                "tag": "green",
                "priority": "medium",
                "assignedUser": "User 1",
                "submittedBy": "User 2",
                "startDate": "2024-01-22",
                "dueDate": "2024-12-22",
                "column": "progress",
                "createdAt": "2024-01-22T12:15:00.000Z",
                "updatedAt": "2024-01-24T15:45:00.000Z",
                "lifecycle": [
                    {
                        "id": "lc_1705930500000",
                        "timestamp": "2024-01-22T12:15:00.000Z",
                        "fromStatus": null,
                        "toStatus": "todo",
                        "updateType": "creation",
                        "comments": "Database schema changes needed for new features",
                        "updatedBy": "User 2"
                    },
                    {
                        "id": "lc_1706115900000",
                        "timestamp": "2024-01-24T15:45:00.000Z",
                        "fromStatus": "todo",
                        "toStatus": "progress",
                        "updateType": "progress",
                        "comments": "Started writing migration script. Testing on development database.",
                        "updatedBy": "User 1"
                    }
                ]
            },
            {
                "id": "10",
                "title": "Customer Support Chat Integration",
                "description": "Integrate third-party chat widget for customer support. Configure automated responses and routing rules.",
                "tag": "yellow",
                "priority": "none",
                "assignedUser": "User 4",
                "submittedBy": "User 3",
                "startDate": "2024-01-18",
                "dueDate": null,
                "column": "todo",
                "createdAt": "2024-01-18T09:45:00.000Z",
                "updatedAt": "2024-01-18T09:45:00.000Z",
                "lifecycle": [
                    {
                        "id": "lc_1705566300000",
                        "timestamp": "2024-01-18T09:45:00.000Z",
                        "fromStatus": null,
                        "toStatus": "todo",
                        "updateType": "creation",
                        "comments": "Customer success team requested better support tools",
                        "updatedBy": "User 3"
                    }
                ]
            },
            {
                "id": "12",
                "title": "Payment Gateway Integration",
                "description": "Integrate Stripe payment processing. Support for subscriptions, one-time payments, and refunds.",
                "tag": "green",
                "priority": "high",
                "assignedUser": "User 2",
                "submittedBy": "User 5",
                "startDate": "2024-01-12",
                "dueDate": (() => {
                    const date = new Date();
                    date.setDate(date.getDate() - 1);
                    return date.toISOString().split('T')[0];
                })(),
                "column": "done",
                "createdAt": "2024-01-12T10:30:00.000Z",
                "updatedAt": "2024-01-26T16:00:00.000Z",
                "lifecycle": [
                    {
                        "id": "lc_1705053000000",
                        "timestamp": "2024-01-12T10:30:00.000Z",
                        "fromStatus": null,
                        "toStatus": "todo",
                        "updateType": "creation",
                        "comments": "Critical for monetization strategy",
                        "updatedBy": "User 5"
                    },
                    {
                        "id": "lc_1705312800000",
                        "timestamp": "2024-01-15T15:20:00.000Z",
                        "fromStatus": "todo",
                        "toStatus": "progress",
                        "updateType": "progress",
                        "comments": "Set up Stripe account. Working on webhook handlers.",
                        "updatedBy": "User 2"
                    },
                    {
                        "id": "lc_1705830000000",
                        "timestamp": "2024-01-21T11:00:00.000Z",
                        "fromStatus": "progress",
                        "toStatus": "review",
                        "updateType": "review",
                        "comments": "Payment flow complete. Testing with sandbox environment.",
                        "updatedBy": "User 2"
                    },
                    {
                        "id": "lc_1706284800000",
                        "timestamp": "2024-01-26T16:00:00.000Z",
                        "fromStatus": "review",
                        "toStatus": "done",
                        "updateType": "completion",
                        "comments": "All tests passed. Live payments are working correctly.",
                        "updatedBy": "User 5"
                    }
                ]
            },
            {
                "id": "11",
                "title": "Email Template System",
                "description": "Build dynamic email template system with WYSIWYG editor. Support for personalization and A/B testing.",
                "tag": "blue",
                "priority": "none",
                "assignedUser": "User 5",
                "submittedBy": "User 1",
                "startDate": "2024-02-01",
                "dueDate": null,
                "column": "todo",
                "createdAt": "2024-01-25T14:20:00.000Z",
                "updatedAt": "2024-01-25T14:20:00.000Z",
                "lifecycle": [
                    {
                        "id": "lc_1706192400000",
                        "timestamp": "2024-01-25T14:20:00.000Z",
                        "fromStatus": null,
                        "toStatus": "todo",
                        "updateType": "creation",
                        "comments": "Marketing team needs better email capabilities",
                        "updatedBy": "User 1"
                    }
                ]
            }
        ];

        // Function to fetch tasks from Confluence (with fallback to dummy data)
        let hasShownOfflineNotification = false; // Flag to ensure offline notification is shown only once

        async function fetchTasks() {
            try {
                const response = await fetch(`https://cedt-confluence.net/confluence/download/attachments/2740868871/tasks.json?api=v2`);
                if (!response.ok) {
                    // Log the error and throw it to be caught by the caller
                    const errorText = await response.text(); // Attempt to get more error details
                    console.error(`Failed to load data: ${response.status} ${response.statusText}`, errorText);
                    throw new Error(`Failed to load data: ${response.status} ${response.statusText}. Server response: ${errorText}`);
                }
                const data = await response.json();
                return data.tasks || []; // Return empty array if tasks are not present
            } catch (error) {
                // Log the error and re-throw it to be caught by the caller
                console.error('Error fetching tasks from Confluence:', error);
                // No longer show 'Using offline demo data' as there's no fallback.
                // The caller (loadTasksFromConfluence) will handle showing an error to the user.
                throw error; 
            }
        }

        // Function to save tasks to Confluence (always use tasks.json)
        async function saveTasks(tasks, showNotifications = true) {
            try {
                // Get the attachment ID for tasks.json
                const attachmentsResponse = await fetch(`https://cedt-confluence.net/confluence/rest/api/content/2740868871/child/attachment?filename=tasks.json`);
                const attachmentsData = await attachmentsResponse.json();
                if (!attachmentsData.results || attachmentsData.results.length === 0) {
                    throw new Error('tasks.json attachment not found');
                }
                const attachmentId = attachmentsData.results[0].id;
                // Update the existing attachment
                const formData = new FormData();
                const blob = new Blob([JSON.stringify({ tasks }, null, 2)], { type: 'application/json' });
                formData.append('file', blob, 'tasks.json');
                const response = await fetch(`https://cedt-confluence.net/confluence/rest/api/content/2740868871/child/attachment/${attachmentId}`, {
                    method: 'POST',
                    headers: {
                        'X-Atlassian-Token': 'no-check'
                    },
                    body: formData
                });
                if (!response.ok) {
                    throw new Error(`Failed to save tasks.json: ${response.status} ${response.statusText}`);
                }
                if (showNotifications) {
                    showNotification('Success', 'Tasks saved successfully', 'notification');
                }
                return await response.json();
            } catch (error) {
                console.error('Error saving tasks:', error);
                if (showNotifications) {
                    showNotification('Error', 'Error saving tasks. Please try again.', 'error');
                }
                throw error;
            }
        }

        // Initialize view switching
        document.addEventListener('DOMContentLoaded', async function () {
            // View switching fallback
            window.switchView = function(viewName) {
                console.log('Switching to view:', viewName);
                
                // Hide all views
                const kanbanView = document.querySelector('div[x-show="activeView === \'kanban\'"]');
                const tableView = document.querySelector('div[x-show="activeView === \'table\'"]');
                const metricsView = document.querySelector('div[x-show="activeView === \'metrics\'"]');
                const calendarView = document.querySelector('div[x-show="activeView === \'calendar\'"]');
                
                if (kanbanView) kanbanView.style.display = 'none';
                if (tableView) tableView.style.display = 'none';
                if (metricsView) metricsView.style.display = 'none';
                if (calendarView) calendarView.style.display = 'none';
                
                // Show selected view
                switch(viewName) {
                    case 'kanban':
                        if (kanbanView) kanbanView.style.display = 'block';
                        break;
                    case 'table':
                        if (tableView) tableView.style.display = 'block';
                        // Update table data when switching to table view
                        setTimeout(async () => await updateTableView(), 100);
                        break;
                    case 'metrics':
                        if (metricsView) metricsView.style.display = 'block';
                        // setTimeout(() => updateMetrics(false), 200); // Removed: Alpine watcher handles this
                        break;
                    case 'calendar':
                        if (calendarView) calendarView.style.display = 'block';
                        // Initialize calendar with default month view if not already set
                        if (!window.calendarInitialized) {
                            currentCalendarView = 'month';
                            currentCalendarDate = new Date();
                            window.calendarInitialized = true;
                        }
                        break;
                }
                
                // Update button states
                document.querySelectorAll('nav button').forEach(btn => {
                    btn.classList.remove('text-blue-500', 'border-blue-500');
                    btn.classList.add('text-gray-500', 'border-transparent');
                });
                
                const activeButton = document.querySelector(`nav button[onclick="switchView('${viewName}')"]`);
                if (activeButton) {
                    activeButton.classList.remove('text-gray-500', 'border-transparent');
                    activeButton.classList.add('text-blue-500', 'border-blue-500');
                }
            };
            
            // Initialize with kanban view
            window.switchView('kanban');
            
            // Load initial tasks
            await loadTasksFromConfluence(false); // Pass false to prevent initial notifications

            // Add refresh button functionality
            document.getElementById('refresh-data').addEventListener('click', async function() {
                loadTasksFromConfluence();
            });

            // Function to load tasks from Confluence
            async function loadTasksFromConfluence(showNotifications = true) {
                try {
                    // Reset all counters to 0 first
                    document.querySelectorAll('.task-counter').forEach(counter => {
                        counter.textContent = '0';
                    });
                    
                    // Clear existing tasks from UI *before* fetching new ones
                    document.querySelectorAll('.task-list').forEach(list => list.innerHTML = '');

                    const tasks = await fetchTasks();
                    
                    if (tasks.length > 0) {
                        // Add tasks to their respective columns
                        tasks.forEach(task => {
                            const column = document.getElementById(`${task.column}-column`);
                            if (column) {
                                const taskCard = document.createElement('div');
                                taskCard.className = 'task-card';
                                taskCard.dataset.id = task.id;
                                taskCard.dataset.priority = task.priority;
                                taskCard.dataset.assignedUser = task.assignedUser;
                                taskCard.dataset.submittedBy = task.submittedBy;
                                taskCard.dataset.startDate = task.startDate;
                                taskCard.dataset.dueDate = task.dueDate;
                                taskCard.innerHTML = createTaskCardHTML(task);
                                column.appendChild(taskCard);
                            }
                        });
                        
                        // Update counters and table view only after all tasks are added
                        updateTaskCounters();
                        await updateTableView();
                        
                        // Reapply search filter if one is active
                        if (typeof applySearchFilter === 'function') {
                            applySearchFilter();
                        }
                        
                        if (showNotifications === true) {
                            showNotification('Success', 'Tasks loaded successfully', 'notification');
                        }
                    } else if (showNotifications) {
                        showNotification('Info', 'No tasks found or unable to load tasks from the server.', 'message');
                    }
                } catch (error) {
                    console.error('Error loading tasks:', error);
                    if (showNotifications) {
                    showNotification('Error', `Error loading tasks: ${error.message}`, 'error');
                    }
                    // Reset counters to 0 on error
                    document.querySelectorAll('.task-counter').forEach(counter => {
                        counter.textContent = '0';
                    });
                }
            }

            // Add search functionality
            let currentSearchTerm = '';
            
            document.getElementById('searchInput').addEventListener('input', function(e) {
                currentSearchTerm = e.target.value.toLowerCase();
                applySearchFilter();
            });
            
            function applySearchFilter() {
                // Search in Kanban view
                document.querySelectorAll('.task-card').forEach(card => {
                    const title = card.querySelector('h3').textContent.toLowerCase();
                    const description = card.querySelector('p').textContent.toLowerCase();
                    const tag = card.querySelector('span').textContent.toLowerCase();
                    const priority = card.dataset.priority.toLowerCase();
                    const assignedUser = (card.dataset.assignedUser || '').toLowerCase();
                    
                    const matches = !currentSearchTerm || 
                                  title.includes(currentSearchTerm) || 
                                  description.includes(currentSearchTerm) || 
                                  tag.includes(currentSearchTerm) || 
                                  priority.includes(currentSearchTerm) || 
                                  assignedUser.includes(currentSearchTerm);
                    
                    card.style.display = matches ? 'block' : 'none';
                });
                
                // Search in Table view
                document.querySelectorAll('#table-body tr').forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const matches = !currentSearchTerm || Array.from(cells).some(cell => 
                        cell.textContent.toLowerCase().includes(currentSearchTerm)
                    );
                    
                    row.style.display = matches ? '' : 'none';
                });
            }

            // Add MutationObserver to update table view when tasks are modified
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList' || mutation.type === 'attributes') {
                        updateTableView().catch(console.error);
                    }
                });
            });

            // Observe task lists for changes
            document.querySelectorAll('.task-list').forEach(list => {
                observer.observe(list, {
                    childList: true,
                    attributes: true,
                    subtree: true
                });
            });

            // Initialize sortable for each column
            const columns = document.querySelectorAll('.task-list');
            columns.forEach(column => {
                new Sortable(column, {
                    group: 'kanban',
                    animation: 150,
                    ghostClass: 'bg-gray-100',
                    onEnd: async function (evt) {
                        const taskElement = evt.item;
                        const taskId = taskElement.dataset.id;
                        const newColumn = evt.to.id.replace('-column', '');
                        const oldColumn = evt.from.id.replace('-column', '');
                        
                        // Only show lifecycle modal if task actually moved to a different column
                        if (newColumn !== oldColumn) {
                            showLifecycleModal(taskId, oldColumn, newColumn, taskElement);
                        } else {
            updateTaskCounters();
                        }
                    }
                });
            });

            // Add Task Modal Functionality
            const taskModal = document.getElementById('task-modal');
            const taskForm = document.getElementById('task-form');
            const closeModal = document.getElementById('close-modal');
            const cancelTask = document.getElementById('cancel-task');

            // Function to show modal
            function showTaskModal(column) {
                document.getElementById('form-column').value = column;
                document.getElementById('task-id').value = ''; // Reset task ID for new tasks
                taskForm.reset(); // Reset form
                taskModal.classList.remove('hidden');
            }

            // Function to hide modal
            function hideTaskModal() {
                taskModal.classList.add('hidden');
                    taskForm.reset();
            }

            // Add event listeners for Add Task buttons
            document.getElementById('add-todo').addEventListener('click', () => showTaskModal('todo'));
            document.getElementById('add-progress').addEventListener('click', () => showTaskModal('progress'));
            document.getElementById('add-review').addEventListener('click', () => showTaskModal('review'));
            document.getElementById('add-done').addEventListener('click', () => showTaskModal('done'));

            // Close modal event listeners
            closeModal.addEventListener('click', hideTaskModal);
            cancelTask.addEventListener('click', hideTaskModal);

            // Handle form submission
            taskForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                // Capture form data before hiding modal
                const taskId = document.getElementById('task-id').value;
                const isNewTask = !taskId;
                const currentTime = new Date().toISOString();
                
                const taskData = {
                    id: taskId || Date.now().toString(),
                    title: document.getElementById('task-title').value,
                    description: document.getElementById('task-description').value,
                    tag: document.getElementById('task-tag').value,
                    priority: document.getElementById('task-priority').value,
                    assignedUser: document.getElementById('task-assigned-user').value,
                    submittedBy: document.getElementById('task-submitted-by').value,
                    startDate: document.getElementById('task-start-date').value,
                    dueDate: document.getElementById('task-due').value,
                    column: document.getElementById('form-column').value,
                    createdAt: isNewTask ? currentTime : undefined,
                    updatedAt: currentTime
                };

                // Hide modal first
                hideTaskModal();

                try {
                    // Get existing tasks
                    const tasks = await fetchTasks();
                    
                    // Add new task or update existing one
                    const taskIndex = tasks.findIndex(t => t.id === taskData.id);
                    if (taskIndex !== -1) {
                        // Update existing task
                        const existingTask = tasks[taskIndex];
                        
                        // Preserve creation date and lifecycle
                        taskData.createdAt = existingTask.createdAt;
                        taskData.lifecycle = existingTask.lifecycle || [];
                        
                        // Add lifecycle entry for edit
                        const lifecycleEntry = {
                            id: `lc_${Date.now()}`,
                            timestamp: taskData.updatedAt,
                            fromStatus: existingTask.column,
                            toStatus: taskData.column,
                            updateType: 'other',
                            comments: 'Task details updated',
                            updatedBy: taskData.submittedBy || taskData.assignedUser || 'Unknown'
                        };
                        taskData.lifecycle.push(lifecycleEntry);
                        
                        tasks[taskIndex] = taskData;
                    } else {
                        // New task - initialize lifecycle
                        taskData.lifecycle = [{
                            id: `lc_${Date.now()}`,
                            timestamp: taskData.createdAt,
                            fromStatus: null,
                            toStatus: taskData.column,
                            updateType: 'creation',
                            comments: 'Task created',
                            updatedBy: taskData.submittedBy || taskData.assignedUser || 'Unknown'
                        }];
                        tasks.push(taskData);
                    }

                    // Save updated tasks without showing notification
                    await saveTasks(tasks, false);
                    
                    // Update UI without showing notification
                    await loadTasksFromConfluence(false);
                    
                    // Show single success notification
                    showNotification('Success', 'Task saved successfully', 'notification');
                } catch (error) {
                    console.error('Error saving task:', error);
                    showNotification('Error', 'Error saving task. Please try again.', 'error');
                }
            });

                    // Update task counters initially
        updateTaskCounters();

        // Metrics and Charts functionality
        let charts = {};

        // Function to update metrics
        async function updateMetrics(showNotifications = false) {
            try {
                const tasks = await fetchTasks();
                console.log('Updating metrics with', tasks.length, 'tasks');
                
                // Update summary cards
                document.getElementById('total-tasks-metric').textContent = tasks.length;
                document.getElementById('completed-tasks-metric').textContent = tasks.filter(t => t.column === 'done').length;
                document.getElementById('progress-tasks-metric').textContent = tasks.filter(t => t.column === 'progress').length;
                
                // Calculate overdue tasks
                const overdueTasks = tasks.filter(task => {
                    if (!task.dueDate) return false;
                    const today = new Date();
                    const dueDate = new Date(task.dueDate);
                    return dueDate < today && task.column !== 'done';
                });
                document.getElementById('overdue-tasks-metric').textContent = overdueTasks.length;

                // Update charts only if containers exist and there are tasks
                if (tasks.length === 0) {
                    // Handle empty state for all charts
                    updateStatusChart([]);
                    updatePriorityChart([]);
                    updateTagChart([]);
                    updateAssigneeChart([]);
                    updateTimelineChart([]);
                    
                    // Show message for no data only if notifications are enabled
                    if (showNotifications) {
                        showNotification('Info', 'No task data available for metrics visualization', 'message');
                    }
                    
                    // Update metrics table with empty data
                    updateMetricsTable([]);
                } else {
                    // Update charts with actual data
                    updateStatusChart(tasks);
                    updatePriorityChart(tasks);
                    updateTagChart(tasks);
                    updateAssigneeChart(tasks);
                    updateTimelineChart(tasks);
                    
                    // Show success message for data loaded only if notifications are enabled
                    if (showNotifications) {
                        showNotification('Success', `Metrics updated successfully with ${tasks.length} tasks`, 'success');
                    }
                    
                    // Update metrics table
                    updateMetricsTable(tasks);
                }
            } catch (error) {
                console.error('Error updating metrics:', error);
                showNotification('Error', 'Error updating metrics. Please try again.', 'error');
            }
        }

        // Status Distribution Chart
        function updateStatusChart(tasks) {
            try {
                const chartElement = document.getElementById('statusChart');
                if (!chartElement) {
                    console.debug('Status chart element not found');
                    return;
                }
                
                if (window.statusChart && typeof window.statusChart.destroy === 'function') {
                    window.statusChart.destroy();
                }

                if (!tasks || tasks.length === 0) {
                    const options = {
                        series: [1],
                        chart: {
                            type: 'donut',
                            height: 300
                        },
                        labels: ['No Data'],
                        colors: ['#e0e0e0'],
                        legend: {
                            show: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    };
                    window.statusChart = new ApexCharts(chartElement, options);
                    window.statusChart.render();
                    return;
                }

                const statusCounts = {
                    'todo': 0,
                    'progress': 0,
                    'review': 0,
                    'done': 0
                };

                tasks.forEach(task => {
                    if (statusCounts.hasOwnProperty(task.column)) {
                        statusCounts[task.column]++;
                    }
                });

                const options = {
                    series: [statusCounts.todo, statusCounts.progress, statusCounts.review, statusCounts.done],
                    chart: {
                        type: 'donut',
                        height: 300,
                        fontFamily: 'Outfit, sans-serif',
                        toolbar: {
                            show: false
                        }
                    },
                    labels: ['To Do', 'In Progress', 'Review', 'Done'],
                    colors: ['#465FFF', '#8B92FF', '#A3AFFF', '#C4CBFF'],
                    legend: {
                        position: 'bottom',
                        fontFamily: 'Outfit, sans-serif',
                        fontSize: '14px',
                        fontWeight: 500,
                        labels: {
                            colors: ['#374151', '#374151', '#374151', '#374151']
                        }
                    },
                    plotOptions: {
                        pie: {
                            donut: {
                                size: '70%',
                                labels: {
                                    show: true,
                                    name: {
                                        show: true,
                                        fontSize: '16px',
                                        fontFamily: 'Outfit, sans-serif',
                                        fontWeight: 600,
                                        color: '#374151'
                                    },
                                    value: {
                                        show: true,
                                        fontSize: '24px',
                                        fontFamily: 'Outfit, sans-serif',
                                        fontWeight: 700,
                                        color: '#111827'
                                    },
                                    total: {
                                        show: true,
                                        fontSize: '16px',
                                        fontFamily: 'Outfit, sans-serif',
                                        fontWeight: 600,
                                        color: '#374151'
                                    }
                                }
                            }
                        }
                    },
                    dataLabels: {
                        enabled: false
                    },
                    tooltip: {
                        style: {
                            fontFamily: 'Outfit, sans-serif'
                        }
                    },
                    responsive: [{
                        breakpoint: 480,
                        options: {
                            chart: {
                                width: 200
                            },
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }]
                };

                window.statusChart = new ApexCharts(chartElement, options);
                window.statusChart.render();
            } catch (error) {
                console.error('Error updating status chart:', error);
                showNotification('Error', 'Error updating status chart', 'error');
            }
        }

        // Priority Distribution Chart
        function updatePriorityChart(tasks) {
            try {
                const chartElement = document.getElementById('priorityChart');
                if (!chartElement) {
                    console.debug('Priority chart element not found');
                    return;
                }
                
                if (window.priorityChart && typeof window.priorityChart.destroy === 'function') {
                    window.priorityChart.destroy();
                }

                if (!tasks || tasks.length === 0) {
                    const options = {
                        series: [{
                            name: 'Tasks',
                            data: [0]
                        }],
                        chart: {
                            type: 'bar',
                            height: 300,
                            fontFamily: 'Outfit, sans-serif',
                            toolbar: {
                                show: false
                            }
                        },
                        plotOptions: {
                            bar: {
                                borderRadius: 8,
                                columnWidth: '60%',
                                distributed: false
                            }
                        },
                        dataLabels: {
                            enabled: false
                        },
                        xaxis: {
                            categories: ['No Data'],
                            labels: {
                                style: {
                                    fontFamily: 'Outfit, sans-serif',
                                    fontSize: '12px',
                                    fontWeight: 400,
                                    colors: ['#373d3f']
                                }
                            },
                            axisBorder: {
                                show: false
                            },
                            axisTicks: {
                                show: false
                            }
                        },
                        yaxis: {
                            labels: {
                                style: {
                                    fontFamily: 'Outfit, sans-serif',
                                    fontSize: '11px',
                                    fontWeight: 400,
                                    colors: ['#373d3f']
                                }
                            }
                        },
                        colors: ['#465FFF'],
                        fill: {
                            type: 'gradient',
                            gradient: {
                                shade: 'light',
                                type: 'vertical',
                                shadeIntensity: 0.25,
                                gradientToColors: ['#A3AFFF'],
                                inverseColors: true,
                                opacityFrom: 1,
                                opacityTo: 0.85,
                                stops: [0, 100]
                            }
                        },
                        grid: {
                            borderColor: '#e0e0e0',
                            strokeDashArray: 0,
                            xaxis: {
                                lines: {
                                    show: false
                                }
                            },
                            yaxis: {
                                lines: {
                                    show: true
                                }
                            }
                        },
                        tooltip: {
                            style: {
                                fontFamily: 'Outfit, sans-serif'
                            }
                        },
                        legend: {
                            show: false
                        }
                    };
                    window.priorityChart = new ApexCharts(chartElement, options);
                    window.priorityChart.render();
                    return;
                }

                const priorityCounts = {
                    'urgent': 0,
                    'high': 0,
                    'medium': 0,
                    'low': 0
                };

                tasks.forEach(task => {
                    if (priorityCounts.hasOwnProperty(task.priority)) {
                        priorityCounts[task.priority]++;
                    }
                });

                const options = {
                    series: [{
                        name: 'Tasks',
                        data: [priorityCounts.urgent, priorityCounts.high, priorityCounts.medium, priorityCounts.low]
                    }],
                    chart: {
                        type: 'bar',
                        height: 300,
                        fontFamily: 'Outfit, sans-serif',
                        toolbar: {
                            show: false
                        }
                    },
                    plotOptions: {
                        bar: {
                            borderRadius: 8,
                            columnWidth: '60%',
                            distributed: false
                        }
                    },
                    dataLabels: {
                        enabled: false
                    },
                    xaxis: {
                        categories: ['Urgent', 'High', 'Medium', 'Low'],
                        labels: {
                            style: {
                                fontFamily: 'Outfit, sans-serif',
                                fontSize: '12px',
                                fontWeight: 400,
                                colors: ['#373d3f']
                            }
                        },
                        axisBorder: {
                            show: false
                        },
                        axisTicks: {
                            show: false
                        }
                    },
                    yaxis: {
                        labels: {
                            style: {
                                fontFamily: 'Outfit, sans-serif',
                                fontSize: '11px',
                                fontWeight: 400,
                                colors: ['#373d3f']
                            }
                        }
                    },
                    colors: ['#465FFF'],
                    fill: {
                        type: 'gradient',
                        gradient: {
                            shade: 'light',
                            type: 'vertical',
                            shadeIntensity: 0.25,
                            gradientToColors: ['#A3AFFF'],
                            inverseColors: true,
                            opacityFrom: 1,
                            opacityTo: 0.85,
                            stops: [0, 100]
                        }
                    },
                    grid: {
                        borderColor: '#e0e0e0',
                        strokeDashArray: 0,
                        xaxis: {
                            lines: {
                                show: false
                            }
                        },
                        yaxis: {
                            lines: {
                                show: true
                            }
                        }
                    },
                    tooltip: {
                        style: {
                            fontFamily: 'Outfit, sans-serif'
                        }
                    },
                    legend: {
                        show: false
                    }
                };

                window.priorityChart = new ApexCharts(chartElement, options);
                window.priorityChart.render();
            } catch (error) {
                console.error('Error updating priority chart:', error);
                showNotification('Error', 'Error updating priority chart', 'error');
            }
        }

        // Tag Distribution Chart
        function updateTagChart(tasks) {
            try {
                const chartElement = document.getElementById('tagChart');
                if (!chartElement) {
                    console.debug('Tag chart element not found');
                    return;
                }
                
                if (window.tagChart && typeof window.tagChart.destroy === 'function') {
                    window.tagChart.destroy();
                }

                if (!tasks || tasks.length === 0) {
                    const options = {
                        series: [1],
                        chart: {
                            type: 'pie',
                            height: 300
                        },
                        labels: ['No Data'],
                        colors: ['#e0e0e0'],
                        legend: {
                            show: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    };
                    window.tagChart = new ApexCharts(chartElement, options);
                    window.tagChart.render();
                    return;
                }

                const tagCounts = {};
                const tagNames = {
                    'blue': 'New Development',
                    'red': 'Bug',
                    'purple': 'Design',
                    'green': 'Enhancement',
                    'yellow': 'Ad Hoc'
                };
                
                tasks.forEach(task => {
                    if (task.tag) {
                        const tagName = tagNames[task.tag] || task.tag;
                        tagCounts[tagName] = (tagCounts[tagName] || 0) + 1;
                    }
                });

                const labels = Object.keys(tagCounts);
                const data = Object.values(tagCounts);
                const colors = ['#465FFF', '#8B92FF', '#A3AFFF', '#C4CBFF', '#E1E5FF'];

                const options = {
                    series: data,
                    chart: {
                        type: 'pie',
                        height: 300,
                        fontFamily: 'Outfit, sans-serif',
                        toolbar: {
                            show: false
                        }
                    },
                    labels: labels,
                    colors: colors,
                    legend: {
                        position: 'right',
                        fontFamily: 'Outfit, sans-serif',
                        fontSize: '14px',
                        fontWeight: 500,
                        labels: {
                            colors: ['#374151']
                        }
                    },
                    plotOptions: {
                        pie: {
                            expandOnClick: false,
                            donut: {
                                labels: {
                                    show: false
                                }
                            }
                        }
                    },
                    dataLabels: {
                        enabled: true,
                        style: {
                            fontFamily: 'Outfit, sans-serif',
                            fontSize: '12px',
                            fontWeight: 600,
                            colors: ['#fff']
                        },
                        dropShadow: {
                            enabled: false
                        }
                    },
                    tooltip: {
                        style: {
                            fontFamily: 'Outfit, sans-serif'
                        }
                    }
                };

                window.tagChart = new ApexCharts(chartElement, options);
                window.tagChart.render();
            } catch (error) {
                console.error('Error updating tag chart:', error);
                showNotification('Error', 'Error updating tag chart', 'error');
            }
        }

        // Assignee Workload Chart
        function updateAssigneeChart(tasks) {
            try {
                const chartElement = document.getElementById('assigneeChart');
                if (!chartElement) {
                    console.debug('Assignee chart element not found');
                    return;
                }
                
                if (window.assigneeChart && typeof window.assigneeChart.destroy === 'function') {
                    window.assigneeChart.destroy();
                }

                if (!tasks || tasks.length === 0) {
                    const options = {
                        series: [{
                            data: [0]
                        }],
                        chart: {
                            type: 'bar',
                            height: 300
                        },
                        xaxis: {
                            categories: ['No Data']
                        },
                        colors: ['#e0e0e0'],
                        legend: {
                            show: false
                        },
                        tooltip: {
                            enabled: false
                        }
                    };
                    window.assigneeChart = new ApexCharts(chartElement, options);
                    window.assigneeChart.render();
                    return;
                }

                const assigneeCounts = {};
                tasks.forEach(task => {
                    if (task.assignedUser) {
                        assigneeCounts[task.assignedUser] = (assigneeCounts[task.assignedUser] || 0) + 1;
                    }
                });

                const labels = Object.keys(assigneeCounts);
                const data = Object.values(assigneeCounts);
                const colors = ['#465FFF', '#8B92FF', '#A3AFFF', '#C4CBFF', '#E1E5FF'];

                const options = {
                    series: [{
                        name: 'Tasks Assigned',
                        data: data
                    }],
                    chart: {
                        type: 'bar',
                        height: 300,
                        fontFamily: 'Outfit, sans-serif',
                        toolbar: {
                            show: false
                        }
                    },
                    plotOptions: {
                        bar: {
                            borderRadius: 8,
                            columnWidth: '60%',
                            distributed: true
                        }
                    },
                    dataLabels: {
                        enabled: false
                    },
                    xaxis: {
                        categories: labels,
                        labels: {
                            style: {
                                fontFamily: 'Outfit, sans-serif',
                                fontSize: '12px',
                                fontWeight: 400,
                                colors: ['#373d3f']
                            }
                        },
                        axisBorder: {
                            show: false
                        },
                        axisTicks: {
                            show: false
                        }
                    },
                    yaxis: {
                        labels: {
                            style: {
                                fontFamily: 'Outfit, sans-serif',
                                fontSize: '11px',
                                fontWeight: 400,
                                colors: ['#373d3f']
                            }
                        }
                    },
                    colors: colors,
                    fill: {
                        type: 'gradient',
                        gradient: {
                            shade: 'light',
                            type: 'vertical',
                            shadeIntensity: 0.25,
                            gradientToColors: ['#A3AFFF', '#C4CBFF', '#E1E5FF', '#F0F2FF', '#F8F9FF'],
                            inverseColors: true,
                            opacityFrom: 1,
                            opacityTo: 0.85,
                            stops: [0, 100]
                        }
                    },
                    grid: {
                        borderColor: '#e0e0e0',
                        strokeDashArray: 0,
                        xaxis: {
                            lines: {
                                show: false
                            }
                        },
                        yaxis: {
                            lines: {
                                show: true
                            }
                        }
                    },
                    tooltip: {
                        style: {
                            fontFamily: 'Outfit, sans-serif'
                        }
                    },
                    legend: {
                        show: false
                    }
                };

                window.assigneeChart = new ApexCharts(chartElement, options);
                window.assigneeChart.render();
            } catch (error) {
                console.error('Error updating assignee chart:', error);
                showNotification('Error', 'Error updating assignee chart', 'error');
            }
        }

        // Timeline Chart
        function updateTimelineChart(tasks) {
            try {
                const chartElement = document.getElementById('timelineChart');
                if (!chartElement) {
                    console.debug('Timeline chart element not found');
                    return;
                }
                
                if (window.timelineChart && typeof window.timelineChart.destroy === 'function') {
                    window.timelineChart.destroy();
                }

                if (!tasks || tasks.length === 0) {
                    const options = {
                        series: [{
                            data: [0]
                        }],
                        chart: {
                            type: 'line',
                            height: 300,
                            fontFamily: 'Outfit, sans-serif',
                            toolbar: {
                                show: false
                            },
                            zoom: {
                                enabled: false
                            }
                        },
                        dataLabels: {
                            enabled: false
                        },
                        stroke: {
                            width: 3,
                            curve: 'smooth'
                        },
                        markers: {
                            size: 6,
                            colors: ['#465FFF'],
                            strokeColors: '#fff',
                            strokeWidth: 2,
                            hover: {
                                size: 8
                            }
                        },
                        xaxis: {
                            categories: ['No Data'],
                            labels: {
                                style: {
                                    fontFamily: 'Outfit, sans-serif',
                                    fontSize: '12px',
                                    fontWeight: 400,
                                    colors: ['#373d3f']
                                }
                            },
                            axisBorder: {
                                show: false
                            },
                            axisTicks: {
                                show: false
                            }
                        },
                        yaxis: {
                            labels: {
                                style: {
                                    fontFamily: 'Outfit, sans-serif',
                                    fontSize: '11px',
                                    fontWeight: 400,
                                    colors: ['#373d3f']
                                }
                            }
                        },
                        colors: ['#465FFF'],
                        fill: {
                            type: 'gradient',
                            gradient: {
                                shade: 'light',
                                type: 'vertical',
                                shadeIntensity: 0.4,
                                gradientToColors: ['#A3AFFF'],
                                inverseColors: false,
                                opacityFrom: 0.5,
                                opacityTo: 0.1,
                                stops: [0, 100]
                            }
                        },
                        grid: {
                            borderColor: '#e0e0e0',
                            strokeDashArray: 0,
                            xaxis: {
                                lines: {
                                    show: false
                                }
                            },
                            yaxis: {
                                lines: {
                                    show: true
                                }
                            }
                        },
                        tooltip: {
                            style: {
                                fontFamily: 'Outfit, sans-serif'
                            },
                            x: {
                                format: 'MMM dd'
                            }
                        },
                        legend: {
                            show: false
                        }
                    };
                    window.timelineChart = new ApexCharts(chartElement, options);
                    window.timelineChart.render();
                    return;
                }

                const last7Days = Array.from({length: 7}, (_, i) => {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    return date.toISOString().split('T')[0];
                }).reverse();

                const taskCounts = last7Days.map(date => 
                    tasks.filter(task => task.dueDate === date).length
                );

                const options = {
                    series: [{
                        name: 'Tasks Due',
                        data: taskCounts
                    }],
                    chart: {
                        type: 'line',
                        height: 300,
                        fontFamily: 'Outfit, sans-serif',
                        toolbar: {
                            show: false
                        },
                        zoom: {
                            enabled: false
                        }
                    },
                    dataLabels: {
                        enabled: false
                    },
                    stroke: {
                        width: 3,
                        curve: 'smooth'
                    },
                    markers: {
                        size: 6,
                        colors: ['#465FFF'],
                        strokeColors: '#fff',
                        strokeWidth: 2,
                        hover: {
                            size: 8
                        }
                    },
                    xaxis: {
                        categories: last7Days.map(date => new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                        labels: {
                            style: {
                                fontFamily: 'Outfit, sans-serif',
                                fontSize: '12px',
                                fontWeight: 400,
                                colors: ['#373d3f']
                            }
                        },
                        axisBorder: {
                            show: false
                        },
                        axisTicks: {
                            show: false
                        }
                    },
                    yaxis: {
                        labels: {
                            style: {
                                fontFamily: 'Outfit, sans-serif',
                                fontSize: '11px',
                                fontWeight: 400,
                                colors: ['#373d3f']
                            }
                        }
                    },
                    colors: ['#465FFF'],
                    fill: {
                        type: 'gradient',
                        gradient: {
                            shade: 'light',
                            type: 'vertical',
                            shadeIntensity: 0.4,
                            gradientToColors: ['#A3AFFF'],
                            inverseColors: false,
                            opacityFrom: 0.5,
                            opacityTo: 0.1,
                            stops: [0, 100]
                        }
                    },
                    grid: {
                        borderColor: '#e0e0e0',
                        strokeDashArray: 0,
                        xaxis: {
                            lines: {
                                show: false
                            }
                        },
                        yaxis: {
                            lines: {
                                show: true
                            }
                        }
                    },
                    tooltip: {
                        style: {
                            fontFamily: 'Outfit, sans-serif'
                        },
                        x: {
                            format: 'MMM dd'
                        }
                    },
                    legend: {
                        show: false
                    }
                };

                window.timelineChart = new ApexCharts(chartElement, options);
                window.timelineChart.render();
            } catch (error) {
                console.error('Error updating timeline chart:', error);
                showNotification('Error', 'Error updating timeline chart', 'error');
            }
        }

        // Update metrics when tasks change
        const originalUpdateTaskCounters = updateTaskCounters;
        updateTaskCounters = function() {
            originalUpdateTaskCounters();
            // Only update metrics if metrics view is active
            try {
                const alpineElement = document.querySelector('[x-data]');
                if (alpineElement && alpineElement.__x && alpineElement.__x.$data && alpineElement.__x.$data.activeView === 'metrics') {
                    updateMetrics(); // This calls with showNotifications=true by default
                }
            } catch (error) {
                // Silently ignore Alpine.js access errors during initialization
                console.debug('Alpine.js not ready for metrics update');
            }
        };

        const originalUpdateTableView = updateTableView;
        updateTableView = async function() {
            await originalUpdateTableView();
            // Only update metrics if metrics view is active
            try {
                const alpineElement = document.querySelector('[x-data]');
                if (alpineElement && alpineElement.__x && alpineElement.__x.$data && alpineElement.__x.$data.activeView === 'metrics') {
                    updateMetrics(); // This calls with showNotifications=true by default
                }
            } catch (error) {
                // Silently ignore Alpine.js access errors during initialization
                console.debug('Alpine.js not ready for metrics update');
            }
        };

        // Initialize metrics when metrics tab is clicked
        // Removed the following event listener as it's redundant with the Alpine watcher
        /*
        document.addEventListener('click', function(e) {
            if (e.target.closest('button') && e.target.textContent.includes('Metrics')) {
        setTimeout(() => {
            updateMetrics(false);
                }, 100);
            }
        });
        */

        // Also initialize metrics after initial data load
        setTimeout(() => {
            try {
                const alpineElement = document.querySelector('[x-data]');
                if (alpineElement && alpineElement.__x && alpineElement.__x.$data && alpineElement.__x.$data.activeView === 'metrics') {
                    updateMetrics();
                }
            } catch (error) {
                console.debug('Alpine.js not ready for initial metrics update');
            }
        }, 2000);
        });

        // Update notification function to handle error type
        function showNotification(title, message, type = 'notification') {
            const container = document.getElementById('notificationsContainer');
            const notification = document.createElement('div');
            
            const bgColor = type === 'error' 
                ? 'bg-red-100' 
                : type === 'message' 
                    ? 'bg-blue-100' 
                    : type === 'success'
                        ? 'bg-green-100'
                        : 'bg-green-100';
            
            const iconColor = type === 'error'
                ? 'text-red-600'
                : type === 'message'
                    ? 'text-blue-600'
                    : type === 'success'
                        ? 'text-green-600'
                        : 'text-green-600';

            const icon = type === 'error'
                ? `<svg class="h-6 w-6 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>`
                : type === 'message'
                    ? `<svg class="h-6 w-6 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                    </svg>`
                    : type === 'success'
                        ? `<svg class="h-6 w-6 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>`
                        : `<svg class="h-6 w-6 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                        </svg>`;

            notification.className = `flex items-center gap-4 rounded-lg border border-gray-200 bg-white p-4 shadow-lg notification-item`;
            
            notification.innerHTML = `
                <div class="flex h-10 w-10 items-center justify-center rounded-full ${bgColor}">
                    ${icon}
                </div>
                <div class="flex-1">
                    <h4 class="!text-md font-medium text-gray-900">${title}</h4>
                    <p class="!text-md text-gray-500">${message}</p>
                </div>
                <button class="text-gray-400 hover:text-gray-500 close-notification">
                    <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            `;

            container.appendChild(notification);

            // Add close button functionality
            const closeButton = notification.querySelector('.close-notification');
            closeButton.addEventListener('click', () => {
                notification.remove();
            });

            // Auto close after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Feedback form functions
        function toggleFeedbackForm() {
            const modal = document.getElementById('feedbackModal');
            modal.classList.toggle('hidden');
        }

        async function submitFeedback(event) {
            event.preventDefault();
            
            const feedbackData = {
                id: `fb_${Date.now()}`,
                name: document.getElementById('feedbackName').value || 'Anonymous',
                type: document.getElementById('feedbackType').value,
                message: document.getElementById('feedbackMessage').value,
                timestamp: new Date().toISOString()
            };

            try {
                // First, get the attachment ID for feedback.json
                const attachmentsResponse = await fetch('https://cedt-confluence.net/confluence/rest/api/content/2740868871/child/attachment?filename=feedback.json');
                const attachmentsData = await attachmentsResponse.json();
                
                let attachmentId;
                let existingFeedback = { feedback: [], metadata: { lastUpdated: '', totalFeedback: 0, feedbackTypes: {} } };

                if (attachmentsData.results && attachmentsData.results.length > 0) {
                    // If feedback.json exists, get its content
                    attachmentId = attachmentsData.results[0].id;
                    const feedbackResponse = await fetch(`https://cedt-confluence.net/confluence/download/attachments/2740868871/feedback.json?api=v2`);
                    if (feedbackResponse.ok) {
                        existingFeedback = await feedbackResponse.json();
                    }
                }

                // Add new feedback
                existingFeedback.feedback.unshift(feedbackData);

                // Update metadata
                existingFeedback.metadata = {
                    lastUpdated: feedbackData.timestamp,
                    totalFeedback: existingFeedback.feedback.length,
                    feedbackTypes: existingFeedback.feedback.reduce((acc, fb) => {
                        acc[fb.type] = (acc[fb.type] || 0) + 1;
                        return acc;
                    }, {})
                };

                // Create or update the attachment
                const formData = new FormData();
                const blob = new Blob([JSON.stringify(existingFeedback, null, 2)], { type: 'application/json' });
                formData.append('file', blob, 'feedback.json');

                const response = await fetch(`https://cedt-confluence.net/confluence/rest/api/content/2740868871/child/attachment${attachmentId ? `/${attachmentId}` : ''}`, {
                    method: 'POST',
                    headers: {
                        'X-Atlassian-Token': 'no-check'
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Failed to save feedback: ${response.status} ${response.statusText}`);
                }

                showNotification('Success', 'Thank you for your feedback!', 'success');
                document.getElementById('feedbackForm').reset();
                toggleFeedbackForm();
            } catch (error) {
                console.error('Error submitting feedback:', error);
                showNotification('Error', 'Failed to submit feedback. Please try again.', 'error');
            }
        }

        // Helper function to create task card HTML
        function createTaskCardHTML(task) {
            const tagColors = {
                blue: 'bg-blue-100 text-blue-800',
                purple: 'bg-purple-100 text-purple-800', 
                yellow: 'bg-orange-100 text-orange-800',
                green: 'bg-green-100 text-green-800',
                red: 'bg-red-100 text-red-800'
            };

            const tagColor = tagColors[task.tag] || 'bg-gray-100 text-gray-800';

            // Get user avatar (using initials)
            const getUserAvatar = (userName) => {
                if (!userName) return 'UN';
                const initials = userName.split(' ').map(name => name.charAt(0)).join('').toUpperCase();
                return initials.substring(0, 2);
            };

            // Get avatar color based on user name
            const getAvatarColor = (userName) => {
                const colors = [
                    'bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-pink-500', 
                    'bg-indigo-500', 'bg-yellow-500', 'bg-red-500', 'bg-gray-500'
                ];
                if (!userName) return colors[0];
                const hash = userName.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
                return colors[hash % colors.length];
            };

            // Get secondary tags based on task type
            const getSecondaryTags = (task) => {
                const secondaryTagsMap = {
                    'blue': ['Operations'], // New Development
                    'red': ['Development'], // Bug
                    'purple': ['UI/UX'], // Design  
                    'green': ['Social media'], // Enhancement
                    'yellow': ['Research'] // Ad Hoc
                };
                
                const tags = secondaryTagsMap[task.tag] || [];
                
                // Add additional contextual tags
                if (task.assignedUser && task.assignedUser.includes('User 1')) tags.push('CRM');
                if (task.title.toLowerCase().includes('feedback')) tags.push('Feedback');
                if (task.title.toLowerCase().includes('marketing')) tags.push('Marketing');
                if (task.title.toLowerCase().includes('sales')) tags.push('Sales');
                
                return tags;
            };

            const secondaryTags = getSecondaryTags(task);

            // Get tag icon
            const getTagIcon = (tag) => {
                switch(tag) {
                    case 'blue': // New Development
                        return `<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"></path>
                        </svg>`;
                    case 'red': // Bug
                        return `<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>`;
                    case 'purple': // Design
                        return `<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
                        </svg>`;
                    case 'green': // Enhancement
                        return `<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                        </svg>`;
                    case 'yellow': // Ad Hoc
                        return `<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                        </svg>`;
                    default:
                        return `<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                        </svg>`;
                }
            };

            // Get priority icon
            const getPriorityIcon = (priority) => {
                switch(priority) {
                    case 'urgent':
                        return `<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>`;
                    case 'high':
                        return `<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>`;
                    case 'medium':
                        return `<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                        </svg>`;
                    case 'low':
                        return `<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>`;
                    default:
                        return `<svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path>
                        </svg>`;
                }
            };

            // Get priority color
            const getPriorityColor = (priority) => {
                const priorityColors = {
                    'urgent': 'bg-red-100 text-red-700',
                    'high': 'bg-orange-100 text-orange-700',
                    'medium': 'bg-yellow-100 text-yellow-700',
                    'low': 'bg-green-100 text-green-700',
                    'none': 'bg-gray-100 text-gray-700'
                };
                return priorityColors[priority] || 'bg-gray-100 text-gray-700';
            };

            // Mock comment count
            const commentCount = Math.floor(Math.random() * 12) + 1;
            
            // Mock attachment count  
            const attachmentCount = Math.floor(Math.random() * 4);

            // Truncate description
            const getDescription = (task) => {
                const descriptions = [
                    "Organize schedules for team coverage over the holiday period.",
                    "Collect and analyze feedback from recent user tests.",
                    "Create visual assets for the upcoming product launch campaign.",
                    "Contact potential clients from the latest lead list.",
                    "Resolve reported issues in the payment processing system.",
                    "Gather feedback and discuss project milestones with the client.",
                    "Research key competitors and summarize their strategies.",
                    "Develop a posting schedule and content ideas for upcoming campaigns."
                ];
                return descriptions[Math.floor(Math.random() * descriptions.length)];
            };

            return `
                <div class="group bg-white rounded-lg p-4 mb-4 shadow-sm border border-gray-200 hover:shadow-md transition-shadow duration-200 cursor-pointer" 
                     style="min-height: 200px;" 
                     oncontextmenu="showTaskMenu(event, '${task.id}')" 
                     onclick="showTaskDetails('${task.id}')">
                    
                    <!-- Header with tags and action buttons -->
                    <div class="flex items-start justify-between mb-3">
                        <!-- Tags Section -->
                        <div class="flex flex-wrap gap-2">
                            <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded ${tagColor}">
                                ${getTagIcon(task.tag)}
                                ${getTagName(task.tag)}
                            </span>
                            <span class="inline-flex items-center px-2 py-1 text-xs font-medium rounded ${getPriorityColor(task.priority)}">
                                ${getPriorityIcon(task.priority)}
                                ${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}
                            </span>
                        </div>
                        
                        <!-- Action buttons -->
                        <div class="flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="event.stopPropagation(); editTask('${task.id}')" class="p-1 text-gray-400 hover:text-blue-600 hover:bg-blue-50 rounded transition-colors" title="Edit">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                </svg>
                            </button>
                            <button onclick="event.stopPropagation(); viewLifecycleHistory('${task.id}')" class="p-1 text-gray-400 hover:text-green-600 hover:bg-green-50 rounded transition-colors" title="View History">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </button>
                            <button onclick="event.stopPropagation(); deleteTask('${task.id}')" class="p-1 text-gray-400 hover:text-red-600 hover:bg-red-50 rounded transition-colors" title="Delete">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1-1H9a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Task Title -->
                    <h3 class="text-base font-semibold text-gray-900 mb-2 leading-6">${task.title}</h3>
                    
                    <!-- Description -->
                    <p class="text-sm text-gray-600 mb-4 leading-5">${getDescription(task)}</p>

                    <!-- Bottom section with user badge and due date -->
                    <div class="flex items-center justify-between">
                        <!-- Assigned user badge -->
                        <div class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-700">
                            ${task.assignedUser || 'Unassigned'}
                        </div>

                        <!-- Due date with clock icon -->
                        <div class="flex items-center text-xs text-gray-500">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            ${getDaysUntilDeadline(task.dueDate)}
                        </div>
                    </div>
                </div>
            `;
        }

        // Helper function to get tag name
        function getTagName(tag) {
            const tagNames = {
                blue: 'New Development',
                red: 'Bug',
                purple: 'Design',
                green: 'Enhancement',
                yellow: 'Ad Hoc'
            };
            return tagNames[tag] || 'Other';
        }

        // Helper function to get status color
        function getStatusColor(status) {
            const statusColors = {
                'todo': 'bg-yellow-100 text-yellow-800', // Updated to match metrics table
                'progress': 'bg-blue-100 text-blue-800',  // Updated to match metrics table
                'review': 'bg-purple-100 text-purple-800',// Updated to match metrics table
                'done': 'bg-green-100 text-green-800'  // Added for consistency, though 'done' tasks might not appear here often
            };
            return statusColors[status] || 'bg-gray-100 text-gray-800';
        }

        // Helper function to calculate days until deadline
        function getDaysUntilDeadline(dueDate) {
            if (!dueDate) return 'No deadline';
            
            const today = new Date();
            const deadline = new Date(dueDate);
            const timeDiff = deadline.getTime() - today.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
            
            if (daysDiff < 0) {
                return `${Math.abs(daysDiff)} days overdue`;
            } else if (daysDiff === 0) {
                return 'Due today';
            } else {
                return daysDiff;
            }
        }

        // Helper function to get color based on days until deadline
        function getDaysUntilDeadlineColor(dueDate) {
            if (!dueDate) return 'text-gray-500';
            
            const today = new Date();
            const deadline = new Date(dueDate);
            const timeDiff = deadline.getTime() - today.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
            
            if (daysDiff < 0) {
                return 'text-red-600'; // Overdue
            } else if (daysDiff <= 13) {
                return 'text-red-600'; // 0-13 days - red
            } else if (daysDiff <= 30) {
                return 'text-amber-600'; // 14-30 days - amber
            } else {
                return 'text-green-600'; // >30 days - green
            }
        }

        // Helper function to format date
        function formatDate(dateString) {
            if (!dateString) return 'No date';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Helper function to update task counters
        function updateTaskCounters() {
            const columns = ['todo', 'progress', 'review', 'done'];
            columns.forEach(column => {
                const columnElement = document.getElementById(`${column}-column`);
                const counter = columnElement.parentElement.querySelector('.task-counter');
                const taskCount = columnElement.children.length;
                counter.textContent = taskCount;
            });
        }

        // Helper function to update table view
        async function updateTableView() {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';

            try {
                const tasks = await fetchTasks();
                
                if (!tasks || tasks.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="8" class="px-6 py-4 text-center text-gray-500">No tasks available or failed to load.</td>
                    `;
                    tableBody.appendChild(row);
                    return;
                }

                tasks.forEach(task => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap !text-md font-medium text-gray-900">${task.title}</td>
                        <td class="px-6 py-4 whitespace-nowrap !text-md text-gray-500">${getTagName(task.tag)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex !text-md leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                                ${task.priority}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap !text-md text-gray-500">${getStatusDisplayName(task.column)}</td>
                        <td class="px-6 py-4 whitespace-nowrap !text-md text-gray-500">${task.assignedUser || 'Unassigned'}</td>
                        <td class="px-6 py-4 whitespace-nowrap !text-md text-gray-500">${task.dueDate || 'Not set'}</td>
                        <td class="px-6 py-4 whitespace-nowrap !text-md text-gray-500">
                            <span class="${getDaysUntilDeadlineColor(task.dueDate)}">${getDaysUntilDeadline(task.dueDate)}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap !text-md font-medium">
                            <button onclick="editTask('${task.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2">Edit</button>
                            <button onclick="viewLifecycleHistory('${task.id}')" class="text-blue-600 hover:text-blue-900 mr-2">History</button>
                            <button onclick="deleteTask('${task.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
                
                // Reapply search filter if one is active
                if (typeof applySearchFilter === 'function') {
                    applySearchFilter();
                }
            } catch (error) {
                console.error('Error loading table data:', error);
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="8" class="px-6 py-4 text-center text-red-500">Error loading tasks. Please try again.</td>
                `;
                tableBody.appendChild(row);
            }
        }

        // Helper function to get all tasks from DOM
        function getAllTasksFromDOM() {
            const tasks = [];
            const columns = ['todo', 'progress', 'review', 'done'];
            
            columns.forEach(column => {
                const columnElement = document.getElementById(`${column}-column`);
                const taskCards = columnElement.querySelectorAll('.task-card');
                
                taskCards.forEach(card => {
                    const task = {
                        id: card.dataset.id,
                        title: card.querySelector('h3').textContent,
                        description: card.querySelector('p').textContent,
                        tag: getTagFromCard(card),
                        priority: card.dataset.priority,
                        assignedUser: card.dataset.assignedUser,
                        submittedBy: card.dataset.submittedBy,
                        startDate: card.dataset.startDate,
                        dueDate: card.dataset.dueDate,
                        column: column
                    };
                    tasks.push(task);
                });
            });
            
            return tasks;
        }

        // Helper function to get tag from card
        function getTagFromCard(card) {
            const tagSpan = card.querySelector('span');
            const tagText = tagSpan.textContent;
            const tagMap = {
                'New Development': 'blue',
                'Bug': 'red',
                'Design': 'purple',
                'Enhancement': 'green',
                'Ad Hoc': 'yellow'
            };
            return tagMap[tagText] || 'blue';
        }

        // Task menu functions
        function toggleTaskMenu(taskId) {
            const menu = document.getElementById(`menu-${taskId}`);
            // Close all other menus first
            document.querySelectorAll('[id^="menu-"]').forEach(m => {
                if (m.id !== `menu-${taskId}`) {
                    m.classList.add('hidden');
                }
            });
            menu.classList.toggle('hidden');
        }

        // Edit task function
        async function editTask(taskId) {
            const taskCard = document.querySelector(`[data-id="${taskId}"]`);
            if (!taskCard) return;

            try {
                // Get task data from server to get complete task info
                const tasks = await fetchTasks();
                const task = tasks.find(t => t.id === taskId);
                
                if (!task) {
                    showNotification('Error', 'Task not found', 'error');
                    return;
                }
                
                // Populate form with existing data from the task object
                document.getElementById('task-id').value = taskId;
                document.getElementById('task-title').value = task.title || '';
                document.getElementById('task-description').value = task.description || '';
                document.getElementById('task-tag').value = task.tag || 'blue';
                document.getElementById('task-priority').value = task.priority || 'none';
                document.getElementById('task-assigned-user').value = task.assignedUser || '';
                document.getElementById('task-submitted-by').value = task.submittedBy || '';
                document.getElementById('task-start-date').value = task.startDate || '';
                document.getElementById('task-due').value = task.dueDate || '';
                document.getElementById('form-column').value = task.column || 'todo';

                // Show modal
                document.getElementById('task-modal').classList.remove('hidden');
                
                // Hide menu
                document.getElementById(`menu-${taskId}`).classList.add('hidden');
            } catch (error) {
                console.error('Error loading task data for editing:', error);
                showNotification('Error', 'Error loading task data', 'error');
            }
        }

        // Delete task function
        async function deleteTask(taskId) {
            // Hide menu first
            const menuElement = document.getElementById(`menu-${taskId}`);
            if (menuElement) {
                menuElement.classList.add('hidden');
            }
            
            if (confirm('Are you sure you want to delete this task?')) {
                try {
                    const tasks = await fetchTasks();
                    const taskToDelete = tasks.find(task => task.id === taskId);
                    
                    if (!taskToDelete) {
                        showNotification('Error', 'Task not found', 'error');
                        return;
                    }
                    
                    const updatedTasks = tasks.filter(task => task.id !== taskId);
                    await saveTasks(updatedTasks, false);
                    await loadTasksFromConfluence(false);
                    showNotification('Success', 'Task deleted successfully', 'success');
                } catch (error) {
                    console.error('Error deleting task:', error);
                    showNotification('Error', 'Error deleting task. Please try again.', 'error');
                }
            }
        }

        // Export to Excel function
        document.getElementById('export-excel').addEventListener('click', async function() {
            try {
                // Get complete task data from server including lifecycle
                const tasks = await fetchTasks();
                
                // Prepare tasks data for export
                const exportData = tasks.map(task => {
                    // Format lifecycle data as a readable string
                    let lifecycleHistory = '';
                    if (task.lifecycle && task.lifecycle.length > 0) {
                        lifecycleHistory = task.lifecycle.map(entry => {
                            const fromStatus = entry.fromStatus ? getStatusDisplayName(entry.fromStatus) : 'Created';
                            const toStatus = getStatusDisplayName(entry.toStatus);
                            const timestamp = formatDateTime(entry.timestamp);
                            return `${timestamp}: ${entry.updatedBy} - ${fromStatus} → ${toStatus} (${entry.updateType}) - ${entry.comments}`;
                        }).join('\n');
                    }
                    
                    return {
                        'Task ID': task.id,
                        'Title': task.title,
                        'Description': task.description,
                        'Tag': getTagName(task.tag),
                        'Priority': task.priority,
                        'Assigned User': task.assignedUser || 'Unassigned',
                        'Submitted By': task.submittedBy || 'Unknown',
                        'Start Date': task.startDate || 'Not set',
                        'Due Date': task.dueDate || 'Not set',
                        'Current Status': getStatusDisplayName(task.column),
                        'Days Until Deadline': getDaysUntilDeadline(task.dueDate),
                        'Created At': formatDateTime(task.createdAt),
                        'Last Updated': formatDateTime(task.updatedAt),
                        'Lifecycle History': lifecycleHistory
                    };
                });
                
                // Create workbook with tasks
                const ws = XLSX.utils.json_to_sheet(exportData);
                
                // Auto-size columns
                const colWidths = [
                    { wch: 15 }, // Task ID
                    { wch: 30 }, // Title
                    { wch: 40 }, // Description
                    { wch: 15 }, // Tag
                    { wch: 10 }, // Priority
                    { wch: 15 }, // Assigned User
                    { wch: 15 }, // Submitted By
                    { wch: 12 }, // Start Date
                    { wch: 12 }, // Due Date
                    { wch: 15 }, // Current Status
                    { wch: 20 }, // Days Until Deadline
                    { wch: 20 }, // Created At
                    { wch: 20 }, // Last Updated
                    { wch: 60 }  // Lifecycle History
                ];
                ws['!cols'] = colWidths;
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Tasks");
                
                // Create a separate sheet for detailed lifecycle data
                if (tasks.some(task => task.lifecycle && task.lifecycle.length > 0)) {
                    const lifecycleData = [];
                    tasks.forEach(task => {
                        if (task.lifecycle && task.lifecycle.length > 0) {
                            task.lifecycle.forEach(entry => {
                                lifecycleData.push({
                                    'Task ID': task.id,
                                    'Task Title': task.title,
                                    'Timestamp': formatDateTime(entry.timestamp),
                                    'Updated By': entry.updatedBy,
                                    'From Status': entry.fromStatus ? getStatusDisplayName(entry.fromStatus) : 'Created',
                                    'To Status': getStatusDisplayName(entry.toStatus),
                                    'Update Type': entry.updateType,
                                    'Comments': entry.comments
                                });
                            });
                        }
                    });
                    
                    if (lifecycleData.length > 0) {
                        const lifecycleWs = XLSX.utils.json_to_sheet(lifecycleData);
                        const lifecycleColWidths = [
                            { wch: 15 }, // Task ID
                            { wch: 30 }, // Task Title
                            { wch: 20 }, // Timestamp
                            { wch: 15 }, // Updated By
                            { wch: 15 }, // From Status
                            { wch: 15 }, // To Status
                            { wch: 15 }, // Update Type
                            { wch: 50 }  // Comments
                        ];
                        lifecycleWs['!cols'] = lifecycleColWidths;
                        XLSX.utils.book_append_sheet(wb, lifecycleWs, "Lifecycle History");
                    }
                }
                
                XLSX.writeFile(wb, "kanban_tasks_with_lifecycle.xlsx");
                showNotification('Success', 'Tasks exported to Excel with lifecycle data successfully', 'notification');
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                showNotification('Error', 'Error exporting tasks. Please try again.', 'error');
            }
        });

        // Lifecycle Modal Functions
        const lifecycleModal = document.getElementById('lifecycle-modal');
        const lifecycleForm = document.getElementById('lifecycle-form');
        const closeLifecycleModal = document.getElementById('close-lifecycle-modal');
        const cancelLifecycle = document.getElementById('cancel-lifecycle');

        let pendingTaskMove = null; // Store pending move data

        function showLifecycleModal(taskId, fromStatus, toStatus, taskElement) {
            const taskTitle = taskElement.querySelector('h3').textContent;
            
            // Store pending move data
            pendingTaskMove = {
                taskId: taskId,
                fromStatus: fromStatus,
                toStatus: toStatus,
                taskElement: taskElement
            };

            // Populate modal
            document.getElementById('lifecycle-task-id').value = taskId;
            document.getElementById('lifecycle-new-column').value = toStatus;
            document.getElementById('lifecycle-task-title').textContent = taskTitle;
            document.getElementById('lifecycle-from-status').textContent = getStatusDisplayName(fromStatus);
            document.getElementById('lifecycle-to-status').textContent = getStatusDisplayName(toStatus);
            
            // Reset form
            lifecycleForm.reset();
            document.getElementById('lifecycle-task-id').value = taskId;
            document.getElementById('lifecycle-new-column').value = toStatus;
            
            // Show modal
            lifecycleModal.classList.remove('hidden');
        }

        function hideLifecycleModal() {
            lifecycleModal.classList.add('hidden');
            lifecycleForm.reset();
            
            // If there's a pending move and user cancels, revert the move
            if (pendingTaskMove) {
                const { taskElement, fromStatus } = pendingTaskMove;
                const originalColumn = document.getElementById(`${fromStatus}-column`);
                originalColumn.appendChild(taskElement);
                updateTaskCounters();
                pendingTaskMove = null;
            }
        }

        function getStatusDisplayName(status) {
            const statusNames = {
                'todo': 'To Do',
                'progress': 'In Progress',
                'review': 'Review',
                'done': 'Done'
            };
            return statusNames[status] || status;
        }

        // Close lifecycle modal event listeners
        closeLifecycleModal.addEventListener('click', hideLifecycleModal);
        cancelLifecycle.addEventListener('click', hideLifecycleModal);

        // Handle lifecycle form submission
        lifecycleForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!pendingTaskMove) return;

            const { taskId, fromStatus, toStatus } = pendingTaskMove;
            
            const lifecycleData = {
                updateType: document.getElementById('lifecycle-update-type').value,
                comments: document.getElementById('lifecycle-comments').value,
                updatedBy: document.getElementById('lifecycle-updated-by').value,
                timestamp: new Date().toISOString(),
                fromStatus: fromStatus,
                toStatus: toStatus
            };

            try {
                // Hide modal first
                lifecycleModal.classList.add('hidden');
                
                // Get existing tasks
                const tasks = await fetchTasks();
                
                // Find and update the task
                const taskIndex = tasks.findIndex(task => task.id === taskId);
                if (taskIndex !== -1) {
                    const task = tasks[taskIndex];
                    
                    // Update task column and timestamp
                    task.column = toStatus;
                    task.updatedAt = lifecycleData.timestamp;
                    
                    // Add lifecycle entry
                    if (!task.lifecycle) {
                        task.lifecycle = [];
                    }
                    
                    const lifecycleEntry = {
                        id: `lc_${Date.now()}`,
                        timestamp: lifecycleData.timestamp,
                        fromStatus: lifecycleData.fromStatus,
                        toStatus: lifecycleData.toStatus,
                        updateType: lifecycleData.updateType,
                        comments: lifecycleData.comments,
                        updatedBy: lifecycleData.updatedBy
                    };
                    
                    task.lifecycle.push(lifecycleEntry);
                    
                    // Save updated tasks
                    await saveTasks(tasks, false);
                    
                    // Update UI
                    updateTaskCounters();
                    await updateTableView();
                    
                    // Clear pending move
                    pendingTaskMove = null;
                    
                    showNotification('Success', 'Task status updated successfully', 'notification');
                }
            } catch (error) {
                console.error('Error updating task lifecycle:', error);
                showNotification('Error', 'Error updating task status. Please try again.', 'error');
                
                // Revert the move on error
                if (pendingTaskMove) {
                    const { taskElement, fromStatus } = pendingTaskMove;
                    const originalColumn = document.getElementById(`${fromStatus}-column`);
                    originalColumn.appendChild(taskElement);
                    updateTaskCounters();
                    pendingTaskMove = null;
                }
            }
        });

        // Update task counters initially
        updateTaskCounters();

        // Lifecycle History Functions
        const lifecycleHistoryModal = document.getElementById('lifecycle-history-modal');
        const closeHistoryModal = document.getElementById('close-history-modal');

        closeHistoryModal.addEventListener('click', function() {
            lifecycleHistoryModal.classList.add('hidden');
        });

        // Function to view lifecycle history
        async function viewLifecycleHistory(taskId) {
            try {
                const tasks = await fetchTasks();
                const task = tasks.find(t => t.id === taskId);
                
                if (!task) {
                    showNotification('Error', 'Task not found', 'error');
                    return;
                }

                // Populate modal header
                document.getElementById('history-task-title').textContent = task.title;
                document.getElementById('history-current-status').textContent = getStatusDisplayName(task.column);
                document.getElementById('history-last-updated').textContent = formatDateTime(task.updatedAt);

                // Populate timeline
                const timeline = document.getElementById('lifecycle-timeline');
                timeline.innerHTML = '';

                if (task.lifecycle && task.lifecycle.length > 0) {
                    // Sort lifecycle entries by timestamp (newest first)
                    const sortedLifecycle = [...task.lifecycle].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    // Create timeline container
                    const timelineContainer = document.createElement('ol');
                    timelineContainer.className = 'relative border-s border-gray-200';
                    
                    sortedLifecycle.forEach((entry, index) => {
                        const timelineEntry = createTimelineEntry(entry, index === sortedLifecycle.length - 1);
                        timelineContainer.appendChild(timelineEntry);
                    });
                    
                    timeline.appendChild(timelineContainer);
                } else {
                    timeline.innerHTML = '<p class="text-gray-500 text-center py-4">No lifecycle history available</p>';
                }

                // Show modal
                lifecycleHistoryModal.classList.remove('hidden');
                
                // Hide task menu
                document.getElementById(`menu-${taskId}`).classList.add('hidden');
            } catch (error) {
                console.error('Error loading lifecycle history:', error);
                showNotification('Error', 'Error loading lifecycle history', 'error');
            }
        }

                 function createTimelineEntry(entry, isLast) {
             const li = document.createElement('li');
             li.className = isLast ? 'ms-4' : 'mb-10 ms-4';
             
             const updateTypeColors = {
                 creation: 'bg-blue-500',
                 progress: 'bg-yellow-500',
                 blocker: 'bg-red-500',
                 completion: 'bg-green-500',
                 review: 'bg-purple-500',
                 testing: 'bg-indigo-500',
                 deployment: 'bg-gray-500',
                 other: 'bg-gray-400'
             };

             const color = updateTypeColors[entry.updateType] || updateTypeColors.other;

             // Format the action description
             const actionDescription = entry.fromStatus ? 
                 `moved task from ${getStatusDisplayName(entry.fromStatus)} to ${getStatusDisplayName(entry.toStatus)}` :
                 `created the task`;

             li.innerHTML = `
                 <div class="absolute w-3 h-3 ${color} rounded-full mt-1.5 -start-1.5 border border-white"></div>
                 <time class="mb-1 !text-md font-normal leading-none text-gray-400">${formatDateTime(entry.timestamp)}</time>
                 <h3 class="!text-md font-semibold text-gray-900">
                     ${entry.updatedBy} ${actionDescription}
                 </h3>
                 <div class="mb-2">
                     <span class="inline-flex items-center px-2.5 py-0.5 rounded-full !text-md font-medium bg-gray-100 text-gray-800">
                         ${entry.updateType.charAt(0).toUpperCase() + entry.updateType.slice(1)}
                     </span>
                 </div>
                 <p class="!text-md font-normal text-gray-500">${entry.comments}</p>
             `;

             return li;
         }

         function formatDateTime(dateString) {
             if (!dateString) return 'Unknown';
             const date = new Date(dateString);
             return date.toLocaleDateString('en-US', { 
                 year: 'numeric', 
                 month: 'short', 
                 day: 'numeric',
                 hour: '2-digit',
                 minute: '2-digit',
                 hour12: true // Added for AM/PM format
             });
         }

         // Make viewLifecycleHistory globally available
         window.viewLifecycleHistory = viewLifecycleHistory;

        // Metrics Table Population Function
        function updateMetricsTable(tasks) {
            try {
                const tableBody = document.getElementById('metrics-table-body');
                if (!tableBody) {
                    console.debug('Metrics table body not found');
                    return;
                }
                
                // Clear existing rows
                tableBody.innerHTML = '';
                
                if (!tasks || tasks.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="8" class="px-6 py-4 text-center text-gray-500">No tasks available or failed to load.</td>
                    `;
                    tableBody.appendChild(row);
                    return;
                }
                
                // Filter tasks that are pending more than 1 month (30 days) and not completed
                const today = new Date();
                const oneMonthAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
                
                const overdueTasks = tasks
                    .filter(task => {
                        // Exclude completed tasks
                        if (task.column === 'done') return false;
                        
                        // Calculate task age from created date
                        const createdDate = new Date(task.createdAt || task.startDate);
                        return createdDate < oneMonthAgo;
                    })
                    .map(task => {
                        const createdDate = new Date(task.createdAt || task.startDate);
                        const daysPending = Math.floor((today - createdDate) / (1000 * 60 * 60 * 24));
                        
                        return {
                            ...task,
                            daysPending: daysPending
                        };
                    })
                    .sort((a, b) => b.daysPending - a.daysPending) // Sort by most overdue first
                    .slice(0, 10); // Take top 10
                
                if (overdueTasks.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td colspan="8" class="px-6 py-4 text-center text-green-600">
                            🎉 Great! No tasks are pending for more than 1 month
                        </td>
                    `;
                    tableBody.appendChild(row);
                    return;
                }
                
                // Populate table with overdue tasks
                overdueTasks.forEach((task, index) => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    
                    // Get priority color
                    const getPriorityColor = (priority) => {
                        switch(priority) {
                            case 'urgent': return 'bg-red-100 text-red-800';
                            case 'high': return 'bg-orange-100 text-orange-800';
                            case 'medium': return 'bg-yellow-100 text-yellow-800';
                            case 'low': return 'bg-blue-100 text-blue-800';
                            default: return 'bg-gray-100 text-gray-800';
                        }
                    };
                    
                    // Get status color
                    const getStatusColor = (status) => {
                        switch(status) {
                            case 'todo': return 'bg-yellow-100 text-yellow-800';
                            case 'progress': return 'bg-blue-100 text-blue-800';
                            case 'review': return 'bg-purple-100 text-purple-800';
                            default: return 'bg-gray-100 text-gray-800';
                        }
                    };
                    
                    // Get days pending color (more overdue = more red)
                    const getDaysPendingColor = (days) => {
                        if (days >= 90) return 'bg-red-100 text-red-800 font-bold'; // 3+ months
                        if (days >= 60) return 'bg-red-100 text-red-700'; // 2+ months
                        if (days >= 45) return 'bg-orange-100 text-orange-800'; // 1.5+ months
                        return 'bg-yellow-100 text-yellow-800'; // 1+ month
                    };
                    
                    // Format dates
                    const formatDate = (dateString) => {
                        if (!dateString) return 'Not set';
                        return new Date(dateString).toLocaleDateString('en-US', { 
                            month: 'short', 
                            day: 'numeric',
                            year: 'numeric'
                        });
                    };
                    
                    // Truncate long task names
                    const truncateTitle = (title) => {
                        return title.length > 50 ? title.substring(0, 50) + '...' : title;
                    };
                    
                    row.innerHTML = `
                        <td class="px-6 py-4">
                            <div class="text-sm font-medium text-gray-900" title="${task.title}">
                                ${truncateTitle(task.title)}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center text-white text-xs font-medium mr-2">
                                    ${(task.assignedUser || 'UN').split(' ').map(n => n.charAt(0)).join('').substring(0, 2)}
                                </div>
                                <span class="text-sm text-gray-900">${task.assignedUser || 'Unassigned'}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getPriorityColor(task.priority)}">
                                ${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(task.column)}">
                                ${getStatusDisplayName(task.column)}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">
                                ${getTagName(task.tag)}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getDaysPendingColor(task.daysPending)}">
                                ${task.daysPending} days
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                            ${formatDate(task.createdAt)}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                            ${formatDate(task.dueDate)}
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
            } catch (error) {
                console.error('Error updating metrics table:', error);
                showNotification('Error', 'Error updating metrics table', 'error');
            }
        }

        // Update metrics when tasks change
        const originalUpdateTaskCounters = updateTaskCounters;
        updateTaskCounters = function() {
            originalUpdateTaskCounters();
            // Only update metrics if metrics view is active
            try {
                const alpineElement = document.querySelector('[x-data]');
                if (alpineElement && alpineElement.__x && alpineElement.__x.$data && alpineElement.__x.$data.activeView === 'metrics') {
                    updateMetrics(); // This calls with showNotifications=true by default
                }
            } catch (error) {
                // Silently ignore Alpine.js access errors during initialization
                console.debug('Alpine.js not ready for metrics update');
            }
        };

        // Show task context menu on right-click
        function showTaskMenu(event, taskId) {
            event.preventDefault();
            const menu = document.getElementById(`menu-${taskId}`);
            if (menu) {
                // Hide all other menus first
                document.querySelectorAll('.task-menu-dropdown').forEach(m => m.classList.add('hidden'));
                
                menu.style.position = 'fixed';
                menu.style.left = event.clientX + 'px';
                menu.style.top = event.clientY + 'px';
                menu.style.zIndex = '1000';
                menu.classList.remove('hidden');
                
                // Hide menu when clicking elsewhere
                setTimeout(() => {
                    document.addEventListener('click', function hideMenu() {
                        menu.classList.add('hidden');
                        document.removeEventListener('click', hideMenu);
                    });
                }, 100);
            }
        }
        
        // Show task details (could open a modal or expand card)
        function showTaskDetails(taskId) {
            console.log('Showing details for task:', taskId);
            // For now, just open the edit modal
            editTask(taskId);
        }

        // Calendar functionality
        let currentCalendarDate = new Date();
        let currentCalendarView = 'month'; // month, week, day

        function updateCalendar() {
            console.log('Updating calendar view:', currentCalendarView);
            updateCalendarHeader();
            generateCalendarGrid();
        }

        function updateCalendarView(view) {
            currentCalendarView = view;
            console.log('Calendar view changed to:', view);
            
            if (view === 'day') {
                // Reset to today when switching to day view
                currentCalendarDate = new Date();
            }
            
            // Force calendar grid to be properly set up for the view
            const calendarGrid = document.getElementById('calendar-grid');
            if (calendarGrid) {
                calendarGrid.innerHTML = ''; // Clear existing content
                
                // Ensure proper grid classes based on view
                switch(view) {
                    case 'month':
                        calendarGrid.className = 'grid grid-cols-7';
                        break;
                    case 'week':
                        calendarGrid.className = 'grid grid-cols-7';
                        break;
                    case 'day':
                        calendarGrid.className = 'grid grid-cols-1';
                        break;
                    default:
                        calendarGrid.className = 'grid grid-cols-7';
                }
            }
            
            updateCalendar();
        }

        function updateCalendarHeader() {
            const monthYear = document.getElementById('calendar-month-year');
            let options, displayText;
            
            switch(currentCalendarView) {
                case 'month':
                    options = { year: 'numeric', month: 'long' };
                    displayText = currentCalendarDate.toLocaleDateString('en-US', options);
                    break;
                case 'week':
                    const weekStart = getWeekStart(currentCalendarDate);
                    const weekEnd = getWeekEnd(currentCalendarDate);
                    const startMonth = weekStart.toLocaleDateString('en-US', { month: 'short' });
                    const endMonth = weekEnd.toLocaleDateString('en-US', { month: 'short' });
                    displayText = `${startMonth} ${weekStart.getDate()} - ${endMonth} ${weekEnd.getDate()}, ${currentCalendarDate.getFullYear()}`;
                    break;
                case 'day':
                    options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
                    displayText = currentCalendarDate.toLocaleDateString('en-US', options);
                    break;
                default:
                    options = { year: 'numeric', month: 'long' };
                    displayText = currentCalendarDate.toLocaleDateString('en-US', options);
            }
            
            monthYear.textContent = displayText;
        }

        function getWeekStart(date) {
            const start = new Date(date);
            const day = start.getDay();
            const diff = start.getDate() - day;
            return new Date(start.setDate(diff));
        }

        function getWeekEnd(date) {
            const start = getWeekStart(date);
            const end = new Date(start);
            end.setDate(start.getDate() + 6);
            return end;
        }

        async function generateCalendarGrid() {
            const calendarGrid = document.getElementById('calendar-grid');
            calendarGrid.innerHTML = '';

            // Get tasks for calendar display
            const tasks = await fetchTasks();

            switch(currentCalendarView) {
                case 'month':
                    generateMonthView(calendarGrid, tasks);
                    break;
                case 'week':
                    generateWeekView(calendarGrid, tasks);
                    break;
                case 'day':
                    generateDayView(calendarGrid, tasks);
                    break;
                default:
                    generateMonthView(calendarGrid, tasks);
            }
        }

        function generateMonthView(calendarGrid, tasks) {
            // Set grid to 7 columns and 6 rows for month view
            calendarGrid.className = 'grid grid-cols-7 grid-rows-6';
            
            // Get first day of month and number of days in month
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            const startDay = firstDayOfMonth.getDay(); // 0 = Sunday, 1 = Monday, etc.

            // Find the first visible day (Sunday before or on the 1st)
            const firstGridDate = new Date(year, month, 1 - startDay);

            // Render exactly 42 days (6 weeks) - standard calendar layout
            for (let i = 0; i < 42; i++) {
                const gridDate = new Date(firstGridDate);
                gridDate.setDate(firstGridDate.getDate() + i);
                const isCurrentMonth = gridDate.getMonth() === month;
                const dayElement = createCalendarDay(gridDate, month, tasks, false);
                if (!isCurrentMonth) {
                    dayElement.className = 'min-h-[120px] p-2 border-r border-b border-gray-200 bg-gray-50';
                    const dayNumber = dayElement.querySelector('div');
                    if (dayNumber) dayNumber.className = 'text-sm font-medium mb-2 text-gray-400';
                }
                calendarGrid.appendChild(dayElement);
            }
        }

        function generateWeekView(calendarGrid, tasks) {
            // Set grid to 7 columns for week view
            calendarGrid.className = 'grid grid-cols-7';
            
            const weekStart = getWeekStart(currentCalendarDate);
            
            // Generate 7 days for the week
            for (let i = 0; i < 7; i++) {
                const currentDate = new Date(weekStart);
                currentDate.setDate(weekStart.getDate() + i);
                const dayElement = createCalendarDay(currentDate, currentDate.getMonth(), tasks, true);
                calendarGrid.appendChild(dayElement);
            }
        }

        function generateDayView(calendarGrid, tasks) {
            // Set grid to 1 column for day view
            calendarGrid.className = 'grid grid-cols-1';
            
            const dayElement = createDayViewElement(currentCalendarDate, tasks);
            calendarGrid.appendChild(dayElement);
        }

        function createDayViewElement(date, tasks) {
            const dayDiv = document.createElement('div');
            const isToday = date.toDateString() === new Date().toDateString();
            
            dayDiv.className = `min-h-[500px] p-6 border border-gray-200 bg-white rounded-lg ${
                isToday ? 'bg-blue-50 border-blue-200' : ''
            }`;

            // Day header
            const dayHeader = document.createElement('div');
            dayHeader.className = 'mb-6 pb-4 border-b border-gray-200';
            
            const dayTitle = document.createElement('h3');
            dayTitle.className = `text-2xl font-semibold text-gray-900 ${
                isToday ? 'text-blue-600' : ''
            }`;
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            dayTitle.textContent = date.toLocaleDateString('en-US', options);
            dayHeader.appendChild(dayTitle);
            dayDiv.appendChild(dayHeader);

            // Find tasks for this date
            const dateString = date.toISOString().split('T')[0];
            const dayTasks = tasks.filter(task => {
                return task.dueDate === dateString || task.startDate === dateString;
            });

            // Tasks container
            const tasksContainer = document.createElement('div');
            tasksContainer.className = 'space-y-3';

            if (dayTasks.length === 0) {
                const noTasksDiv = document.createElement('div');
                noTasksDiv.className = 'text-center py-12 text-gray-500';
                noTasksDiv.innerHTML = `
                    <svg class="mx-auto h-12 w-12 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2-2v14a2 2 0 002 2z"></path>
                    </svg>
                    <p class="text-lg">No tasks for this day</p>
                `;
                tasksContainer.appendChild(noTasksDiv);
            } else {
                // Add all tasks for this day
                dayTasks.forEach(task => {
                    const taskElement = createDayTaskElement(task);
                    tasksContainer.appendChild(taskElement);
                });
            }

            dayDiv.appendChild(tasksContainer);
            return dayDiv;
        }

        function createDayTaskElement(task) {
            const taskDiv = document.createElement('div');
            taskDiv.className = `p-4 rounded-lg border cursor-pointer hover:shadow-md transition-all ${getTaskEventColor(task.tag)} border-gray-200`;
            
            taskDiv.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <h4 class="font-medium text-sm mb-2">${task.title}</h4>
                        <p class="text-xs text-gray-600 mb-2">${task.description || 'No description'}</p>
                        <div class="flex items-center space-x-4 text-xs text-gray-500">
                            <span>Priority: ${task.priority || 'None'}</span>
                            <span>Assigned: ${task.assignedUser || 'Unassigned'}</span>
                            <span>Type: ${getTagName(task.tag)}</span>
                        </div>
                    </div>
                    <div class="ml-4">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusColor(task.status)}">
                            ${task.status}
                        </span>
                    </div>
                </div>
            `;
            
            // Add click handler to show task details
            taskDiv.addEventListener('click', (e) => {
                e.stopPropagation();
                showTaskDetails(task.id);
            });

            return taskDiv;
        }

        function createCalendarDay(date, currentMonth, tasks, isWeekView = false) {
            const dayDiv = document.createElement('div');
            const isCurrentMonth = isWeekView || date.getMonth() === currentMonth;
            const isToday = date.toDateString() === new Date().toDateString();
            
            dayDiv.className = `min-h-[120px] p-2 border-r border-b border-gray-200 bg-white ${
                isToday ? 'bg-blue-50' : ''
            } ${!isCurrentMonth ? 'bg-gray-50 text-gray-400' : ''}`;

            // Day number
            const dayNumber = document.createElement('div');
            dayNumber.className = `text-sm font-medium mb-2 ${
                isCurrentMonth ? 'text-gray-900' : 'text-gray-400'
            } ${isToday ? 'text-blue-600 font-bold' : ''}`;
            dayNumber.textContent = date.getDate();
            dayDiv.appendChild(dayNumber);

            // Find tasks for this date
            const dateString = date.toISOString().split('T')[0];
            const dayTasks = tasks.filter(task => {
                return task.dueDate === dateString || task.startDate === dateString;
            });

            // Add task events
            dayTasks.slice(0, 3).forEach(task => { // Limit to 3 tasks per day for better display
                const taskEvent = createCalendarTaskEvent(task);
                dayDiv.appendChild(taskEvent);
            });

            // Show "more" indicator if there are more than 3 tasks
            if (dayTasks.length > 3) {
                const moreDiv = document.createElement('div');
                moreDiv.className = 'text-xs text-gray-500 cursor-pointer hover:text-gray-700';
                moreDiv.textContent = `+${dayTasks.length - 3} more`;
                dayDiv.appendChild(moreDiv);
            }

            return dayDiv;
        }

        function createCalendarTaskEvent(task) {
            const eventDiv = document.createElement('div');
            eventDiv.className = `text-xs p-1 mb-1 rounded cursor-pointer truncate ${getTaskEventColor(task.tag)}`;
            eventDiv.title = `${task.title} - ${task.assignedUser || 'Unassigned'}`;
            eventDiv.textContent = task.title;
            
            // Add click handler to show task details
            eventDiv.addEventListener('click', (e) => {
                e.stopPropagation();
                showTaskDetails(task.id);
            });

            return eventDiv;
        }

        function getTaskEventColor(tag) {
            const tagColors = {
                blue: 'bg-blue-100 text-blue-800 hover:bg-blue-200',
                red: 'bg-red-100 text-red-800 hover:bg-red-200',
                purple: 'bg-purple-100 text-purple-800 hover:bg-purple-200',
                green: 'bg-green-100 text-green-800 hover:bg-green-200',
                yellow: 'bg-yellow-100 text-yellow-800 hover:bg-yellow-200'
            };
            return tagColors[tag] || 'bg-gray-100 text-gray-800 hover:bg-gray-200';
        }

        // Calendar navigation
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('calendar-prev-btn').addEventListener('click', function() {
                switch(currentCalendarView) {
                    case 'month':
                        currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                        break;
                    case 'week':
                        currentCalendarDate.setDate(currentCalendarDate.getDate() - 7);
                        break;
                    case 'day':
                        currentCalendarDate.setDate(currentCalendarDate.getDate() - 1);
                        break;
                }
                updateCalendar();
            });

            document.getElementById('calendar-next-btn').addEventListener('click', function() {
                switch(currentCalendarView) {
                    case 'month':
                        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                        break;
                    case 'week':
                        currentCalendarDate.setDate(currentCalendarDate.getDate() + 7);
                        break;
                    case 'day':
                        currentCalendarDate.setDate(currentCalendarDate.getDate() + 1);
                        break;
                }
                updateCalendar();
            });
        });

        // Make updateCalendarView available globally
        window.updateCalendarView = updateCalendarView;
    </script>
</body>
</html>
