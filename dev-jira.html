<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kanban Board</title>
    <!-- Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Alpine.js -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            "50": "#eff6ff",
                            "100": "#dbeafe",
                            "200": "#bfdbfe",
                            "300": "#93c5fd",
                            "400": "#60a5fa",
                            "500": "#3b82f6",
                            "600": "#2563eb",
                            "700": "#1d4ed8",
                            "800": "#1e40af",
                            "900": "#1e3a8a",
                            "950": "#172554"
                        }
                    }
                }
            }
        }
    </script>
    <!-- Drag and Drop Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <style>
        .task-card.dragging {
            opacity: 0.5;
        }

        .column-drop-zone {
            min-height: 10px;
        }

        .task-list {
            min-height: 200px;
            display: flex;
            flex-direction: column;
        }

        .task-list:empty {
            min-height: 200px;
        }

        .view-kanban {
            display: none;
        }

        .view-table {
            display: none;
        }

        .active-view {
            display: block;
        }

        /* Add transition for view switching */
        [x-show] {
            transition: opacity 0.3s ease-in-out;
        }

        [x-show].opacity-0 {
            opacity: 0;
        }

        [x-show].opacity-100 {
            opacity: 1;
        }

        /* Notification styles */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        .notification.success {
            background-color: #10B981;
        }

        .notification.error {
            background-color: #EF4444;
        }

        .notification.info {
            background-color: #3B82F6;
        }

        /* Add border to three dots menu dropdown */
        .task-menu-dropdown {
            border: 1px solid #e5e7eb; /* Tailwind's border-gray-200 */
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
        }
    </style>
</head>

<body class="bg-gray-100">
    <!-- Message Component -->
    <div class="fixed bottom-4 right-4 z-50" id="notificationsContainer">
        <div class="flex flex-col gap-4">
            <!-- Notifications will be dynamically added here -->
        </div>
    </div>

    <div class="p-4">
        <div class="rounded-2xl border border-gray-200 bg-white">
            <div class="px-5 py-4 sm:px-6 sm:py-5">
                <h3 class="text-base font-medium text-gray-800">
                    Task Management
                </h3>
            </div>
            <div class="border-t border-gray-100 p-5 sm:p-6">
                <!-- Search and Filter Section -->
                <div class="mb-6 flex flex-col gap-4">
                    <div class="flex flex-1 items-center gap-4">
                        <div class="w-[512px]">
                            <div class="relative">
                                <span class="pointer-events-none absolute top-1/2 left-4 -translate-y-1/2">
                                    <svg class="fill-gray-500" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path fill-rule="evenodd" clip-rule="evenodd" d="M3.04199 9.37381C3.04199 5.87712 5.87735 3.04218 9.37533 3.04218C12.8733 3.04218 15.7087 5.87712 15.7087 9.37381C15.7087 12.8705 12.8733 15.7055 9.37533 15.7055C5.87735 15.7055 3.04199 12.8705 3.04199 9.37381ZM9.37533 1.54218C5.04926 1.54218 1.54199 5.04835 1.54199 9.37381C1.54199 13.6993 5.04926 17.2055 9.37533 17.2055C11.2676 17.2055 13.0032 16.5346 14.3572 15.4178L17.1773 18.2381C17.4702 18.531 17.945 18.5311 18.2379 18.2382C18.5308 17.9453 18.5309 17.4704 18.238 17.1775L15.4182 14.3575C16.5367 13.0035 17.2087 11.2671 17.2087 9.37381C17.2087 5.04835 13.7014 1.54218 9.37533 1.54218Z" fill=""></path>
                                    </svg>
                                </span>
                                <input type="text" id="searchInput" placeholder="Search tasks..." class="shadow-theme-xs focus:border-brand-300 focus:ring-brand-500/10 h-[42px] w-full rounded-lg border border-gray-300 bg-transparent py-2.5 pr-4 pl-[42px] text-sm text-gray-800 placeholder:text-gray-400 focus:ring-3 focus:outline-hidden">
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <!-- Action Buttons -->
                            <button type="button" id="export-excel" class="flex items-center gap-2 rounded-lg bg-blue-500 px-4 py-2 text-sm font-medium text-white hover:bg-blue-600">
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                                </svg>
                                Export
                            </button>
                            <button type="button" id="refresh-data" class="flex items-center gap-2 rounded-lg bg-blue-500 px-4 py-2 text-sm font-medium text-white hover:bg-blue-600">
                                <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                </svg>
                                Refresh
                            </button>
                        </div>
                    </div>

                    <!-- View Switching Slider -->
                    <div class="rounded-xl border border-gray-200 p-6" x-data="{ activeView: 'kanban' }" x-init="$watch('activeView', value => { if (value === 'metrics') { setTimeout(() => updateMetrics(true), 200); } })">
                        <div class="border-b border-gray-200">
                            <nav class="-mb-px flex space-x-2 overflow-x-auto [&::-webkit-scrollbar-thumb]:rounded-full [&::-webkit-scrollbar-thumb]:bg-gray-200 [&::-webkit-scrollbar]:h-1.5">
                                <button class="inline-flex items-center gap-2 border-b-2 px-2.5 py-2 text-sm font-medium transition-colors duration-200 ease-in-out" 
                                    :class="activeView === 'kanban' ? 'text-blue-500 border-blue-500' : 'text-gray-500 border-transparent hover:text-gray-700'"
                                    @click="activeView = 'kanban'">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
                                    </svg>
                                    Kanban
                                </button>
                                <button class="inline-flex items-center gap-2 border-b-2 px-2.5 py-2 text-sm font-medium transition-colors duration-200 ease-in-out"
                                    :class="activeView === 'table' ? 'text-blue-500 border-blue-500' : 'text-gray-500 border-transparent hover:text-gray-700'"
                                    @click="activeView = 'table'">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M3 14h18m-9-4v8m-7 0h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                    Table
                                </button>
                                <button class="inline-flex items-center gap-2 border-b-2 px-2.5 py-2 text-sm font-medium transition-colors duration-200 ease-in-out"
                                    :class="activeView === 'metrics' ? 'text-blue-500 border-blue-500' : 'text-gray-500 border-transparent hover:text-gray-700'"
                                    @click="activeView = 'metrics'">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                                    </svg>
                                    Metrics
                                </button>
                            </nav>
                </div>

                        <div class="pt-4">
        <!-- Kanban View -->
                            <div x-show="activeView === 'kanban'" 
                                 x-transition:enter="transition ease-out duration-300"
                                 x-transition:enter-start="opacity-0 transform scale-95"
                                 x-transition:enter-end="opacity-100 transform scale-100"
                                 x-transition:leave="transition ease-in duration-200"
                                 x-transition:leave-start="opacity-100 transform scale-100"
                                 x-transition:leave-end="opacity-0 transform scale-95">
            <div class="flex flex-col md:flex-row gap-4">
                <!-- Todo Column -->
                <div class="bg-gray-50 rounded-lg flex-1 min-h-[600px]">
                    <div class="p-4 flex justify-between items-center">
                        <h2 class="font-semibold text-gray-700 text-base flex items-center">
                            <span class="w-3 h-3 bg-yellow-500 rounded-full mr-2"></span>
                            To do
                            <span class="ml-2 bg-blue-600 text-white text-xs font-medium px-2 py-1 rounded-full task-counter">0</span>
                        </h2>
                        <button id="add-todo" class="flex items-center justify-center text-gray-500 hover:text-gray-700 hover:bg-gray-200 rounded-lg p-2 transition-colors duration-200">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="px-4 pb-4 task-list" id="todo-column">
                        <!-- Task cards here -->
                    </div>
                </div>

                <!-- In Progress Column -->
                <div class="bg-gray-50 rounded-lg flex-1 min-h-[600px]">
                    <div class="p-4 flex justify-between items-center">
                        <h2 class="font-semibold text-gray-700 text-base flex items-center">
                            <span class="w-3 h-3 bg-blue-500 rounded-full mr-2"></span>
                            In Progress
                            <span class="ml-2 bg-blue-600 text-white text-xs font-medium px-2 py-1 rounded-full task-counter">0</span>
                        </h2>
                        <button id="add-progress" class="flex items-center justify-center text-gray-500 hover:text-gray-700 hover:bg-gray-200 rounded-lg p-2 transition-colors duration-200">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="px-4 pb-4 task-list" id="progress-column">
                        <!-- Task cards here -->
                    </div>
                </div>

                <!-- Review Column -->
                <div class="bg-gray-50 rounded-lg flex-1 min-h-[600px]">
                    <div class="p-4 flex justify-between items-center">
                        <h2 class="font-semibold text-gray-700 text-base flex items-center">
                            <span class="w-3 h-3 bg-purple-500 rounded-full mr-2"></span>
                            Review
                            <span class="ml-2 bg-blue-600 text-white text-xs font-medium px-2 py-1 rounded-full task-counter">0</span>
                        </h2>
                        <button id="add-review" class="flex items-center justify-center text-gray-500 hover:text-gray-700 hover:bg-gray-200 rounded-lg p-2 transition-colors duration-200">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="px-4 pb-4 task-list" id="review-column">
                        <!-- Task cards here -->
                    </div>
                </div>

                <!-- Done Column -->
                <div class="bg-gray-50 rounded-lg flex-1 min-h-[600px]">
                    <div class="p-4 flex justify-between items-center">
                        <h2 class="font-semibold text-gray-700 text-base flex items-center">
                            <span class="w-3 h-3 bg-pink-500 rounded-full mr-2"></span>
                            Done
                            <span class="ml-2 bg-blue-600 text-white text-xs font-medium px-2 py-1 rounded-full task-counter">0</span>
                        </h2>
                        <button id="add-done" class="flex items-center justify-center text-gray-500 hover:text-gray-700 hover:bg-gray-200 rounded-lg p-2 transition-colors duration-200">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>
                        </button>
                    </div>
                    <div class="px-4 pb-4 task-list" id="done-column">
                        <!-- Task cards here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Table View -->
                            <div x-show="activeView === 'table'"
                                 x-transition:enter="transition ease-out duration-300"
                                 x-transition:enter-start="opacity-0 transform scale-95"
                                 x-transition:enter-end="opacity-100 transform scale-100"
                                 x-transition:leave="transition ease-in duration-200"
                                 x-transition:leave-start="opacity-100 transform scale-100"
                                 x-transition:leave-end="opacity-0 transform scale-95">
                <div class="overflow-x-auto">
                                    <table class="min-w-full divide-y divide-gray-200">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">Title</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">Description</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">Tag</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">Priority</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">Assigned To</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">Submitted By</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">Start Date</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">Due Date</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">Days Pending</th>
                                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider whitespace-nowrap">Actions</th>
                            </tr>
                        </thead>
                                        <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                                            <!-- Table rows will be dynamically added here -->
                        </tbody>
                    </table>
                                </div>
                            </div>

                            <!-- Metrics View -->
                            <div x-show="activeView === 'metrics'"
                                 x-transition:enter="transition ease-out duration-300"
                                 x-transition:enter-start="opacity-0 transform scale-95"
                                 x-transition:enter-end="opacity-100 transform scale-100"
                                 x-transition:leave="transition ease-in duration-200"
                                 x-transition:leave-start="opacity-100 transform scale-100"
                                 x-transition:leave-end="opacity-0 transform scale-95">
                                
                                <!-- Metrics Dashboard -->
                                <div class="space-y-6">
                                    <!-- Summary Cards -->
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0">
                                                    <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
                                                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                                        </svg>
                                                    </div>
                                                </div>
                                                <div class="ml-5 w-0 flex-1">
                                                    <dl>
                                                        <dt class="text-sm font-medium text-gray-500 truncate">Total Tasks</dt>
                                                        <dd class="text-lg font-medium text-gray-900" id="total-tasks-metric">0</dd>
                                                    </dl>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0">
                                                    <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center">
                                                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                        </svg>
                                                    </div>
                                                </div>
                                                <div class="ml-5 w-0 flex-1">
                                                    <dl>
                                                        <dt class="text-sm font-medium text-gray-500 truncate">Completed</dt>
                                                        <dd class="text-lg font-medium text-gray-900" id="completed-tasks-metric">0</dd>
                                                    </dl>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0">
                                                    <div class="w-8 h-8 bg-yellow-500 rounded-lg flex items-center justify-center">
                                                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                        </svg>
                                                    </div>
                                                </div>
                                                <div class="ml-5 w-0 flex-1">
                                                    <dl>
                                                        <dt class="text-sm font-medium text-gray-500 truncate">In Progress</dt>
                                                        <dd class="text-lg font-medium text-gray-900" id="progress-tasks-metric">0</dd>
                                                    </dl>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0">
                                                    <div class="w-8 h-8 bg-red-500 rounded-lg flex items-center justify-center">
                                                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                                                        </svg>
                                                    </div>
                                                </div>
                                                <div class="ml-5 w-0 flex-1">
                                                    <dl>
                                                        <dt class="text-sm font-medium text-gray-500 truncate">Overdue</dt>
                                                        <dd class="text-lg font-medium text-gray-900" id="overdue-tasks-metric">0</dd>
                                                    </dl>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Charts Row 1 -->
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <!-- Task Status Distribution -->
                                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                                            <h3 class="text-lg font-medium text-gray-900 mb-4">Task Status Distribution</h3>
                                            <div id="statusChart"></div>
                                        </div>

                                        <!-- Priority Distribution -->
                                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                                            <h3 class="text-lg font-medium text-gray-900 mb-4">Priority Distribution</h3>
                                            <div id="priorityChart"></div>
                                        </div>
                                    </div>

                                    <!-- Charts Row 2 -->
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <!-- Tag Distribution -->
                                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                                            <h3 class="text-lg font-medium text-gray-900 mb-4">Task Type Distribution</h3>
                                            <div id="tagChart"></div>
                                        </div>

                                        <!-- Assignee Workload -->
                                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                                            <h3 class="text-lg font-medium text-gray-900 mb-4">Assignee Workload</h3>
                                            <div id="assigneeChart"></div>
                                        </div>
                                    </div>

                                    <!-- Charts Row 3 -->
                                    <div class="grid grid-cols-1 gap-6">
                                        <!-- Task Timeline -->
                                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                                            <h3 class="text-lg font-medium text-gray-900 mb-4">Tasks by Due Date Timeline</h3>
                                            <div id="timelineChart"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Form Modal -->
    <div id="task-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Add New Task</h3>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors p-2 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            <form id="task-form">
                <input type="hidden" id="form-column" value="">
                <input type="hidden" id="task-id" value="">
                <div class="mb-4">
                    <label for="task-title" class="block text-sm font-medium text-gray-700 mb-1">Title</label>
                    <input type="text" id="task-title" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" placeholder="Task title" required>
                </div>
                <div class="mb-4">
                    <label for="task-description" class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea id="task-description" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" rows="3" placeholder="Task description"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="task-tag" class="block text-sm font-medium text-gray-700 mb-1">Tag</label>
                        <select id="task-tag" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5">
                            <option value="blue">New Development</option>
                            <option value="red">Bug</option>
                            <option value="purple">Design</option>
                            <option value="green">Enhancement</option>
                            <option value="yellow">Ad Hoc</option>
                        </select>
                    </div>
                    <div>
                        <label for="task-priority" class="block text-sm font-medium text-gray-700 mb-1">Priority</label>
                        <select id="task-priority" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5">
                            <option value="none">None</option>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                    <label for="task-assigned-user" class="block text-sm font-medium text-gray-700 mb-1">Assigned User</label>
                    <select id="task-assigned-user" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5">
                        <option value="">Select User</option>
                        <option value="User 1">User 1</option>
                        <option value="User 2">User 2</option>
                        <option value="User 3">User 3</option>
                        <option value="User 4">User 4</option>
                        <option value="User 5">User 5</option>
                    </select>
                    </div>
                    <div>
                        <label for="task-submitted-by" class="block text-sm font-medium text-gray-700 mb-1">Submitted By</label>
                        <select id="task-submitted-by" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5">
                            <option value="">Select User</option>
                            <option value="User 1">User 1</option>
                            <option value="User 2">User 2</option>
                            <option value="User 3">User 3</option>
                            <option value="User 4">User 4</option>
                            <option value="User 5">User 5</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="task-start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                        <input type="date" id="task-start-date" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5">
                    </div>
                    <div>
                        <label for="task-due" class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                        <input type="date" id="task-due" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5">
                    </div>
                </div>
                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-task" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-200">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">Add Task</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Lifecycle Update Modal -->
    <div id="lifecycle-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Task Status Update</h3>
                <button id="close-lifecycle-modal" class="text-gray-400 hover:text-gray-600 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors p-2 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                <div class="flex items-center mb-2">
                    <svg class="w-5 h-5 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <h4 class="text-sm font-medium text-blue-800">Status Change Detected</h4>
                </div>
                <p class="text-sm text-blue-700">
                    Task "<span id="lifecycle-task-title" class="font-medium"></span>" has been moved from 
                    <span id="lifecycle-from-status" class="font-medium"></span> to 
                    <span id="lifecycle-to-status" class="font-medium"></span>
                </p>
            </div>

            <form id="lifecycle-form">
                <input type="hidden" id="lifecycle-task-id" value="">
                <input type="hidden" id="lifecycle-new-column" value="">
                
                <div class="mb-4">
                    <label for="lifecycle-update-type" class="block text-sm font-medium text-gray-700 mb-1">Update Type</label>
                    <select id="lifecycle-update-type" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" required>
                        <option value="">Select update type</option>
                        <option value="progress">Progress Update</option>
                        <option value="blocker">Blocker/Issue</option>
                        <option value="completion">Task Completion</option>
                        <option value="review">Ready for Review</option>
                        <option value="testing">Testing Phase</option>
                        <option value="deployment">Deployment</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="mb-4">
                    <label for="lifecycle-comments" class="block text-sm font-medium text-gray-700 mb-1">Comments/Notes</label>
                    <textarea id="lifecycle-comments" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" rows="3" placeholder="Describe what has changed, any blockers, or next steps..." required></textarea>
                </div>

                <div class="mb-4">
                    <label for="lifecycle-updated-by" class="block text-sm font-medium text-gray-700 mb-1">Updated By</label>
                    <select id="lifecycle-updated-by" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5" required>
                        <option value="">Select user</option>
                        <option value="User 1">User 1</option>
                        <option value="User 2">User 2</option>
                        <option value="User 3">User 3</option>
                        <option value="User 4">User 4</option>
                        <option value="User 5">User 5</option>
                    </select>
                </div>

                <div class="flex justify-end space-x-2">
                    <button type="button" id="cancel-lifecycle" class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-200">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500">Save Update</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Lifecycle History Modal -->
    <div id="lifecycle-history-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Task Lifecycle History</h3>
                <button id="close-history-modal" class="text-gray-400 hover:text-gray-600 rounded-full bg-gray-100 hover:bg-gray-200 transition-colors p-2 focus:outline-none focus:ring-2 focus:ring-gray-300">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            
            <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                <h4 id="history-task-title" class="text-lg font-medium text-gray-900 mb-2"></h4>
                <div class="grid grid-cols-2 gap-4 text-sm text-gray-600">
                    <div>
                        <span class="font-medium">Current Status:</span>
                        <span id="history-current-status" class="ml-1"></span>
                    </div>
                    <div>
                        <span class="font-medium">Last Updated:</span>
                        <span id="history-last-updated" class="ml-1"></span>
                    </div>
                </div>
            </div>

            <div class="space-y-4" id="lifecycle-timeline">
                <!-- Timeline entries will be populated here -->
            </div>
        </div>
    </div>

    <!-- Feedback Button -->
    <button onclick="toggleFeedbackForm()" class="fixed left-4 bottom-4 z-50 flex items-center gap-2 rounded-lg bg-blue-600 px-4 py-2 text-sm font-medium text-white hover:bg-blue-700">
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path>
        </svg>
        Feedback
    </button>

    <!-- Feedback Form Modal -->
    <div id="feedbackModal" class="fixed inset-0 z-50 hidden">
        <div class="absolute inset-0 bg-black bg-opacity-50" onclick="toggleFeedbackForm()"></div>
        <div class="fixed left-4 bottom-4 w-full max-w-md">
            <div class="rounded-2xl border border-gray-200 bg-white">
                <div class="px-5 py-4 sm:px-6 sm:py-5">
                    <div class="flex items-center justify-between">
                        <h3 class="text-base font-medium text-gray-800">
                            Feedback Form
                        </h3>
                        <button onclick="toggleFeedbackForm()" class="text-gray-400 hover:text-gray-500">
                            <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="p-5 space-y-6 border-t border-gray-100 sm:p-6">
                    <form id="feedbackForm" onsubmit="submitFeedback(event)">
                        <div class="-mx-2.5 flex flex-wrap gap-y-5">
                            <div class="w-full px-2.5">
                                <input type="text" id="feedbackName" placeholder="Your Name (Optional)"
                                    class="h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10">
                            </div>

                            <div class="w-full px-2.5">
                                <select id="feedbackType" required
                                    class="h-11 w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10">
                                    <option value="">Select Feedback Type</option>
                                    <option value="suggestion">Suggestion</option>
                                    <option value="bug">Bug Report</option>
                                    <option value="improvement">Improvement</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>

                            <div class="w-full px-2.5">
                                <textarea id="feedbackMessage" placeholder="Your Feedback" required rows="4"
                                    class="w-full rounded-lg border border-gray-300 bg-transparent px-4 py-2.5 text-sm text-gray-800 shadow-theme-xs placeholder:text-gray-400 focus:border-brand-300 focus:outline-hidden focus:ring-3 focus:ring-brand-500/10"></textarea>
                            </div>

                            <div class="w-full px-2.5">
                                <button type="submit" class="w-full p-3 text-sm font-medium text-white transition-colors rounded-lg bg-blue-500 hover:bg-blue-800">
                                    Submit Feedback
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Function to fetch tasks from Confluence (always use tasks.json)
        async function fetchTasks() {
            try {
                const response = await fetch(`https://cedt-confluence.net/confluence/download/attachments/2740868871/tasks.json?api=v2`);
                if (!response.ok) {
                    throw new Error(`Failed to load data: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                return data.tasks || [];
            } catch (error) {
                console.error('Error fetching tasks:', error);
                showNotification('Error', 'Error loading tasks. Please try again.', 'error');
                return [];
            }
        }

        // Function to save tasks to Confluence (always use tasks.json)
        async function saveTasks(tasks, showNotifications = true) {
            try {
                // Get the attachment ID for tasks.json
                const attachmentsResponse = await fetch(`https://cedt-confluence.net/confluence/rest/api/content/2740868871/child/attachment?filename=tasks.json`);
                const attachmentsData = await attachmentsResponse.json();
                if (!attachmentsData.results || attachmentsData.results.length === 0) {
                    throw new Error('tasks.json attachment not found');
                }
                const attachmentId = attachmentsData.results[0].id;
                // Update the existing attachment
                const formData = new FormData();
                const blob = new Blob([JSON.stringify({ tasks }, null, 2)], { type: 'application/json' });
                formData.append('file', blob, 'tasks.json');
                const response = await fetch(`https://cedt-confluence.net/confluence/rest/api/content/2740868871/child/attachment/${attachmentId}`, {
                    method: 'POST',
                    headers: {
                        'X-Atlassian-Token': 'no-check'
                    },
                    body: formData
                });
                if (!response.ok) {
                    throw new Error(`Failed to save tasks.json: ${response.status} ${response.statusText}`);
                }
                if (showNotifications) {
                    showNotification('Success', 'Tasks saved successfully', 'notification');
                }
                return await response.json();
            } catch (error) {
                console.error('Error saving tasks:', error);
                if (showNotifications) {
                    showNotification('Error', 'Error saving tasks. Please try again.', 'error');
                }
                throw error;
            }
        }

        // Initialize view switching
        document.addEventListener('DOMContentLoaded', async function () {
            // Load initial tasks
            await loadTasksFromConfluence(false); // Pass false to prevent initial notifications

            // Add refresh button functionality
            document.getElementById('refresh-data').addEventListener('click', async function() {
                loadTasksFromConfluence();
            });

            // Function to load tasks from Confluence
            async function loadTasksFromConfluence(showNotifications = true) {
                try {
                    // Reset all counters to 0 first
                    document.querySelectorAll('.task-counter').forEach(counter => {
                        counter.textContent = '0';
                    });
                    
                    // Clear existing tasks from UI *before* fetching new ones
                    document.querySelectorAll('.task-list').forEach(list => list.innerHTML = '');

                    const tasks = await fetchTasks();
                    
                    if (tasks.length > 0) {
                        // Add tasks to their respective columns
                        tasks.forEach(task => {
                            const column = document.getElementById(`${task.column}-column`);
                            if (column) {
                                const taskCard = document.createElement('div');
                                taskCard.className = 'bg-white rounded p-3 mb-3 shadow-sm border border-gray-200 task-card';
                                taskCard.dataset.id = task.id;
                                taskCard.dataset.priority = task.priority;
                                taskCard.dataset.assignedUser = task.assignedUser;
                                taskCard.dataset.submittedBy = task.submittedBy;
                                taskCard.dataset.startDate = task.startDate;
                                taskCard.dataset.dueDate = task.dueDate;
                                taskCard.innerHTML = createTaskCardHTML(task);
                                column.appendChild(taskCard);
                            }
                        });
                        
                        // Update counters and table view only after all tasks are added
                        updateTaskCounters();
                        updateTableView();
                        if (showNotifications === true) {
                            showNotification('Success', 'Tasks loaded successfully', 'notification');
                        }
                    } else if (showNotifications) {
                        showNotification('Info', 'No tasks found', 'message');
                    }
                } catch (error) {
                    console.error('Error loading tasks:', error);
                    if (showNotifications) {
                    showNotification('Error', 'Error loading tasks. Please try again.', 'error');
                    }
                    // Reset counters to 0 on error
                    document.querySelectorAll('.task-counter').forEach(counter => {
                        counter.textContent = '0';
                    });
                }
            }

            // Add search functionality
            document.getElementById('searchInput').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                
                // Search in Kanban view
                document.querySelectorAll('.task-card').forEach(card => {
                    const title = card.querySelector('h3').textContent.toLowerCase();
                    const description = card.querySelector('p').textContent.toLowerCase();
                    const tag = card.querySelector('span').textContent.toLowerCase();
                    const priority = card.dataset.priority.toLowerCase();
                    const assignedUser = (card.dataset.assignedUser || '').toLowerCase();
                    
                    const matches = title.includes(searchTerm) || 
                                  description.includes(searchTerm) || 
                                  tag.includes(searchTerm) || 
                                  priority.includes(searchTerm) || 
                                  assignedUser.includes(searchTerm);
                    
                    card.style.display = matches ? 'block' : 'none';
                });
                
                // Search in Table view
                document.querySelectorAll('#table-body tr').forEach(row => {
                    const cells = row.querySelectorAll('td');
                    const matches = Array.from(cells).some(cell => 
                        cell.textContent.toLowerCase().includes(searchTerm)
                    );
                    
                    row.style.display = matches ? '' : 'none';
                });
            });

            // Add MutationObserver to update table view when tasks are modified
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'childList' || mutation.type === 'attributes') {
                    updateTableView();
                }
                });
            });

            // Observe task lists for changes
            document.querySelectorAll('.task-list').forEach(list => {
                observer.observe(list, {
                    childList: true,
                    attributes: true,
                    subtree: true
                });
            });

            // Initialize sortable for each column
            const columns = document.querySelectorAll('.task-list');
            columns.forEach(column => {
                new Sortable(column, {
                    group: 'kanban',
                    animation: 150,
                    ghostClass: 'bg-gray-100',
                    onEnd: async function (evt) {
                        const taskElement = evt.item;
                        const taskId = taskElement.dataset.id;
                        const newColumn = evt.to.id.replace('-column', '');
                        const oldColumn = evt.from.id.replace('-column', '');
                        
                        // Only show lifecycle modal if task actually moved to a different column
                        if (newColumn !== oldColumn) {
                            showLifecycleModal(taskId, oldColumn, newColumn, taskElement);
                        } else {
            updateTaskCounters();
                        }
                    }
                });
            });

            // Add Task Modal Functionality
            const taskModal = document.getElementById('task-modal');
            const taskForm = document.getElementById('task-form');
            const closeModal = document.getElementById('close-modal');
            const cancelTask = document.getElementById('cancel-task');

            // Function to show modal
            function showTaskModal(column) {
                document.getElementById('form-column').value = column;
                document.getElementById('task-id').value = ''; // Reset task ID for new tasks
                taskForm.reset(); // Reset form
                taskModal.classList.remove('hidden');
            }

            // Function to hide modal
            function hideTaskModal() {
                taskModal.classList.add('hidden');
                    taskForm.reset();
            }

            // Add event listeners for Add Task buttons
            document.getElementById('add-todo').addEventListener('click', () => showTaskModal('todo'));
            document.getElementById('add-progress').addEventListener('click', () => showTaskModal('progress'));
            document.getElementById('add-review').addEventListener('click', () => showTaskModal('review'));
            document.getElementById('add-done').addEventListener('click', () => showTaskModal('done'));

            // Close modal event listeners
            closeModal.addEventListener('click', hideTaskModal);
            cancelTask.addEventListener('click', hideTaskModal);

            // Handle form submission
            taskForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                // Capture form data before hiding modal
                const taskId = document.getElementById('task-id').value;
                const isNewTask = !taskId;
                const currentTime = new Date().toISOString();
                
                const taskData = {
                    id: taskId || Date.now().toString(),
                    title: document.getElementById('task-title').value,
                    description: document.getElementById('task-description').value,
                    tag: document.getElementById('task-tag').value,
                    priority: document.getElementById('task-priority').value,
                    assignedUser: document.getElementById('task-assigned-user').value,
                    submittedBy: document.getElementById('task-submitted-by').value,
                    startDate: document.getElementById('task-start-date').value,
                    dueDate: document.getElementById('task-due').value,
                    column: document.getElementById('form-column').value,
                    createdAt: isNewTask ? currentTime : undefined,
                    updatedAt: currentTime
                };

                // Hide modal first
                hideTaskModal();

                try {
                    // Get existing tasks
                    const tasks = await fetchTasks();
                    
                    // Add new task or update existing one
                    const taskIndex = tasks.findIndex(t => t.id === taskData.id);
                    if (taskIndex !== -1) {
                        // Update existing task
                        const existingTask = tasks[taskIndex];
                        
                        // Preserve creation date and lifecycle
                        taskData.createdAt = existingTask.createdAt;
                        taskData.lifecycle = existingTask.lifecycle || [];
                        
                        // Add lifecycle entry for edit
                        const lifecycleEntry = {
                            id: `lc_${Date.now()}`,
                            timestamp: taskData.updatedAt,
                            fromStatus: existingTask.column,
                            toStatus: taskData.column,
                            updateType: 'other',
                            comments: 'Task details updated',
                            updatedBy: taskData.submittedBy || taskData.assignedUser || 'Unknown'
                        };
                        taskData.lifecycle.push(lifecycleEntry);
                        
                        tasks[taskIndex] = taskData;
                    } else {
                        // New task - initialize lifecycle
                        taskData.lifecycle = [{
                            id: `lc_${Date.now()}`,
                            timestamp: taskData.createdAt,
                            fromStatus: null,
                            toStatus: taskData.column,
                            updateType: 'creation',
                            comments: 'Task created',
                            updatedBy: taskData.submittedBy || taskData.assignedUser || 'Unknown'
                        }];
                        tasks.push(taskData);
                    }

                    // Save updated tasks without showing notification
                    await saveTasks(tasks, false);
                    
                    // Update UI without showing notification
                    await loadTasksFromConfluence(false);
                    
                    // Show single success notification
                    showNotification('Success', 'Task saved successfully', 'notification');
                } catch (error) {
                    console.error('Error saving task:', error);
                    showNotification('Error', 'Error saving task. Please try again.', 'error');
                }
            });

                    // Update task counters initially
        updateTaskCounters();

        // Metrics and Charts functionality
        let charts = {};

        // Function to update metrics
        function updateMetrics(showNotifications = false) {
            try {
                const tasks = getAllTasksFromDOM();
                console.log('Updating metrics with', tasks.length, 'tasks');
                
                // Update summary cards
                document.getElementById('total-tasks-metric').textContent = tasks.length;
                document.getElementById('completed-tasks-metric').textContent = tasks.filter(t => t.column === 'done').length;
                document.getElementById('progress-tasks-metric').textContent = tasks.filter(t => t.column === 'progress').length;
                
                // Calculate overdue tasks
                const overdueTasks = tasks.filter(task => {
                    if (!task.dueDate) return false;
                    const today = new Date();
                    const dueDate = new Date(task.dueDate);
                    return dueDate < today && task.column !== 'done';
                });
                document.getElementById('overdue-tasks-metric').textContent = overdueTasks.length;

                // Update charts only if containers exist and there are tasks
                if (tasks.length === 0) {
                    // Handle empty state for all charts
                    if (document.getElementById('statusChart')) {
                        updateStatusChart([]);
                    }
                    if (document.getElementById('priorityChart')) {
                        updatePriorityChart([]);
                    }
                    if (document.getElementById('tagChart')) {
                        updateTagChart([]);
                    }
                    if (document.getElementById('assigneeChart')) {
                        updateAssigneeChart([]);
                    }
                    if (document.getElementById('timelineChart')) {
                        updateTimelineChart([]);
                    }
                    
                    // Show message for no data only if notifications are enabled
                    if (showNotifications) {
                        showNotification('Info', 'No task data available for metrics visualization', 'message');
                    }
                } else {
                    // Update charts with actual data
                    if (document.getElementById('statusChart')) {
                        updateStatusChart(tasks);
                    }
                    if (document.getElementById('priorityChart')) {
                        updatePriorityChart(tasks);
                    }
                    if (document.getElementById('tagChart')) {
                        updateTagChart(tasks);
                    }
                    if (document.getElementById('assigneeChart')) {
                        updateAssigneeChart(tasks);
                    }
                    if (document.getElementById('timelineChart')) {
                        updateTimelineChart(tasks);
                    }
                    
                    // Show success message for data loaded only if notifications are enabled
                    if (showNotifications) {
                        showNotification('Success', `Metrics updated successfully with ${tasks.length} tasks`, 'success');
                    }
                }
            } catch (error) {
                console.error('Error updating metrics:', error);
                showNotification('Error', 'Error updating metrics. Please try again.', 'error');
            }
        }

        // Status Distribution Chart
        function updateStatusChart(tasks) {
            try {
                const ctx = document.getElementById('statusChart').getContext('2d');
                if (window.statusChart) {
                    window.statusChart.destroy();
                }

                if (!tasks || tasks.length === 0) {
                    window.statusChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['No Data'],
                            datasets: [{
                                data: [1],
                                backgroundColor: ['#e0e0e0'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    enabled: false
                                }
                            },
                            cutout: '70%'
                        }
                    });
                    return;
                }

                const statusCounts = {
                    'todo': 0,
                    'progress': 0,
                    'review': 0,
                    'done': 0
                };

                tasks.forEach(task => {
                    if (statusCounts.hasOwnProperty(task.column)) {
                        statusCounts[task.column]++;
                    }
                });

                window.statusChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['To Do', 'In Progress', 'Review', 'Done'],
                        datasets: [{
                            data: [statusCounts.todo, statusCounts.progress, statusCounts.review, statusCounts.done],
                            backgroundColor: ['#ff9800', '#2196f3', '#9c27b0', '#4caf50'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true
                                }
                            }
                        },
                        cutout: '70%'
                    }
                });
            } catch (error) {
                console.error('Error updating status chart:', error);
                showNotification('Error', 'Error updating status chart', 'error');
            }
        }

        // Priority Distribution Chart
        function updatePriorityChart(tasks) {
            try {
                const ctx = document.getElementById('priorityChart').getContext('2d');
                if (window.priorityChart) {
                    window.priorityChart.destroy();
                }

                if (!tasks || tasks.length === 0) {
                    window.priorityChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['No Data'],
                            datasets: [{
                                data: [0],
                                backgroundColor: '#e0e0e0',
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    enabled: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    display: false
                                },
                                x: {
                                    display: false
                                }
                            }
                        }
                    });
                    return;
                }

                const priorityCounts = {
                    'urgent': 0,
                    'high': 0,
                    'medium': 0,
                    'low': 0,
                    'none': 0
                };

                tasks.forEach(task => {
                    if (priorityCounts.hasOwnProperty(task.priority)) {
                        priorityCounts[task.priority]++;
                    }
                });

                window.priorityChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Urgent', 'High', 'Medium', 'Low', 'None'],
                        datasets: [{
                            data: [priorityCounts.urgent, priorityCounts.high, priorityCounts.medium, priorityCounts.low, priorityCounts.none],
                            backgroundColor: ['#d32f2f', '#f44336', '#ff9800', '#4caf50', '#9e9e9e'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                display: false
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error updating priority chart:', error);
                showNotification('Error', 'Error updating priority chart', 'error');
            }
        }

        // Tag Distribution Chart
        function updateTagChart(tasks) {
            try {
                const ctx = document.getElementById('tagChart').getContext('2d');
                if (window.tagChart) {
                    window.tagChart.destroy();
                }

                if (!tasks || tasks.length === 0) {
                    window.tagChart = new Chart(ctx, {
                        type: 'pie',
                        data: {
                            labels: ['No Data'],
                            datasets: [{
                                data: [1],
                                backgroundColor: ['#e0e0e0'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    enabled: false
                                }
                            }
                        }
                    });
                    return;
                }

                const tagCounts = {};
                const tagNames = {
                    'blue': 'New Development',
                    'red': 'Bug',
                    'purple': 'Design',
                    'green': 'Enhancement',
                    'yellow': 'Ad Hoc'
                };
                
                tasks.forEach(task => {
                    if (task.tag) {
                        const tagName = tagNames[task.tag] || task.tag;
                        tagCounts[tagName] = (tagCounts[tagName] || 0) + 1;
                    }
                });

                const labels = Object.keys(tagCounts);
                const data = Object.values(tagCounts);
                const backgroundColors = labels.map((_, i) => 
                    `hsl(${(i * 360) / labels.length}, 70%, 50%)`
                );

                window.tagChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColors,
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    padding: 20,
                                    usePointStyle: true
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error updating tag chart:', error);
                showNotification('Error', 'Error updating tag chart', 'error');
            }
        }

        // Assignee Workload Chart
        function updateAssigneeChart(tasks) {
            try {
                const ctx = document.getElementById('assigneeChart').getContext('2d');
                if (window.assigneeChart) {
                    window.assigneeChart.destroy();
                }

                if (!tasks || tasks.length === 0) {
                    window.assigneeChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: ['No Data'],
                            datasets: [{
                                data: [0],
                                backgroundColor: '#e0e0e0',
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    enabled: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    display: false
                                },
                                x: {
                                    display: false
                                }
                            }
                        }
                    });
                    return;
                }

                const assigneeCounts = {};
                tasks.forEach(task => {
                    if (task.assignedUser) {
                        assigneeCounts[task.assignedUser] = (assigneeCounts[task.assignedUser] || 0) + 1;
                    }
                });

                const labels = Object.keys(assigneeCounts);
                const data = Object.values(assigneeCounts);
                const backgroundColors = labels.map((_, i) => 
                    `hsl(${(i * 360) / labels.length}, 70%, 50%)`
                );

                window.assigneeChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: backgroundColors,
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                display: false
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error updating assignee chart:', error);
                showNotification('Error', 'Error updating assignee chart', 'error');
            }
        }

        // Timeline Chart
        function updateTimelineChart(tasks) {
            try {
                const ctx = document.getElementById('timelineChart').getContext('2d');
                if (window.timelineChart) {
                    window.timelineChart.destroy();
                }

                if (!tasks || tasks.length === 0) {
                    window.timelineChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['No Data'],
                            datasets: [{
                                data: [0],
                                borderColor: '#e0e0e0',
                                borderWidth: 2,
                                pointRadius: 0,
                                fill: false
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                },
                                tooltip: {
                                    enabled: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    display: false
                                },
                                x: {
                                    display: false
                                }
                            }
                        }
                    });
                    return;
                }

                const last7Days = Array.from({length: 7}, (_, i) => {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    return date.toISOString().split('T')[0];
                }).reverse();

                const taskCounts = last7Days.map(date => 
                    tasks.filter(task => task.dueDate === date).length
                );

                window.timelineChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: last7Days.map(date => new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })),
                        datasets: [{
                            data: taskCounts,
                            borderColor: '#2196f3',
                            borderWidth: 2,
                            pointRadius: 4,
                            pointBackgroundColor: '#2196f3',
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                display: false
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error updating timeline chart:', error);
                showNotification('Error', 'Error updating timeline chart', 'error');
            }
        }

        // Update metrics when tasks change
        const originalUpdateTaskCounters = updateTaskCounters;
        updateTaskCounters = function() {
            originalUpdateTaskCounters();
            // Only update metrics if metrics view is active
            try {
                const alpineElement = document.querySelector('[x-data]');
                if (alpineElement && alpineElement.__x && alpineElement.__x.$data && alpineElement.__x.$data.activeView === 'metrics') {
                    updateMetrics();
                }
            } catch (error) {
                // Silently ignore Alpine.js access errors during initialization
                console.debug('Alpine.js not ready for metrics update');
            }
        };

        const originalUpdateTableView = updateTableView;
        updateTableView = function() {
            originalUpdateTableView();
            // Only update metrics if metrics view is active
            try {
                const alpineElement = document.querySelector('[x-data]');
                if (alpineElement && alpineElement.__x && alpineElement.__x.$data && alpineElement.__x.$data.activeView === 'metrics') {
                    updateMetrics();
                }
            } catch (error) {
                // Silently ignore Alpine.js access errors during initialization
                console.debug('Alpine.js not ready for metrics update');
            }
        };

        // Initialize metrics when metrics tab is clicked
        document.addEventListener('click', function(e) {
            if (e.target.closest('button') && e.target.textContent.includes('Metrics')) {
        setTimeout(() => {
            updateMetrics(true);
                }, 100);
            }
        });

        // Also initialize metrics after initial data load
        setTimeout(() => {
            try {
                const alpineElement = document.querySelector('[x-data]');
                if (alpineElement && alpineElement.__x && alpineElement.__x.$data && alpineElement.__x.$data.activeView === 'metrics') {
                    updateMetrics();
                }
            } catch (error) {
                console.debug('Alpine.js not ready for initial metrics update');
            }
        }, 2000);
        });

        // Update notification function to handle error type
        function showNotification(title, message, type = 'notification') {
            const container = document.getElementById('notificationsContainer');
            const notification = document.createElement('div');
            
            const bgColor = type === 'error' 
                ? 'bg-red-100' 
                : type === 'message' 
                    ? 'bg-blue-100' 
                    : type === 'success'
                        ? 'bg-green-100'
                        : 'bg-green-100';
            
            const iconColor = type === 'error'
                ? 'text-red-600'
                : type === 'message'
                    ? 'text-blue-600'
                    : type === 'success'
                        ? 'text-green-600'
                        : 'text-green-600';

            const icon = type === 'error'
                ? `<svg class="h-5 w-5 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>`
                : type === 'message'
                    ? `<svg class="h-5 w-5 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path>
                    </svg>`
                    : type === 'success'
                        ? `<svg class="h-5 w-5 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>`
                        : `<svg class="h-5 w-5 ${iconColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path>
                        </svg>`;

            notification.className = `flex items-center gap-4 rounded-lg border border-gray-200 bg-white p-4 shadow-lg notification-item`;
            
            notification.innerHTML = `
                <div class="flex h-10 w-10 items-center justify-center rounded-full ${bgColor}">
                    ${icon}
                </div>
                <div class="flex-1">
                    <h4 class="text-sm font-medium text-gray-900">${title}</h4>
                    <p class="text-sm text-gray-500">${message}</p>
                </div>
                <button class="text-gray-400 hover:text-gray-500 close-notification">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            `;

            container.appendChild(notification);

            // Add close button functionality
            const closeButton = notification.querySelector('.close-notification');
            closeButton.addEventListener('click', () => {
                notification.remove();
            });

            // Auto close after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Feedback form functions
        function toggleFeedbackForm() {
            const modal = document.getElementById('feedbackModal');
            modal.classList.toggle('hidden');
        }

        async function submitFeedback(event) {
            event.preventDefault();
            
            const feedbackData = {
                id: `fb_${Date.now()}`,
                name: document.getElementById('feedbackName').value || 'Anonymous',
                type: document.getElementById('feedbackType').value,
                message: document.getElementById('feedbackMessage').value,
                timestamp: new Date().toISOString()
            };

            try {
                // First, get the attachment ID for feedback.json
                const attachmentsResponse = await fetch('https://cedt-confluence.net/confluence/rest/api/content/2740868871/child/attachment?filename=feedback.json');
                const attachmentsData = await attachmentsResponse.json();
                
                let attachmentId;
                let existingFeedback = { feedback: [], metadata: { lastUpdated: '', totalFeedback: 0, feedbackTypes: {} } };

                if (attachmentsData.results && attachmentsData.results.length > 0) {
                    // If feedback.json exists, get its content
                    attachmentId = attachmentsData.results[0].id;
                    const feedbackResponse = await fetch(`https://cedt-confluence.net/confluence/download/attachments/2740868871/feedback.json?api=v2`);
                    if (feedbackResponse.ok) {
                        existingFeedback = await feedbackResponse.json();
                    }
                }

                // Add new feedback
                existingFeedback.feedback.unshift(feedbackData);

                // Update metadata
                existingFeedback.metadata = {
                    lastUpdated: feedbackData.timestamp,
                    totalFeedback: existingFeedback.feedback.length,
                    feedbackTypes: existingFeedback.feedback.reduce((acc, fb) => {
                        acc[fb.type] = (acc[fb.type] || 0) + 1;
                        return acc;
                    }, {})
                };

                // Create or update the attachment
                const formData = new FormData();
                const blob = new Blob([JSON.stringify(existingFeedback, null, 2)], { type: 'application/json' });
                formData.append('file', blob, 'feedback.json');

                const response = await fetch(`https://cedt-confluence.net/confluence/rest/api/content/2740868871/child/attachment${attachmentId ? `/${attachmentId}` : ''}`, {
                    method: 'POST',
                    headers: {
                        'X-Atlassian-Token': 'no-check'
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Failed to save feedback: ${response.status} ${response.statusText}`);
                }

                showNotification('Success', 'Thank you for your feedback!', 'success');
                document.getElementById('feedbackForm').reset();
                toggleFeedbackForm();
            } catch (error) {
                console.error('Error submitting feedback:', error);
                showNotification('Error', 'Failed to submit feedback. Please try again.', 'error');
            }
        }

        // Helper function to create task card HTML
        function createTaskCardHTML(task) {
            const tagColors = {
                blue: 'bg-blue-100 text-blue-800 border-blue-200',
                purple: 'bg-purple-100 text-purple-800 border-purple-200',
                yellow: 'bg-yellow-100 text-yellow-800 border-yellow-200',
                green: 'bg-green-100 text-green-800 border-green-200',
                red: 'bg-red-100 text-red-800 border-red-200',
                indigo: 'bg-indigo-100 text-indigo-800 border-indigo-200'
            };

            const priorityColors = {
                none: 'bg-gray-100 text-gray-600 border-gray-200',
                low: 'bg-blue-100 text-blue-700 border-blue-200',
                medium: 'bg-yellow-100 text-yellow-700 border-yellow-200',
                high: 'bg-orange-100 text-orange-700 border-orange-200',
                urgent: 'bg-red-100 text-red-700 border-red-200'
            };

            const tagColor = tagColors[task.tag] || 'bg-gray-100 text-gray-800 border-gray-200';
            const priorityColor = priorityColors[task.priority] || 'bg-gray-100 text-gray-800 border-gray-200';

            // Get user avatar (using initials)
            const getUserAvatar = (userName) => {
                if (!userName) return 'UN';
                const initials = userName.split(' ').map(name => name.charAt(0)).join('').toUpperCase();
                return initials.substring(0, 2);
            };

            // Get avatar color based on user name
            const getAvatarColor = (userName) => {
                const colors = [
                    'bg-blue-500', 'bg-green-500', 'bg-purple-500', 'bg-pink-500', 
                    'bg-indigo-500', 'bg-yellow-500', 'bg-red-500', 'bg-gray-500'
                ];
                if (!userName) return colors[0];
                const hash = userName.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
                return colors[hash % colors.length];
            };

            // Priority icon
            const getPriorityIcon = (priority) => {
                switch(priority) {
                    case 'urgent':
                        return `<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>`;
                    case 'high':
                        return `<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>`;
                    case 'medium':
                        return `<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                        </svg>`;
                    case 'low':
                        return `<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M14.707 12.707a1 1 0 01-1.414 0L10 9.414l-3.293 3.293a1 1 0 01-1.414-1.414l4-4a1 1 0 011.414 0l4 4a1 1 0 010 1.414z" clip-rule="evenodd"></path>
                        </svg>`;
                    default:
                        return `<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd"></path>
                        </svg>`;
                }
            };

            // Tag icon
            const getTagIcon = (tag) => {
                switch(tag) {
                    case 'blue': // New Development
                        return `<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z" clip-rule="evenodd"></path>
                        </svg>`;
                    case 'red': // Bug
                        return `<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                        </svg>`;
                    case 'purple': // Design
                        return `<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
                        </svg>`;
                    case 'green': // Enhancement
                        return `<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M12.316 3.051a1 1 0 01.633 1.265l-4 12a1 1 0 11-1.898-.632l4-12a1 1 0 011.265-.633zM5.707 6.293a1 1 0 010 1.414L3.414 10l2.293 2.293a1 1 0 11-1.414 1.414l-3-3a1 1 0 010-1.414l3-3a1 1 0 011.414 0zm8.586 0a1 1 0 011.414 0l3 3a1 1 0 010 1.414l-3 3a1 1 0 11-1.414-1.414L16.586 10l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>`;
                    case 'yellow': // Ad Hoc
                        return `<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h6a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path>
                        </svg>`;
                    default:
                        return `<svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M17.707 9.293a1 1 0 010 1.414l-7 7a1 1 0 01-1.414 0l-7-7A.997.997 0 012 10V5a3 3 0 013-3h5c.256 0 .512.098.707.293l7 7zM5 6a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"></path>
                        </svg>`;
                }
            };

            // Truncate description to 2 lines (approximately 80 characters)
            const truncateDescription = (text, maxLength = 80) => {
                if (!text) return 'No description';
                if (text.length <= maxLength) return text;
                return text.substring(0, maxLength).trim() + '...';
            };

            // Get submitted by (use assigned user if no specific submitter)
            const submittedBy = task.submittedBy || task.assignedUser || 'Unknown';

            return `
                <!-- Tags and menu -->
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center gap-2">
                        <span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium ${tagColor}">
                            ${getTagIcon(task.tag)}
                            ${getTagName(task.tag)}
                        </span>
            </div>
                    <div class="relative">
                        <button class="text-gray-400 hover:text-gray-600 p-1 rounded-full hover:bg-gray-100 transition-colors" onclick="toggleTaskMenu('${task.id}')">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path>
                            </svg>
                        </button>
                        <div id="menu-${task.id}" class="hidden absolute right-0 mt-1 w-40 bg-white rounded-lg shadow-lg z-10 task-menu-dropdown">
                            <button onclick="editTask('${task.id}')" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-50 rounded-t-lg">Edit</button>
                            <button onclick="viewLifecycleHistory('${task.id}')" class="block w-full text-left px-4 py-2 text-sm text-blue-600 hover:bg-gray-50">View History</button>
                            <button onclick="deleteTask('${task.id}')" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-gray-50 rounded-b-lg">Delete</button>
        </div>
    </div>
                </div>
                
                <!-- Title -->
                <div class="mb-2">
                    <h3 class="font-semibold text-gray-900 text-sm leading-5">${task.title}</h3>
                </div>
                
                <!-- Description -->
                <div class="mb-3">
                    <p class="text-gray-600 text-xs leading-4" title="${task.description}">${truncateDescription(task.description)}</p>
                </div>
                
                <!-- Assigned to section -->
                <div class="mb-3">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xs text-gray-500">Assigned to:</span>
                        <div class="flex items-center gap-1">
                            <div class="w-6 h-6 ${getAvatarColor(task.assignedUser)} rounded-full flex items-center justify-center text-white text-xs font-medium">
                                ${getUserAvatar(task.assignedUser)}
                            </div>
                            <span class="text-xs text-gray-600 font-medium">${task.assignedUser || 'Unassigned'}</span>
                        </div>
                    </div>
                </div>
                
                <!-- Footer with date and priority -->
                <div class="py-2 border-t border-gray-100 flex items-center justify-between mb-2">
                    <div class="flex items-center gap-1 text-xs text-gray-500">
                        <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                        </svg>
                        ${formatDate(task.dueDate)}
                    </div>
                    <span class="px-2 py-1 rounded text-xs font-medium ${priorityColor}">
                        ${task.priority.charAt(0).toUpperCase() + task.priority.slice(1)}
                    </span>
                </div>
                
                <!-- Days pending - centered -->
                <div class="py-2 border-t border-gray-100 flex items-center justify-center mb-2">
                    <div class="flex items-center gap-1">
                        <svg class="w-4 h-4 ${getDaysUntilDeadlineColor(task.dueDate)}" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                        </svg>
                        <span class="text-xs font-medium ${getDaysUntilDeadlineColor(task.dueDate)}">${getDaysUntilDeadline(task.dueDate)} days</span>
                    </div>
                </div>
                
                <!-- Submitted by - right aligned, edge-to-edge -->
                <div class="bg-gray-50 border-t border-gray-100">
                    <div class="flex items-center justify-between px-3 py-2">
                        <div class="flex items-center gap-1.5">
                            <svg class="w-3 h-3 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path>
                            </svg>
                            <span class="text-xs text-gray-500">Submitted by</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <div class="w-4 h-4 ${getAvatarColor(submittedBy)} rounded-full flex items-center justify-center text-white text-xs font-medium">
                                ${getUserAvatar(submittedBy).charAt(0)}
                            </div>
                            <span class="text-xs text-gray-600 font-medium">${submittedBy}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Helper function to get tag name
        function getTagName(tag) {
            const tagNames = {
                blue: 'New Development',
                red: 'Bug',
                purple: 'Design',
                green: 'Enhancement',
                yellow: 'Ad Hoc'
            };
            return tagNames[tag] || 'Other';
        }

        // Helper function to get status color
        function getStatusColor(status) {
            const statusColors = {
                'todo': 'bg-blue-500',
                'progress': 'bg-blue-500',
                'review': 'bg-purple-500',
                'done': 'bg-pink-500'
            };
            return statusColors[status] || 'bg-gray-500';
        }

        // Helper function to calculate days until deadline
        function getDaysUntilDeadline(dueDate) {
            if (!dueDate) return 'No deadline';
            
            const today = new Date();
            const deadline = new Date(dueDate);
            const timeDiff = deadline.getTime() - today.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
            
            if (daysDiff < 0) {
                return `${Math.abs(daysDiff)} overdue`;
            } else if (daysDiff === 0) {
                return 'Due today';
            } else {
                return daysDiff;
            }
        }

        // Helper function to get color based on days until deadline
        function getDaysUntilDeadlineColor(dueDate) {
            if (!dueDate) return 'text-gray-500';
            
            const today = new Date();
            const deadline = new Date(dueDate);
            const timeDiff = deadline.getTime() - today.getTime();
            const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
            
            if (daysDiff < 0) {
                return 'text-red-600'; // Overdue
            } else if (daysDiff <= 13) {
                return 'text-red-600'; // 0-13 days - red
            } else if (daysDiff <= 30) {
                return 'text-amber-600'; // 14-30 days - amber
            } else {
                return 'text-green-600'; // >30 days - green
            }
        }

        // Helper function to format date
        function formatDate(dateString) {
            if (!dateString) return 'No date';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Helper function to update task counters
        function updateTaskCounters() {
            const columns = ['todo', 'progress', 'review', 'done'];
            columns.forEach(column => {
                const columnElement = document.getElementById(`${column}-column`);
                const counter = columnElement.parentElement.querySelector('.task-counter');
                const taskCount = columnElement.children.length;
                counter.textContent = taskCount;
            });
        }

        // Helper function to update table view
        function updateTableView() {
            const tableBody = document.getElementById('table-body');
            tableBody.innerHTML = '';

            const allTasks = getAllTasksFromDOM();
            allTasks.forEach(task => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${task.title}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${task.description}</td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-${task.tag}-100 text-${task.tag}-800">
                            ${getTagName(task.tag)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-gray-100 text-gray-800">
                            ${task.priority}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${task.assignedUser || 'Unassigned'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${task.submittedBy || 'Unknown'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${task.startDate || 'Not set'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${task.dueDate || 'Not set'}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        <span class="${getDaysUntilDeadlineColor(task.dueDate)}">${getDaysUntilDeadline(task.dueDate)} days</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="editTask('${task.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2">Edit</button>
                        <button onclick="viewLifecycleHistory('${task.id}')" class="text-blue-600 hover:text-blue-900 mr-2">History</button>
                        <button onclick="deleteTask('${task.id}')" class="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Helper function to get all tasks from DOM
        function getAllTasksFromDOM() {
            const tasks = [];
            const columns = ['todo', 'progress', 'review', 'done'];
            
            columns.forEach(column => {
                const columnElement = document.getElementById(`${column}-column`);
                const taskCards = columnElement.querySelectorAll('.task-card');
                
                taskCards.forEach(card => {
                    const task = {
                        id: card.dataset.id,
                        title: card.querySelector('h3').textContent,
                        description: card.querySelector('p').textContent,
                        tag: getTagFromCard(card),
                        priority: card.dataset.priority,
                        assignedUser: card.dataset.assignedUser,
                        submittedBy: card.dataset.submittedBy,
                        startDate: card.dataset.startDate,
                        dueDate: card.dataset.dueDate,
                        column: column
                    };
                    tasks.push(task);
                });
            });
            
            return tasks;
        }

        // Helper function to get tag from card
        function getTagFromCard(card) {
            const tagSpan = card.querySelector('span');
            const tagText = tagSpan.textContent;
            const tagMap = {
                'New Development': 'blue',
                'Bug': 'red',
                'Design': 'purple',
                'Enhancement': 'green',
                'Ad Hoc': 'yellow'
            };
            return tagMap[tagText] || 'blue';
        }

        // Task menu functions
        function toggleTaskMenu(taskId) {
            const menu = document.getElementById(`menu-${taskId}`);
            // Close all other menus first
            document.querySelectorAll('[id^="menu-"]').forEach(m => {
                if (m.id !== `menu-${taskId}`) {
                    m.classList.add('hidden');
                }
            });
            menu.classList.toggle('hidden');
        }

        // Edit task function
        async function editTask(taskId) {
            const taskCard = document.querySelector(`[data-id="${taskId}"]`);
            if (!taskCard) return;

            try {
                // Get task data from server to get complete task info
                const tasks = await fetchTasks();
                const task = tasks.find(t => t.id === taskId);
                
                if (!task) {
                    showNotification('Error', 'Task not found', 'error');
                    return;
                }
                
                // Populate form with existing data from the task object
                document.getElementById('task-id').value = taskId;
                document.getElementById('task-title').value = task.title || '';
                document.getElementById('task-description').value = task.description || '';
                document.getElementById('task-tag').value = task.tag || 'blue';
                document.getElementById('task-priority').value = task.priority || 'none';
                document.getElementById('task-assigned-user').value = task.assignedUser || '';
                document.getElementById('task-submitted-by').value = task.submittedBy || '';
                document.getElementById('task-start-date').value = task.startDate || '';
                document.getElementById('task-due').value = task.dueDate || '';
                document.getElementById('form-column').value = task.column || 'todo';

                // Show modal
                document.getElementById('task-modal').classList.remove('hidden');
                
                // Hide menu
                document.getElementById(`menu-${taskId}`).classList.add('hidden');
            } catch (error) {
                console.error('Error loading task data for editing:', error);
                showNotification('Error', 'Error loading task data', 'error');
            }
        }

        // Delete task function
        async function deleteTask(taskId) {
            // Hide menu first
            const menuElement = document.getElementById(`menu-${taskId}`);
            if (menuElement) {
                menuElement.classList.add('hidden');
            }
            
            if (confirm('Are you sure you want to delete this task?')) {
                try {
                    const tasks = await fetchTasks();
                    const taskToDelete = tasks.find(task => task.id === taskId);
                    
                    if (!taskToDelete) {
                        showNotification('Error', 'Task not found', 'error');
                        return;
                    }
                    
                    const updatedTasks = tasks.filter(task => task.id !== taskId);
                    await saveTasks(updatedTasks, false);
                    await loadTasksFromConfluence(false);
                    showNotification('Success', 'Task deleted successfully', 'success');
                } catch (error) {
                    console.error('Error deleting task:', error);
                    showNotification('Error', 'Error deleting task. Please try again.', 'error');
                }
            }
        }

        // Export to Excel function
        document.getElementById('export-excel').addEventListener('click', async function() {
            try {
                // Get complete task data from server including lifecycle
                const tasks = await fetchTasks();
                
                // Prepare tasks data for export
                const exportData = tasks.map(task => {
                    // Format lifecycle data as a readable string
                    let lifecycleHistory = '';
                    if (task.lifecycle && task.lifecycle.length > 0) {
                        lifecycleHistory = task.lifecycle.map(entry => {
                            const fromStatus = entry.fromStatus ? getStatusDisplayName(entry.fromStatus) : 'Created';
                            const toStatus = getStatusDisplayName(entry.toStatus);
                            const timestamp = formatDateTime(entry.timestamp);
                            return `${timestamp}: ${entry.updatedBy} - ${fromStatus} → ${toStatus} (${entry.updateType}) - ${entry.comments}`;
                        }).join('\n');
                    }
                    
                    return {
                        'Task ID': task.id,
                        'Title': task.title,
                        'Description': task.description,
                        'Tag': getTagName(task.tag),
                        'Priority': task.priority,
                        'Assigned User': task.assignedUser || 'Unassigned',
                        'Submitted By': task.submittedBy || 'Unknown',
                        'Start Date': task.startDate || 'Not set',
                        'Due Date': task.dueDate || 'Not set',
                        'Current Status': getStatusDisplayName(task.column),
                        'Days Until Deadline': getDaysUntilDeadline(task.dueDate),
                        'Created At': formatDateTime(task.createdAt),
                        'Last Updated': formatDateTime(task.updatedAt),
                        'Lifecycle History': lifecycleHistory
                    };
                });
                
                // Create workbook with tasks
                const ws = XLSX.utils.json_to_sheet(exportData);
                
                // Auto-size columns
                const colWidths = [
                    { wch: 15 }, // Task ID
                    { wch: 30 }, // Title
                    { wch: 40 }, // Description
                    { wch: 15 }, // Tag
                    { wch: 10 }, // Priority
                    { wch: 15 }, // Assigned User
                    { wch: 15 }, // Submitted By
                    { wch: 12 }, // Start Date
                    { wch: 12 }, // Due Date
                    { wch: 15 }, // Current Status
                    { wch: 20 }, // Days Until Deadline
                    { wch: 20 }, // Created At
                    { wch: 20 }, // Last Updated
                    { wch: 60 }  // Lifecycle History
                ];
                ws['!cols'] = colWidths;
                
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Tasks");
                
                // Create a separate sheet for detailed lifecycle data
                if (tasks.some(task => task.lifecycle && task.lifecycle.length > 0)) {
                    const lifecycleData = [];
                    tasks.forEach(task => {
                        if (task.lifecycle && task.lifecycle.length > 0) {
                            task.lifecycle.forEach(entry => {
                                lifecycleData.push({
                                    'Task ID': task.id,
                                    'Task Title': task.title,
                                    'Timestamp': formatDateTime(entry.timestamp),
                                    'Updated By': entry.updatedBy,
                                    'From Status': entry.fromStatus ? getStatusDisplayName(entry.fromStatus) : 'Created',
                                    'To Status': getStatusDisplayName(entry.toStatus),
                                    'Update Type': entry.updateType,
                                    'Comments': entry.comments
                                });
                            });
                        }
                    });
                    
                    if (lifecycleData.length > 0) {
                        const lifecycleWs = XLSX.utils.json_to_sheet(lifecycleData);
                        const lifecycleColWidths = [
                            { wch: 15 }, // Task ID
                            { wch: 30 }, // Task Title
                            { wch: 20 }, // Timestamp
                            { wch: 15 }, // Updated By
                            { wch: 15 }, // From Status
                            { wch: 15 }, // To Status
                            { wch: 15 }, // Update Type
                            { wch: 50 }  // Comments
                        ];
                        lifecycleWs['!cols'] = lifecycleColWidths;
                        XLSX.utils.book_append_sheet(wb, lifecycleWs, "Lifecycle History");
                    }
                }
                
                XLSX.writeFile(wb, "kanban_tasks_with_lifecycle.xlsx");
                showNotification('Success', 'Tasks exported to Excel with lifecycle data successfully', 'notification');
            } catch (error) {
                console.error('Error exporting to Excel:', error);
                showNotification('Error', 'Error exporting tasks. Please try again.', 'error');
            }
        });

        // Lifecycle Modal Functions
        const lifecycleModal = document.getElementById('lifecycle-modal');
        const lifecycleForm = document.getElementById('lifecycle-form');
        const closeLifecycleModal = document.getElementById('close-lifecycle-modal');
        const cancelLifecycle = document.getElementById('cancel-lifecycle');

        let pendingTaskMove = null; // Store pending move data

        function showLifecycleModal(taskId, fromStatus, toStatus, taskElement) {
            const taskTitle = taskElement.querySelector('h3').textContent;
            
            // Store pending move data
            pendingTaskMove = {
                taskId: taskId,
                fromStatus: fromStatus,
                toStatus: toStatus,
                taskElement: taskElement
            };

            // Populate modal
            document.getElementById('lifecycle-task-id').value = taskId;
            document.getElementById('lifecycle-new-column').value = toStatus;
            document.getElementById('lifecycle-task-title').textContent = taskTitle;
            document.getElementById('lifecycle-from-status').textContent = getStatusDisplayName(fromStatus);
            document.getElementById('lifecycle-to-status').textContent = getStatusDisplayName(toStatus);
            
            // Reset form
            lifecycleForm.reset();
            document.getElementById('lifecycle-task-id').value = taskId;
            document.getElementById('lifecycle-new-column').value = toStatus;
            
            // Show modal
            lifecycleModal.classList.remove('hidden');
        }

        function hideLifecycleModal() {
            lifecycleModal.classList.add('hidden');
            lifecycleForm.reset();
            
            // If there's a pending move and user cancels, revert the move
            if (pendingTaskMove) {
                const { taskElement, fromStatus } = pendingTaskMove;
                const originalColumn = document.getElementById(`${fromStatus}-column`);
                originalColumn.appendChild(taskElement);
                updateTaskCounters();
                pendingTaskMove = null;
            }
        }

        function getStatusDisplayName(status) {
            const statusNames = {
                'todo': 'To Do',
                'progress': 'In Progress',
                'review': 'Review',
                'done': 'Done'
            };
            return statusNames[status] || status;
        }

        // Close lifecycle modal event listeners
        closeLifecycleModal.addEventListener('click', hideLifecycleModal);
        cancelLifecycle.addEventListener('click', hideLifecycleModal);

        // Handle lifecycle form submission
        lifecycleForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!pendingTaskMove) return;

            const { taskId, fromStatus, toStatus } = pendingTaskMove;
            
            const lifecycleData = {
                updateType: document.getElementById('lifecycle-update-type').value,
                comments: document.getElementById('lifecycle-comments').value,
                updatedBy: document.getElementById('lifecycle-updated-by').value,
                timestamp: new Date().toISOString(),
                fromStatus: fromStatus,
                toStatus: toStatus
            };

            try {
                // Hide modal first
                lifecycleModal.classList.add('hidden');
                
                // Get existing tasks
                const tasks = await fetchTasks();
                
                // Find and update the task
                const taskIndex = tasks.findIndex(task => task.id === taskId);
                if (taskIndex !== -1) {
                    const task = tasks[taskIndex];
                    
                    // Update task column and timestamp
                    task.column = toStatus;
                    task.updatedAt = lifecycleData.timestamp;
                    
                    // Add lifecycle entry
                    if (!task.lifecycle) {
                        task.lifecycle = [];
                    }
                    
                    const lifecycleEntry = {
                        id: `lc_${Date.now()}`,
                        timestamp: lifecycleData.timestamp,
                        fromStatus: lifecycleData.fromStatus,
                        toStatus: lifecycleData.toStatus,
                        updateType: lifecycleData.updateType,
                        comments: lifecycleData.comments,
                        updatedBy: lifecycleData.updatedBy
                    };
                    
                    task.lifecycle.push(lifecycleEntry);
                    
                    // Save updated tasks
                    await saveTasks(tasks, false);
                    
                    // Update UI
                    updateTaskCounters();
                    updateTableView();
                    
                    // Clear pending move
                    pendingTaskMove = null;
                    
                    showNotification('Success', 'Task status updated successfully', 'notification');
                }
            } catch (error) {
                console.error('Error updating task lifecycle:', error);
                showNotification('Error', 'Error updating task status. Please try again.', 'error');
                
                // Revert the move on error
                if (pendingTaskMove) {
                    const { taskElement, fromStatus } = pendingTaskMove;
                    const originalColumn = document.getElementById(`${fromStatus}-column`);
                    originalColumn.appendChild(taskElement);
                    updateTaskCounters();
                    pendingTaskMove = null;
                }
            }
        });

        // Update task counters initially
        updateTaskCounters();

        // Lifecycle History Functions
        const lifecycleHistoryModal = document.getElementById('lifecycle-history-modal');
        const closeHistoryModal = document.getElementById('close-history-modal');

        closeHistoryModal.addEventListener('click', function() {
            lifecycleHistoryModal.classList.add('hidden');
        });

        // Function to view lifecycle history
        async function viewLifecycleHistory(taskId) {
            try {
                const tasks = await fetchTasks();
                const task = tasks.find(t => t.id === taskId);
                
                if (!task) {
                    showNotification('Error', 'Task not found', 'error');
                    return;
                }

                // Populate modal header
                document.getElementById('history-task-title').textContent = task.title;
                document.getElementById('history-current-status').textContent = getStatusDisplayName(task.column);
                document.getElementById('history-last-updated').textContent = formatDateTime(task.updatedAt);

                // Populate timeline
                const timeline = document.getElementById('lifecycle-timeline');
                timeline.innerHTML = '';

                if (task.lifecycle && task.lifecycle.length > 0) {
                    // Sort lifecycle entries by timestamp (newest first)
                    const sortedLifecycle = [...task.lifecycle].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    
                    // Create timeline container
                    const timelineContainer = document.createElement('ol');
                    timelineContainer.className = 'relative border-s border-gray-200';
                    
                    sortedLifecycle.forEach((entry, index) => {
                        const timelineEntry = createTimelineEntry(entry, index === sortedLifecycle.length - 1);
                        timelineContainer.appendChild(timelineEntry);
                    });
                    
                    timeline.appendChild(timelineContainer);
                } else {
                    timeline.innerHTML = '<p class="text-gray-500 text-center py-4">No lifecycle history available</p>';
                }

                // Show modal
                lifecycleHistoryModal.classList.remove('hidden');
                
                // Hide task menu
                document.getElementById(`menu-${taskId}`).classList.add('hidden');
            } catch (error) {
                console.error('Error loading lifecycle history:', error);
                showNotification('Error', 'Error loading lifecycle history', 'error');
            }
        }

                 function createTimelineEntry(entry, isLast) {
             const li = document.createElement('li');
             li.className = isLast ? 'ms-4' : 'mb-10 ms-4';
             
             const updateTypeColors = {
                 creation: 'bg-blue-500',
                 progress: 'bg-yellow-500',
                 blocker: 'bg-red-500',
                 completion: 'bg-green-500',
                 review: 'bg-purple-500',
                 testing: 'bg-indigo-500',
                 deployment: 'bg-gray-500',
                 other: 'bg-gray-400'
             };

             const color = updateTypeColors[entry.updateType] || updateTypeColors.other;

             // Format the action description
             const actionDescription = entry.fromStatus ? 
                 `moved task from ${getStatusDisplayName(entry.fromStatus)} to ${getStatusDisplayName(entry.toStatus)}` :
                 `created the task`;

             li.innerHTML = `
                 <div class="absolute w-3 h-3 ${color} rounded-full mt-1.5 -start-1.5 border border-white"></div>
                 <time class="mb-1 text-sm font-normal leading-none text-gray-400">${formatDateTime(entry.timestamp)}</time>
                 <h3 class="text-lg font-semibold text-gray-900">
                     ${entry.updatedBy} ${actionDescription}
                 </h3>
                 <div class="mb-2">
                     <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                         ${entry.updateType.charAt(0).toUpperCase() + entry.updateType.slice(1)}
                     </span>
                 </div>
                 <p class="text-base font-normal text-gray-500">${entry.comments}</p>
             `;

             return li;
         }

         function formatDateTime(dateString) {
             if (!dateString) return 'Unknown';
             const date = new Date(dateString);
             return date.toLocaleDateString('en-US', { 
                 year: 'numeric', 
                 month: 'short', 
                 day: 'numeric',
                 hour: '2-digit',
                 minute: '2-digit'
             });
         }

         // Make viewLifecycleHistory globally available
         window.viewLifecycleHistory = viewLifecycleHistory;
    </script>
</body>
</html>
